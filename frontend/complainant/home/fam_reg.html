<!DOCTYPE html>
<html lang="en">
<head>
  <style>
    .warn{display:none;color:#d32f2f;font-size:12px;margin-top:4px}
    .invalid-input{border-color:#d32f2f !important; outline-color:#d32f2f !important}
  </style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/complainants.css">
</head>
<body>
    
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo-section">
        <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
        <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
        </div>
        <nav class="nav-menu">
        <a href="/complainant/home/dashboard.html" class="nav-item active">Home</a>
        <a href="/complainant/complaints/submitted_complaints.html" class="nav-item">Complaints</a>
        </nav>
    </aside>

  <!-- Main -->
  <main class="main">
    <article class="card" role="main" aria-labelledby="page-title">
      <h1 id="page-title" class="page-title">Family of an HOA Member Registration</h1>

      <!-- TOP: registrant basic fields -->
     <form id="famRegForm" method="post" enctype="multipart/form-data">
        <div class="form-grid" aria-hidden="false">
          <label>Last Name
            <input type="text" name="reg_last" id="reg_last">
            <small class="warn" id="warn-reg_last">This field is required.</small>
          </label>
          <label>First Name
            <input type="text" name="reg_first" id="reg_first">
            <small class="warn" id="warn-reg_first">This field is required.</small>
          </label>
          <label>Middle Name<input type="text" name="reg_mid"></label>
          <label>Suffix
            <select name="reg_suffix">
              <option value="" disabled selected hidden></option>
              <option>Sr.</option><option>Jr.</option><option>NA</option>
            </select>
          </label>

          <label>Date of Birth<input type="date" name="reg_dob"></label>
          <label>Sex
            <select name="reg_sex">
              <option value="" disabled selected hidden></option>
              <option>Male</option><option>Female</option>
            </select>
          </label>
          <label>Citizenship
            <input type="text" name="reg_cit" id="reg_cit">
            <small class="warn" id="warn-reg_cit">This field is required.</small>
          </label>
          <label>Age<input type="number" name="reg_age" min="0" step="1"></label>

          <label>Phone Number
            <input type="text" name="reg_phone" id="reg_phone">
            <small class="warn" id="warn-reg_phone">This field is required.</small>
          </label>
          <label>Year of Residence
            <input type="text" name="reg_year" id="reg_year">
            <small class="warn" id="warn-reg_year">This field is required.</small>
          </label>
          <label><!-- empty placeholder to keep 4 cols --></label>
        </div>
        
        <!-- separator -->
        <div class="separator" aria-hidden="true"></div>
        
        <h3>Information of Family Member:</h3><br>

        <div class="form-grid" aria-hidden="false">
          <label>Last Name
            <input type="text" name="parent_last" id="parent_last">
            <small class="warn" id="warn-parent_last">This field is required.</small>
          </label>
          <label>First Name
            <input type="text" name="parent_first" id="parent_first">
            <small class="warn" id="warn-parent_first">This field is required.</small>
          </label>
          <label>Middle Name<input type="text" name="parent_mid"></label>
          <label>Suffix
            <select name="parent_suffix">
              <option value="" disabled selected hidden></option>
              <option>NA</option>
              <option>Sr.</option>
              <option>Jr.</option>
            </select>
          </label>

          <label>Date of Birth<input type="date" name="parent_dob"></label>
          <label>Sex
            <select name="parent_sex">
              <option value="" disabled selected hidden></option>
              <option>Male</option><option>Female</option>
            </select>
          </label>
          <label>Citizenship
            <input type="text" name="parent_cit" id="parent_cit">
            <small class="warn" id="warn-parent_cit">This field is required.</small>
          </label>
          <label>Age<input type="number" name="parent_age" min="0" step="1"></label>
        </div>

        <div class="form-grid" aria-hidden="false" style="margin-bottom: -15px;">
          <label>Years of Residence
            <input type="text" name="parent_year" id="parent_year">
            <small class="warn" id="warn-parent_year">This field is required.</small>
          </label>
          <label>Relationship
            <input type="text" name="reg_relationship" id="reg_relationship">
            <small class="warn" id="warn-reg_relationship">This field is required.</small>
          </label>
          <label>HOA
              <select name="parent_hoa" id="parent_hoa">
              <option value="" disabled selected hidden></option>
              {% for area in areas %}
                <option value="{{ area.area_id }}">{{ area.area_name }}</option>
              {% endfor %}
            </select>
            <small class="warn" id="warn-parent_hoa">This field is required.</small>
          </label>
          <label>Block Assignment
            <input type="text" name="parent_blk" id="parent_blk">
            <small class="warn" id="warn-parent_blk">This field is required.</small>
          </label>
          <label>Lot Assignment
            <input type="text" name="parent_lot_asn" id="parent_lot_asn">
            <small class="warn" id="warn-parent_lot_asn">This field is required.</small>
          </label>
          <label>Lot Size
            <input type="text" name="parent_lot_size" id="parent_lot_size">
            <small class="warn" id="warn-parent_lot_size">This field is required.</small>
          </label>

          <!-- Civil status column (right) -->
          <aside class="civil-status">
            <div class="label">Civil Status:</div>
              <div class="civil-grid">
                <label><input type="radio" name="fam_civil" value="single"> Single</label>
                <label><input type="radio" name="fam_civil" value="widowed"> Widowed</label>
                <label><input type="radio" name="fam_civil" value="married"> Married</label>
                <label><input type="radio" name="fam_civil" value="separated"> Separated</label>
                <label><input type="radio" name="fam_civil" value="divorced"> Divorced</label>
                <label><input type="radio" name="fam_civil" value="annulled"> Annulled</label>
              </div>
          </aside>
        </div>

        <div class="form-grid" aria-hidden="false" style="grid-template-columns: repeat(2, 1fr) !important;">
          <label>Current Address
            <input type="text" name="reg_cur_add" id="reg_cur_add">
            <small class="warn" id="warn-reg_cur_add">This field is required.</small>
          </label>
        </div>

        <!-- radio question (one option per row) -->
        <div class="radio-section" role="group">
          <p id="recipient-label">Is he/she a recipient of other housing programs besides NGCCHP ?</p>
          <div class="radio-list">
            <label><input type="radio" name="recipient" value="yes"> Yes</label>
            <label><input type="radio" name="recipient" value="no"> No</label>
          </div>
          <small class="warn" id="warn-recipient">Please select Yes or No.</small>
        </div>

        <!-- supporting documents (stacked) -->
        <div class="support-docs" role="group">
          <p id="docs-label">What supporting documents does your family member have?</p>
          <div class="docs-list">
            <label><input type="checkbox" name="doc_title"> Title</label>
            <label><input type="checkbox" name="doc_contract"> Contract to Sell</label>
            <label><input type="checkbox" name="doc_fullpay"> Certificate of Full Payment</label>
            <label><input type="checkbox" name="doc_award"> Certificate of Award</label>
            <label><input type="checkbox" name="doc_agreement"> Contract/Agreement</label>
            <label><input type="checkbox" name="doc_deed"> Deed of Sale</label>
          </div>
          <small class="warn" id="warn-docs">Select at least one option.</small>
        </div>
          
          <!-- Hidden category input -->
          <input type="hidden" name="category" value="fam_member">

        <!-- actions -->
        <div class="actions">
          <button type="button" class="btn cancel" onclick="window.location.href='/complainant/home/not_registered.html'">Cancel</button>
          <button type="submit" class="btn submit">Submit</button>
        </div>

        <div id="errorPop" 
          style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);z-index:999;background:#e3f2fd;color:#083048;width:max-content;padding:16px 28px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.12);font-weight:500;min-width:220px;max-width:340px;transition:opacity .2s;">
          <span id="errorPopMsg"></span>
        </div>

      </form>
    </article>
  </main>
</body>
</html>

  <!-- Form submission script -->
  <script>
    // Inline field warning helpers
    function showFieldWarn(id, inputEl){
      const w = document.getElementById(id);
      if (w) w.style.display = 'block';
      if (inputEl) inputEl.classList.add('invalid-input');
    }
    function hideFieldWarn(id, inputEl){
      const w = document.getElementById(id);
      if (w) w.style.display = 'none';
      if (inputEl) inputEl.classList.remove('invalid-input');
    }

    // Clear warn on input/change
    ["reg_last","reg_first","reg_cit","reg_phone","reg_year","parent_last","parent_first","parent_cit","parent_year","reg_relationship","parent_hoa","parent_blk","parent_lot_asn","parent_lot_size","reg_cur_add"].forEach(id=>{
      const el = document.getElementById(id);
      if (el){ el.addEventListener('input', ()=> hideFieldWarn('warn-'+id, el)); }
    });
    document.querySelectorAll('input[name="recipient"]').forEach(r=>{
      r.addEventListener('change', ()=> hideFieldWarn('warn-recipient'));
    });
    document.querySelectorAll('input[name^="doc_"]').forEach(c=>{
      c.addEventListener('change', ()=> hideFieldWarn('warn-docs'));
    });
    function showErrorPop(msg) {
      const pop = document.getElementById('errorPop');
      const popMsg = document.getElementById('errorPopMsg');
      popMsg.textContent = msg;
      pop.style.display = 'block';
      pop.style.opacity = '1';
      setTimeout(() => {
        pop.style.opacity = '0';
        setTimeout(() => { pop.style.display = 'none'; }, 400);
      }, 1000);
    }

    document.getElementById("famRegForm").addEventListener("submit", async function(e) {
      e.preventDefault(); // stop page reload

      const submitBtn = this.querySelector('.btn.submit');
      if (submitBtn.disabled) {
        console.log('Submission blocked: already submitting');
        return;
      }
      submitBtn.disabled = true;

      // Client-side required validation
      let firstInvalid = null;
      function requireVal(selector, warnId){
        const el = document.querySelector(selector);
        const ok = el && String(el.value || '').trim() !== '';
        if (!ok){
          showFieldWarn(warnId, el);
          if (!firstInvalid) firstInvalid = el;
        } else {
          hideFieldWarn(warnId, el);
        }
        return ok;
      }

      // Registrant required fields
      const v1 = requireVal('#reg_last','warn-reg_last');
      const v2 = requireVal('#reg_first','warn-reg_first');
      const v3 = requireVal('#reg_cit','warn-reg_cit');
      const v4 = requireVal('#reg_phone','warn-reg_phone');
      const v5 = requireVal('#reg_year','warn-reg_year');
      // Family member required fields
      const v6 = requireVal('#parent_last','warn-parent_last');
      const v7 = requireVal('#parent_first','warn-parent_first');
      const v8 = requireVal('#parent_cit','warn-parent_cit');
      const v9 = requireVal('#parent_year','warn-parent_year');
      const v10 = requireVal('#reg_relationship','warn-reg_relationship');
      const v11 = requireVal('#parent_hoa','warn-parent_hoa');
      const v12 = requireVal('#parent_blk','warn-parent_blk');
      const v13 = requireVal('#parent_lot_asn','warn-parent_lot_asn');
      const v14 = requireVal('#parent_lot_size','warn-parent_lot_size');
      const v15 = requireVal('#reg_cur_add','warn-reg_cur_add');

      // Recipient required (radio)
      const recipientChecked = document.querySelector('input[name="recipient"]:checked');
      if (!recipientChecked){
        showFieldWarn('warn-recipient');
        if (!firstInvalid) firstInvalid = document.querySelector('input[name="recipient"]');
      } else hideFieldWarn('warn-recipient');

      // Supporting docs required (at least one checkbox)
      const docsChecked = Array.from(document.querySelectorAll('input[name^="doc_"]')).filter(x => x.type === 'checkbox' && x.checked);
      if (docsChecked.length === 0){
        showFieldWarn('warn-docs');
        if (!firstInvalid) firstInvalid = document.querySelector('input[name="doc_title"]');
      } else hideFieldWarn('warn-docs');

      const allOk = v1 && v2 && v3 && v4 && v5 && v6 && v7 && v8 && v9 && v10 && v11 && v12 && v13 && v14 && v15 && !!recipientChecked && docsChecked.length > 0;
      if (!allOk){
        showErrorPop('Please complete the required fields.');
        if (firstInvalid){
          try{ firstInvalid.focus(); firstInvalid.scrollIntoView({behavior:'smooth', block:'center'}); }catch(_){}
        }
        submitBtn.disabled = false;
        return;
      }

      let formData = new FormData(this);

      try {
        let response = await fetch("/complainant/famreg", {
          method: "POST",
          body: formData,
          credentials: "same-origin"
        });

        // Try to parse JSON, if fails, show error
        let result;
        try {
          result = await response.json();
        } catch (err) {
          showErrorPop("Server error: Invalid response");
          submitBtn.disabled = false;
          return;
        }

        if (result.success) {
          showErrorPop(result.message || "Registration successful!");

          // Wait a moment for the popup to show, then redirect
          setTimeout(() => {
            // ✅ Use the same key as in dashboard.html
            let complaintType = sessionStorage.getItem("complaintType");
            console.log("Complaint Type from sessionStorage:", complaintType);

            if (complaintType === "Overlapping") {
              window.location.href = "/complainant/overlapping/new_overlap_form";
            } else if (complaintType === "Lot Dispute") {
              window.location.href = "/complainant/new_lot_dispute_form";
            } else if (complaintType === "Boundary Dispute") {
              window.location.href = "/complainant/new_boundary_dispute_form";
            } else if (complaintType === "Pathway Dispute") {
              window.location.href = "/complainant/complaints/pathway_dispute.html";
            } else if (complaintType === "Unauthorized Occupation") {
              window.location.href = "/complainant/complaints/unauthorized_occupation.html";
            } else if (complaintType === "Illegal Construction") {
              window.location.href = "/complainant/complaints/illegal_construction.html";
            } else {
              window.location.href = "/complainant/complaints/general.html";
            }
          }, 1500);

        } else {
          showErrorPop(result.error || "Unknown error occurred.");
          submitBtn.disabled = false;
        }
      } catch (err) {
        showErrorPop("Failed to submit: " + err);
        submitBtn.disabled = false;
      }
    });
  </script>
</script>