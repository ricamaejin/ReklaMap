<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/complainants.css">
  <style>
    .readonly-preview input[readonly],
    .readonly-preview input[disabled],
    .readonly-preview textarea[readonly],
    .readonly-preview textarea[disabled],
    .readonly-preview select[disabled],
    .readonly-preview select[readonly] {
      background: #f3f3f3 !important;
      color: #888 !important;
      border-color: #d3d3d3 !important;
      cursor: not-allowed;
      opacity: 1 !important;
    }
    .readonly-preview .readonly-value {
      background: #f3f3f3;
      color: #888;
      border-radius: 4px;
      padding: 4px 8px;
      display: inline-block;
    }
    
    /* Multiple text containers styling */
    .multiple-text-container {
      margin-left: 15px;
    }
    .multiple-text-item {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .multiple-text-item input {
      flex: 1;
      width: 100%;
      background: #f3f3f3;
      color: #888;
      border-color: #d3d3d3;
      cursor: not-allowed;
    }
    
    /* Q9 document styling */
    .q9-docs-container {
      margin-left: 20px;
      margin-top: 10px;
    }
    .q9-docs-options {
      margin-left: 15px;
    }
    .doc-option {
      display: block;
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <a href="/complainant/home/dashboard.html" class="nav-item">Home</a>
      <a href="/complainant/complaints/submitted_complaints.html" class="nav-item active">Complaints</a>
    </nav>
  </aside>


  <!-- Main Content -->
  <div class="main">
    <div class="form-container">
  <h2 id="invalidText" class="invalid-header">Invalid Complaint</h2>
  <h1 class="underlined-title">COMPLAINT FORM <br> {{ complaint.type_of_complaint|upper }}</h1>
      <div class="instructions">
        <p><strong>INSTRUCTION</strong></p>
        <ul>
          <li>Complete the application form properly and legibly.</li>
          <li>For checkbox items (☑), you may select more than one option if applicable.</li>
          <li>For radio button items (◉), please select only one option.</li>
          <li>If a field or question does not apply to you or you do not know the answer, write “N/A” (Not Applicable).</li>
          <li>Ensure all required fields are filled before submitting the form.</li>
        </ul>
      </div>

  <form class="readonly-preview">
        <input type="hidden" name="complaint_id" value="{{ complaint.complaint_id }}">
        <input type="hidden" name="registration_id" value="{{ registration.registration_id }}">

        <div class="section-header">COMPLAINANT'S DETAILS:</div>

        {# Unified conditional structure: family_of_member | non_member | hoa_member #}
        {% if registration.category == 'family_of_member' %}
          <!-- Family member layout -->
          <div class="pairs">
            <div class="pair-row">
              <div class="col">
                <label class="small">Full Name:</label>
                {% set mi = (registration.middle_name or '')|string %}
                {% set mi_clean = mi.strip() %}
                {% if mi_clean and mi_clean|length == 1 %}
                  {% set mi_clean = mi_clean ~ '.' %}
                {% elif mi_clean and mi_clean|length > 1 and mi_clean.endswith('.') == false and mi_clean|length <= 3 %}
                  {% set mi_clean = mi_clean[0] ~ '.' %}
                {% endif %}
                {% set full_name_display = (
                  (registration.first_name or '') ~ ' ' ~
                  (mi_clean or '') ~ ( ' ' if mi_clean ) ~
                  (registration.last_name or '') ~ ( ' ' if registration.suffix ) ~
                  (registration.suffix or '')
                ) %}
                <input type="text" name="full_name" value="{{ full_name_display.strip() }}" readonly title="Full Name" aria-label="Full Name">
              </div>
            </div>
            
            <div class="pair-row">
              <div class="col">
                <label class="small">Date of Birth:</label>
                <input type="date" name="date_of_birth" value="{{ registration.date_of_birth }}" readonly title="Date of Birth" aria-label="Date of Birth">
              </div>
              <div class="col">
                <label class="small">Sex:</label>
                <input type="text" name="sex" value="{{ registration.sex }}" readonly title="Sex" aria-label="Sex">
              </div>
            </div>
            
            <div class="pair-row">
              <div class="col">
                <label class="small">Citizenship:</label>
                <input type="text" name="citizenship" value="{{ registration.citizenship }}" readonly title="Citizenship" aria-label="Citizenship">
              </div>
              <div class="col">
                <label class="small">Age:</label>
                <input type="text" name="age" value="{{ registration.age }}" readonly title="Age" aria-label="Age">
              </div>
            </div>
            
            <div class="pair-row">
              <div class="col">
                <label class="small">Phone Number:</label>
                <input type="text" name="phone_number" value="{{ registration.phone_number }}" readonly title="Phone Number" aria-label="Phone Number">
              </div>
              <div class="col">
                <label class="small">Year of Residence:</label>
                <input type="text" name="year_of_residence" value="{{ registration.year_of_residence }}" readonly title="Year of Residence" aria-label="Year of Residence">
              </div>
            </div>
            
            <div class="pair-row">
              <div class="col">
                <label class="small">Relationship:</label>
                <input type="text" name="relationship" value="{{ relationship or '' }}" readonly title="Relationship" aria-label="Relationship">
              </div>
              <div class="col">
                <label class="small">Current Address:</label>
                <input type="text" name="cur_add" value="{{ registration.current_address }}" readonly title="Current Address" aria-label="Current Address">
              </div>
            </div>
            
            {# Removed supporting documents from personal section; will show in HOA Member Information below #}
          </div>
          
          {% if parent_info %}
          <div class="mt-20">
            <div class="section-header">HOA MEMBER INFORMATION</div>
            <div class="pairs">
              <div class="pair-row">
                <div class="col">
                  <label class="small">Full Name:</label>
                  {% set p_full = (parent_info.full_name or '')|string %}
                  {% set tokens = p_full.split(' ') %}
                  {% set norm_tokens = [] %}
                  {% for t in tokens %}
                    {% set tt = t.strip() %}
                    {% if tt|length == 1 %}
                      {% set _ = norm_tokens.append(tt ~ '.') %}
                    {% elif tt|length > 1 and tt|replace('.', '')|length == 1 %}
                      {% set _ = norm_tokens.append(tt[0] ~ '.') %}
                    {% else %}
                      {% set _ = norm_tokens.append(tt) %}
                    {% endif %}
                  {% endfor %}
                  {% set parent_full_name_display = ' '.join(norm_tokens) %}
                  <input type="text" name="parent_full_name" value="{{ parent_full_name_display.strip() }}" readonly title="Full Name" aria-label="Parent Full Name">
                </div>
              </div>
              <div class="pair-row">
                <div class="col">
                  <label class="small">Date of Birth:</label>
                  <input type="date" name="parent_date_of_birth" value="{{ parent_info.date_of_birth }}" readonly title="Date of Birth" aria-label="Parent Date of Birth">
                </div>
                <div class="col">
                  <label class="small">Sex:</label>
                  <input type="text" name="parent_sex" value="{{ parent_info.sex or '' }}" readonly title="Sex" aria-label="Parent Sex">
                </div>
              </div>
              <div class="pair-row">
                <div class="col">
                  <label class="small">Citizenship:</label>
                  <input type="text" name="parent_citizenship" value="{{ parent_info.citizenship or '' }}" readonly title="Citizenship" aria-label="Parent Citizenship">
                </div>
                <div class="col">
                  <label class="small">Age:</label>
                  <input type="text" name="parent_age" value="{{ parent_info.age or '' }}" readonly title="Age" aria-label="Parent Age">
                </div>
              </div>
              
              <div class="pair-row">
                <div class="col">
                  <label class="small">Year of Residence:</label>
                  <input type="text" name="parent_year_of_residence" value="{{ parent_info.year_of_residence or '' }}" readonly title="Year of Residence" aria-label="Parent Year of Residence">
                </div>
              </div>
              
              <div class="pair-row">
                <div class="col">
                  <label class="small">HOA:</label>
                  <input type="text" name="hoa" value="{{ parent_info.hoa or '' }}" readonly title="HOA" aria-label="HOA">
                </div>
              </div>
              <div class="pair-row">
                <div class="col">
                  <label class="small">Current Address:</label>
                  <input type="text" name="parent_current_address" value="{{ parent_info.current_address or '' }}" readonly title="Current Address" aria-label="Parent Current Address">
                </div>
              </div>
              
              <div class="pair-row">
                <div class="col">
                  <label class="small">Block Assignment:</label>
                  <input type="text" name="blk_num" value="{{ parent_info.block_no }}" readonly title="Block Assignment" aria-label="Block Assignment">
                </div>
                <div class="col">
                  <label class="small">Lot Assignment:</label>
                  <input type="text" name="lot_num" value="{{ parent_info.lot_no }}" readonly title="Lot Assignment" aria-label="Lot Assignment">
                </div>
                <div class="col">
                  <label class="small">Lot Size:</label>
                  <input type="text" name="lot_size" value="{{ parent_info.lot_size }}" readonly title="Lot Size" aria-label="Lot Size">
                </div>
              </div>
              
              <div class="pair-row">
                <div class="col">
                  <label class="small">Civil Status:</label>
                  <input type="text" name="civil_status" value="{{ parent_info.civil_status }}" readonly title="Civil Status" aria-label="Civil Status">
                </div>
                <div class="col">
                  <label class="small">Recipient of Other Housing:</label>
                  <input type="text" name="recipient_of_other_housing" value="{{ parent_info.recipient_of_other_housing }}" readonly title="Recipient of Other Housing" aria-label="Recipient of Other Housing">
                </div>
              </div>
              
              <!-- Supporting documents for parent member (grid, canonical keys), placed after Civil Status and Recipient -->
              <div class="pair-row">
                <div class="col">
                  <label class="small">What Supporting Documents does your Family Member have?</label>
                  {% set doc_options = [
                    ('title', 'Title'),
                    ('contract_to_sell', 'Contract to Sell'),
                    ('certificate_of_full_payment', 'Certificate of Full Payment'),
                    ('pre_qualification_stub', 'Pre-qualification Stub'),
                    ('contract_agreement', 'Contract/Agreement'),
                    ('deed_of_sale', 'Deed of Sale')
                  ] %}
                  {% set selected_docs = parent_info.supporting_documents or {} %}
                  <div class="checkbox-group" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:6px 16px;">
                    {% for val, label in doc_options %}
                      {% set is_checked = false %}
                      {% if selected_docs is mapping and val in selected_docs %}
                        {% set is_checked = selected_docs[val] %}
                      {% endif %}
                      <label style="white-space:nowrap;"><input type="checkbox" disabled {% if is_checked %}checked{% endif %}> {{ label }}</label>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

        {% elif registration.category == 'non_member' %}
          <!-- Non-member layout: two-column grouping like lot_dispute.html -->
          <div class="pairs">
            <div class="pair-row">
              <div class="col">
                <label class="small">Full Name:</label>
                {% set mi = (registration.middle_name or '')|string %}
                {% set mi_clean = mi.strip() %}
                {% if mi_clean and mi_clean|length == 1 %}
                  {% set mi_clean = mi_clean ~ '.' %}
                {% elif mi_clean and mi_clean|length > 1 and mi_clean.endswith('.') == false and mi_clean|length <= 3 %}
                  {% set mi_clean = mi_clean[0] ~ '.' %}
                {% endif %}
                {% set full_name_display = ((registration.first_name or '') ~ ' ' ~ (mi_clean or '') ~ ( ' ' if mi_clean ) ~ (registration.last_name or '') ~ ( ' ' if registration.suffix ) ~ (registration.suffix or '')) %}
                <input type="text" name="full_name" value="{{ full_name_display.strip() }}" readonly title="Full Name" aria-label="Full Name">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">Date of Birth:</label>
                <input type="date" name="date_of_birth" value="{{ registration.date_of_birth }}" readonly title="Date of Birth" aria-label="Date of Birth">
              </div>
              <div class="col">
                <label class="small">Sex:</label>
                <input type="text" name="sex" value="{{ registration.sex }}" readonly title="Sex" aria-label="Sex">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">Citizenship:</label>
                <input type="text" name="citizenship" value="{{ registration.citizenship }}" readonly title="Citizenship" aria-label="Citizenship">
              </div>
              <div class="col">
                <label class="small">Age:</label>
                <input type="text" name="age" value="{{ registration.age }}" readonly title="Age" aria-label="Age">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">Phone Number:</label>
                <input type="text" name="phone_number" value="{{ registration.phone_number }}" readonly title="Phone Number" aria-label="Phone Number">
              </div>
              <div class="col">
                <label class="small">Year of Residence:</label>
                <input type="text" name="year_of_residence" value="{{ registration.year_of_residence }}" readonly title="Year of Residence" aria-label="Year of Residence">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">Civil Status:</label>
                <input type="text" name="civil_status" value="{{ registration.civil_status }}" readonly title="Civil Status" aria-label="Civil Status">
              </div>
              <div class="col">
                <label class="small">Recipient of Other Housing:</label>
                <input type="text" name="recipient_of_other_housing" value="{{ registration.recipient_of_other_housing }}" readonly title="Recipient of other housing programs" aria-label="Recipient of other housing programs">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">Current Address:</label>
                <input type="text" name="cur_add" value="{{ registration.current_address }}" readonly title="Current Address" aria-label="Current Address">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">Area (HOA):</label>
                <input type="text" name="hoa" value="{{ get_area_name(registration.hoa) if registration.hoa else '' }}" readonly title="Area (HOA)" aria-label="Area (HOA)">
              </div>
            </div>
          </div>

        {% else %}
          <!-- HOA member layout (original layout with lot information) -->
          <div class="pairs">
            <div class="pair-row">
              <div class="col">
                <label class="small">Full Name:</label>
                {% set mi = (registration.middle_name or '')|string %}
                {% set mi_clean = mi.strip() %}
                {% if mi_clean and mi_clean|length == 1 %}
                  {% set mi_clean = mi_clean ~ '.' %}
                {% elif mi_clean and mi_clean|length > 1 and mi_clean.endswith('.') == false and mi_clean|length <= 3 %}
                  {% set mi_clean = mi_clean[0] ~ '.' %}
                {% endif %}
                {% set full_name_display = (
                  (registration.first_name or '') ~ ' ' ~
                  (mi_clean or '') ~ ( ' ' if mi_clean ) ~
                  (registration.last_name or '') ~ ( ' ' if registration.suffix ) ~
                  (registration.suffix or '')
                ) %}
                <input type="text" name="full_name" value="{{ full_name_display.strip() }}" readonly title="Full Name" aria-label="Full Name">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">Date of Birth:</label>
                <input type="date" name="date_of_birth" value="{{ registration.date_of_birth }}" readonly title="Date of Birth" aria-label="Date of Birth">
              </div>
              <div class="col">
                <label class="small">Sex:</label>
                <input type="text" name="sex" value="{{ registration.sex }}" readonly title="Sex" aria-label="Sex">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">Citizenship:</label>
                <input type="text" name="citizenship" value="{{ registration.citizenship }}" readonly title="Citizenship" aria-label="Citizenship">
              </div>
              <div class="col">
                <label class="small">Age:</label>
                <input type="text" name="age" value="{{ registration.age }}" readonly title="Age" aria-label="Age">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">Phone Number:</label>
                <input type="text" name="phone_number" value="{{ registration.phone_number }}" readonly title="Phone Number" aria-label="Phone Number">
              </div>
              <div class="col">
                <label class="small">Year of Residence:</label>
                <input type="text" name="year_of_residence" value="{{ registration.year_of_residence }}" readonly title="Year of Residence" aria-label="Year of Residence">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">Current Address:</label>
                <input type="text" name="cur_add" value="{{ registration.current_address }}" readonly title="Current Address" aria-label="Current Address">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">HOA:</label>
                <input type="text" name="hoa" value="{{ get_area_name(registration.hoa) if registration.hoa else '' }}" readonly title="HOA" aria-label="HOA">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">Block Assignment:</label>
                <input type="text" name="blk_num" value="{{ registration.block_no }}" readonly title="Block Assignment" aria-label="Block Assignment">
              </div>
              <div class="col">
                <label class="small">Lot Assignment:</label>
                <input type="text" name="lot_num" value="{{ registration.lot_no }}" readonly title="Lot Assignment" aria-label="Lot Assignment">
              </div>
              <div class="col">
                <label class="small">Lot Size:</label>
                <input type="text" name="lot_size" value="{{ registration.lot_size }}" readonly title="Lot Size" aria-label="Lot Size">
              </div>
            </div>
            <div class="pair-row">
              <div class="col">
                <label class="small">Civil Status:</label>
                <input type="text" name="civil_status" value="{{ registration.civil_status }}" readonly title="Civil Status" aria-label="Civil Status">
              </div>
              <div class="col">
                <label class="small">Recipient of Other Housing:</label>
                <input type="text" name="recipient_of_other_housing" value="{{ registration.recipient_of_other_housing }}" readonly title="Recipient of other housing programs" aria-label="Recipient of other housing programs">
              </div>
            </div>
            {% set show_supporting_docs = registration.category in ['hoa_member', 'family_of_member'] %}
            {% if show_supporting_docs %}
              <div class="pair-row" style="margin-top:18px; margin-bottom:8px;">
                <div class="col" style="flex:1 1 100%;">
                  {% set labelText = 'What Supporting Documents do you have?' %}
                  {% if registration.category == 'family_of_member' %}
                    {% set labelText = 'What Supporting Documents does your Family Member have?' %}
                  {% endif %}
                  <label style="font-weight:600; display:block; margin-bottom:2px;">{{ labelText }}</label>
                  {% set doc_options = [
                    ('title', 'Title'),
                    ('contract_to_sell', 'Contract to Sell'),
                    ('certificate_of_full_payment', 'Certificate of Full Payment'),
                    ('pre_qualification_stub', 'Pre-qualification Stub'),
                    ('contract_agreement', 'Contract/Agreement'),
                    ('deed_of_sale', 'Deed of Sale')
                  ] %}
                  {% set selected_docs = registration.supporting_documents or {} %}
                  <div class="checkbox-group" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:6px 16px;">
                    {% for val, label in doc_options %}
                      {% set is_checked = false %}
                      {% if selected_docs is mapping and val in selected_docs %}
                        {% set is_checked = selected_docs[val] %}
                      {% endif %}
                      <label style="white-space:nowrap;">
                        <input type="checkbox" disabled {% if is_checked %}checked{% endif %}> {{ label }}
                      </label>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}

        <div class="section-header">LOT DETAILS AND CLAIM:</div>

        {% if complaint.type_of_complaint == 'Boundary Dispute' %}
          {% include 'complaint_details_boundary.html' %}
        {% elif complaint.type_of_complaint == 'Lot Dispute' %}
          {% include 'complaint_details_lot_dispute.html' %}
        {% else %}
          {% for field in form_structure %}
            {% if field.type == 'textarea' %}
              <p><strong>{{ field.label }}</strong></p>
              <textarea readonly title="{{ field.label }}" aria-label="{{ field.label }}">{{ answers[field.name] }}</textarea>
            {% elif field.type != 'signature' %}
              {# Generic field rendering for all other non-signature types #}
              <p><strong>{{ field.label }}</strong></p>
              <input type="text" value="{{ answers[field.name] }}" readonly title="{{ field.label }}" aria-label="{{ field.label }}">
            {% endif %}
          {% endfor %}
        {% endif %}

        <!-- Consent Declaration (always before signature) -->
        <div class="section-header">COMPLAINANT’S CONSENT AND DECLARATION</div>
        <div class="consent">
          By submitting this complaint form, I hereby consent to the collection and processing of my personal information as necessary to address the issues raised regarding the lot in question. I confirm that the information provided is accurate and complete to the best of my knowledge. I understand that any false or incomplete information may affect the handling of my complaint, and I acknowledge that my personal details will be processed in compliance with the Privacy Act and other applicable laws.
        </div>

        <!-- Signature Section (always last) -->
        <div class="signature">
          {% if complaint.type_of_complaint == 'Boundary Dispute' %}
            {% if answers.signature_path %}
              <a href="{{ url_for('complainant.uploaded_signature', filename=answers.signature_path) }}" target="_blank">View Signature</a>
            {% else %}
              <p><em>No signature uploaded</em></p>
            {% endif %}
          {% else %}
            {% if answers.signature %}
              <a href="{{ url_for('complainant.uploaded_signature', filename=answers.signature) }}" target="_blank">View Signature</a>
            {% else %}
              <p><em>No signature uploaded</em></p>
            {% endif %}
          {% endif %}
        </div>

      </form>
      <!-- Submit Another Complaint (shown only if user can add) -->
      <div class="signature">
        <button id="submitAnotherBtn" class="add-btn hidden" type="button">Submit Another Complaint</button>
      </div>
    </div>
  </div>

  <!-- Complaint Status Popup -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Complaint Status</h2>
        <div id="datetime">
          <div id="date"></div>
          <div id="time"></div>
        </div>
      </div>
      <hr>
  <!-- Status Description -->
  <textarea aria-label="Invalid complaint reason" readonly>Invalid Complaint
{% if complaint.rejection_reason %}
Reason: {{ complaint.rejection_reason }}
{% else %}
Reason: The name and/or block/lot do not match any registered beneficiary.
{% endif %}
</textarea>
      <div class="modal-footer">
        <button class="btn-close" onclick="closeComplaint()">Close</button>
      </div>
    </div>
  </div>

  <script>
  const modalOverlay = document.getElementById("modal");
  const invalidText = document.getElementById("invalidText");

  // Show popup immediately on page load
  window.addEventListener('DOMContentLoaded', () => {
    modalOverlay.style.display = "flex";
    updateDateTime();
    
    // Prevent timeline 500 error by intercepting timeline functions
    // This is only needed for invalid complaints that don't have a timeline
    if (window.loadComplainantTimeline) {
      console.log("[COMPLAINANT TIMELINE] Disabled timeline for invalid complaint");
      window.loadComplainantTimeline = function() {
        console.log("[COMPLAINANT TIMELINE] Timeline loading skipped for invalid complaint");
        return;
      };
    }
  });

  // Make 'Invalid Complaint' text clickable to reopen popup
  invalidText.onclick = () => {
    modalOverlay.style.display = "flex";
    updateDateTime();
  };

  function closeComplaint() {
    modalOverlay.style.display = "none";
  }

  window.onclick = (event) => {
    if (event.target === modalOverlay) {
      closeComplaint();
    }
  };

  function updateDateTime() {
    const now = new Date();
    const date = now.toLocaleDateString("en-US", {
      weekday: "long",
      year: "numeric",
      month: "long",
      day: "numeric"
    });
    const time = now.toLocaleTimeString("en-US", {
      hour: "2-digit",
      minute: "2-digit",
    });

    document.getElementById("date").textContent = date;
    document.getElementById("time").textContent = time;
  }
  </script>

  <!-- Add Complaint Modal (same functionality as dashboard) -->
  <div class="modal-overlay" id="addComplaintModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Action</h2>
        <div id="addComplaintDatetime"></div>
      </div>
      <hr>
      <div class="modal-body-scroll">
        <label for="addComplaintType">Type of Complaint:</label>
        <select id="addComplaintType" onchange="updateAddComplaintDesc()">
          <option value="" disabled selected hidden>Select Type of Complaint</option>
          <!-- Overlapping option removed -->
          <option value="Lot Dispute">Lot Dispute</option>
          <option value="Boundary Dispute">Boundary Dispute</option>
          <option value="Pathway Dispute">Pathway Dipute</option>
          <option value="Unauthorized Occupation">Unauthorized Occupation</option>
          <option value="Illegal Construction">Illegal Construction</option>
        </select>

        <!-- Complaint Description -->
        <div class="complaint-desc ml-15 hidden" id="addComplaintDesc">
          <h3 id="addComplaintDescTitle"></h3>
          <p id="addComplaintDescText"></p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeAddComplaint()">Cancel</button>
        <button class="btn-save" onclick="goToRegistrationFromInvalid()">Select</button>
      </div>
    </div>
  </div>

  <script>
    // descriptions copied from dashboard
    const addComplaintDescriptions = {
  /* Overlapping description removed */
      "Lot Dispute": "Refers to situations where there is a conflict involving the lot officially assigned to you. This may include cases where someone else is claiming, occupying, or using your lot; where your name does not appear on the beneficiary list; or where there are errors, overlapping claims, or internal family disputes about who has rightful use or ownership of the lot.\n\nTumutukoy ito sa mga sitwasyon kung saan may alitan o hindi pagkakaunawaan tungkol sa lote na opisyal na naitalaga sa iyo. Kabilang dito ang mga kaso kung saan may ibang taong umaangkin, gumagamit, o nakatira sa iyong lote; kapag hindi nakalista ang iyong pangalan sa talaan ng mga benepisyaryo; o kapag may pagkakamali sa dokumento, magkapatong na pag-aangkin, o alitang pampamilya tungkol sa kung sino ang may karapatang gumamit o magmay-ari ng lote.",
      "Boundary Dispute": "A disagreement between neighboring landowners regarding the exact location of property lines or boundaries, often caused by inaccurate surveys, unclear titles, or encroachments.\n\nHindi pagkakaunawaan sa pagitan ng magkatabing may-ari ng lupa tungkol sa tiyak na lokasyon ng hangganan ng ari-arian, na madalas na dulot ng maling survey, hindi malinaw na titulo, o paglabag sa hangganan.",
      "Pathway Dispute": "Refers to conflicts that arise when residents or neighbors disagree over the use, access, or ownership of a pathway. These disputes typically involve blocked passageways, claims of private vs. public access, or disagreements over shared right-of-way.\n\nTumutukoy sa mga alitan na nagaganap kapag hindi nagkakasundo ang mga residente o kapitbahay sa paggamit, pag-access, o pagmamay-ari ng isang daanan. Karaniwan itong kaugnay ng mga hinarang na daanan, pagtatalo kung pribado o pampubliko ang access, o hindi pagkakasundo sa karapatang gamitin ang daanan.",
      "Unauthorized Occupation": "Refers to cases where a person is living in, using, or constructing on a lot without legal authority or official assignment. This includes individuals who are not listed as beneficiaries, do not hold valid documents, or have occupied the property without permission from the rightful owner or approval from government housing authorities.\n\nTumutukoy ito sa mga kaso kung saan may taong naninirahan, gumagamit, o nagtatayo sa isang lote nang walang legal na pahintulot o opisyal na pagkakatalaga. Kasama rito ang mga indibidwal na hindi nakalista bilang benepisyaryo, walang wastong dokumento, o sumakop sa lupa nang walang pahintulot mula sa tunay na may-ari o awtorisasyon mula sa ahensyang nangangasiwa sa pabahay ng pamahalaan.",
      "Illegal Construction": "Occurs when a person illegally occupies or builds structures on land that belongs to another individual or the government without proper authorization.\n\nNangyayari kapag ang isang tao ay iligal na sumakop o nagtayo ng mga istruktura sa lupang pagmamay-ari ng ibang tao o ng pamahalaan nang walang tamang pahintulot."
    };

    (function(){
      const modal = document.getElementById('addComplaintModal');
      const dateEl = document.getElementById('addComplaintDatetime');
      const select = document.getElementById('addComplaintType');
      const descWrap = document.getElementById('addComplaintDesc');
      const descTitle = document.getElementById('addComplaintDescTitle');
      const descText = document.getElementById('addComplaintDescText');
      const submitAnotherBtn = document.getElementById('submitAnotherBtn');
      let interval = null;

      function updateDateTime() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute:'2-digit', hour12: true });
        dateEl.innerHTML = `${dateStr}<br>${timeStr}`;
      }

      window.openAddComplaint = function(){
        if (!modal) return;
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
        updateDateTime();
        if (!interval) interval = setInterval(updateDateTime, 1000);
        if (select) {
          select.value = "";
          descWrap.style.display = 'none';
        }
      }
      window.closeAddComplaint = function(){
        if (!modal) return;
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        if (interval) { clearInterval(interval); interval = null; }
      }
      window.updateAddComplaintDesc = function(){
        const type = (select && select.value) ? select.value : '';
        if (type && addComplaintDescriptions[type]) {
          descTitle.textContent = type;
          descText.textContent = addComplaintDescriptions[type];
          descWrap.style.display = 'block';
        } else {
          descWrap.style.display = 'none';
          descTitle.textContent = '';
          descText.textContent = '';
        }
      }

      // Button click
      if (submitAnotherBtn) {
        submitAnotherBtn.addEventListener('click', () => window.openAddComplaint());
      }

      // Outside click to close
      if (modal) {
        modal.addEventListener('click', function (e) {
          if (e.target === modal) window.closeAddComplaint();
        });
      }

      // Show/hide Submit Another Complaint depending on current complaints
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          const res = await fetch('/complainant/complaints/submitted');
          const data = await res.json();
          if (data.success) {
            const complaints = data.complaints || [];
            const hasValidComplaint = complaints.some(c => c.status !== 'Invalid');
            if (!hasValidComplaint) {
              submitAnotherBtn.classList.remove('hidden');
            } else {
              submitAnotherBtn.classList.add('hidden');
            }
          }
        } catch (err) {
          // On error, keep hidden
        }
      });
    })();

    async function goToRegistrationFromInvalid() {
      const typeSel = document.getElementById('addComplaintType');
      const type = typeSel ? typeSel.value : '';
      if (!type) {
        alert('Please select a complaint type first.');
        return;
      }
      sessionStorage.setItem('complaintType', type);
      try {
        const res = await fetch('/complainant/start-complaint', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ type })
        });
        if (res.redirected) {
          window.location.href = res.url;
          return;
        }
        const contentType = res.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          const text = await res.text();
          console.error('Unexpected non-JSON from start-complaint:', { status: res.status, body: text.slice(0, 200) });
          alert('Could not proceed. Please refresh and try again.');
          return;
        }
        const data = await res.json();
        if (data && data.redirect) {
          window.location.href = data.redirect;
        } else if (data && data.error) {
          alert(data.error);
        } else {
          alert('Unexpected response. Please try again.');
        }
      } catch (err) {
        console.error('start-complaint failed:', err);
        alert('Error: ' + err);
      }
    }
  </script>
</body>
</html>
