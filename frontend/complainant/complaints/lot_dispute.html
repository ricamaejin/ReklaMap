<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/complainants.css">
</head>
<body>

  <!-- Error Popup -->
  <div id="errorPop" 
    style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);z-index:999;background:#e3f2fd;color:#083048;width:max-content;padding:16px 28px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.12);font-weight:500;min-width:220px;max-width:340px;transition:opacity .2s;">
    <span id="errorPopMsg"></span>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <a href="/complainant/home/dashboard.html" class="nav-item">Home</a>
      <a href="/complainant/complaints/submitted_complaints.html" class="nav-item active">Complaints</a>
    </nav>
  </aside>
  

  <!-- Main Form -->
  <div class="main">
    <div class="form-container">
      <form id="lotDisputeForm">
      <h1 style="text-decoration: underline;">COMPLAINT FORM <br> LOT DISPUTE</h1>
      <div class="instructions">
        <p><strong>INSTRUCTION</strong></p>
        <ul>
          <li>Complete the application form properly and legibly.</li>
          <li>For checkbox items (☑), you may select more than one option if applicable.</li>
          <li>For radio button items (◉), please select only one option.</li>
          <li>If a field or question does not apply to you or you do not know the answer, write “N/A”.</li>
          <li>Ensure all required fields are filled before submitting the form.</li>
        </ul>
      </div>

      <div class="section-header">COMPLAINANT'S DETAILS:</div>
      <div id="complainantDetails"></div>

      <!-- Section 1 -->
      <div class="section-header">LOT DETAILS AND CLAIM:</div>
      <!-- Non-member only: Block/Lot pairs involved in the dispute (excluding theirs) -->
      <div id="nonMemberBlockLotSection" style="display:none;">
        <p>What is the specific block and lot involved in the lot dispute?</p>
        <div class="pairs" id="pairsContainer" aria-live="polite">
          <!-- rows will be added here -->
        </div>
        <div class="pair-controls">
          <button type="button" class="btn add small" id="addPairBtn" style="margin-bottom: 12px;">+ Add</button>
          <span style="color:var(--muted);font-size:13px;margin-left:8px"><i style="font-size: 14px; font-weight: normal; color: grey;">(If more than one area is affected, list all applicable pairs.)</i></span>
        </div>
      </div>
      <p style="font-weight: bold;">1. How did you come into possession of the lot?</p>
      <label><input type="radio" name="possession" value="Official assignment by NGCHDP/NHA"> I was officially assigned the lot by NGCHDP/NHA</label>
      <label><input type="radio" name="possession" value="Passed on by a family member"> The lot was passed on to me by a family member</label>
      <label><input type="radio" name="possession" value="Purchased from another occupant"> I purchased the lot from another occupant</label>
      <label><input type="radio" name="possession" value="Living since project started"> I have been living here since the NCC project started</label>
      <label><input type="radio" name="possession" value="Relocated after demolition/displacement"> I relocated here after demolition/displacement elsewhere</label>
      <label><input type="radio" name="possession" value="Verbal promise by former officer/neighbor" style="margin-bottom: 12px;"> I was verbally promised the lot by a former officer or neighbor</label>

      <p style="font-weight: bold;">2. What is the nature of the ownership conflict? <i class="hint">(Check all that apply)</i></p>
      <label><input type="checkbox" name="nature" value="Someone else has a contract"> Someone else has a contract for the same lot</label>
      <label><input type="checkbox" name="nature" value="Someone else claiming lot"> Someone else is claiming my assigned lot</label>
      <label><input type="checkbox" name="nature" value="Assigned different lot"> I was assigned a different lot than what I was told</label>
      <label><input type="checkbox" name="nature" value="Lot not reflected in masterlist"> My lot is not reflected in the masterlist</label>
      <label><input type="checkbox" name="nature" value="Name removed from list"> My name was removed or replaced in the beneficiary list</label>
      <label><input type="checkbox" name="nature" value="Lot illegally sold"> The lot was illegally sold or reassigned to someone else</label>
      <label><input type="checkbox" name="nature" value="Family member claiming"> A family member/relative is claiming the lot I currently occupy</label>
      <label><input type="checkbox" name="nature" value="Lot details incorrect"> My assigned lot details (e.g., lot no., area) are incorrect in the records</label>
      <label><input type="checkbox" name="nature" value="Not sure" style="margin-bottom: 12px;"> I am not sure what caused the dispute</label>
      
      <p style="font-weight: bold;">3. When did the dispute start?</p>
      <input name="dispute_start_date" type="date" title="Dispute start date" 
      style="width: 20%; padding: 8px; margin-top: 6px; margin-left: 18px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">

      <p style="font-weight: bold;">4. What led you to raise this complaint? <i class="hint">(Check all that apply)</i></p>
      <label><input type="checkbox" name="reason" value="Asked to vacate"> I was asked to vacate the lot I’ve been occupying</label>
      <label><input type="checkbox" name="reason" value="Denied access"> I was denied access to a lot I believe was assigned to me</label>
      <label><input type="checkbox" name="reason" value="Received notice"> I received notice that someone else is the rightful owner</label>
      <label><input type="checkbox" name="reason" value="Stopped from building"> I attempted to build on the lot and was stopped</label>
      <label><input type="checkbox" name="reason" value="Discovered duplicate record"> I discovered another person listed in official records for my lot</label>
      <label><input type="checkbox" name="reason" value="Clarification only" style="margin-bottom: 12px;"> I just want clarification about my assigned lot (no direct conflict yet)</label>

      <label><strong>5. Have you reported this boundary issue to any office or authority?</strong></label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="Barangay"> Barangay</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="HOA"> HOA</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="NGC"> NGC</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="NGC"> USAD - PHASELAD</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="none"> None</label>

      <label><strong>6. What was the result of the report or inspection?</strong> <i style="font-size: 14px; font-weight: normal; color: grey;">(Check all that apply)</i></label>
      <label><input type="checkbox" name="site_result[]" value="Advised to adjust or vacate"> The other party was advised to adjust or vacate</label>
      <label><input type="checkbox" name="site_result[]" value="Asked to provide more documents"> I was advised to provide more documents</label>
      <label><input type="checkbox" name="site_result[]" value="Still under investigation"> The issue is still under investigation</label>
      <label><input type="checkbox" name="site_result[]" value="No valid claim"> I was told I have no valid claim</label>
      <label><input type="checkbox" name="site_result[]" value="No action taken"> No action was taken</label>
      <label><input type="checkbox" name="site_result[]" value="Not applicable"> Not applicable / No inspection yet</label>

      <!-- Section 2 -->
      <div class="section-header">PERSONS INVOLVED DETAILS</div>
      <p style="font-weight: bold;">1. Name of opposing claimant?</p>
      <div id="opposingNameContainer">
        <div class="opposing-name-input" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
          <input type="text" name="opposing_name[]" placeholder="Enter name" style="flex: 1; margin-left: 15px;">
        </div>
      </div>
      <button type="button" class="btn add small" id="addOpposingNameBtn" style="margin-left: 15px; margin-bottom: 12px;">+ Add another person</button>

      <p style="font-weight: bold;">2. Relationship with person involved?</p>
      <div id="relationshipContainer">
        <div class="relationship-input" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
          <input type="text" name="relationship_with_person[]" placeholder="Relationship to the individual (neighbor, relative, etc.)" style="flex: 1; margin-left: 15px;">
        </div>
      </div>
      <button type="button" class="btn add small" id="addRelationshipBtn" style="margin-left: 15px; margin-bottom: 12px;">+ Add another relationship</button>
      <p style="font-weight: bold;">3. Do they reside on the disputed lot?</p>
      <label><input type="radio" name="reside" value="Yes"> Yes</label>
      <label><input type="radio" name="reside" value="No"> No</label>
      <label><input type="radio" name="reside" value="Not Sure"> Not sure</label>
      <p style="font-weight: bold;">4. Do they claim to have legal documents?</p>
      <div class="options-group" id="claimDocs">
      <label><input type="radio" name="claimDocs" value="Yes"> Yes</label>
        <div id="docOptions" style="display:none; margin-left: 35px;">
          <p style="margin-left: 5px; font-weight: bold;">What documents do they have?</p>
          <label><input type="checkbox" name="docs" value="Certificate of Lot Award (CLA)">Title</label>
          <label><input type="checkbox" name="docs" value="Notice of Award"> Contract to Sell</label>
          <label><input type="checkbox" name="docs" value="Deed of Assignment / Transfer"> Certificate of Full Payment</label>
          <label><input type="checkbox" name="docs" value="Certification from NGC/NHA/Barangay"> Pre-qualification Stub</label>
          <label><input type="checkbox" name="docs" value="contract_agreement"> Contract/Agreement</label>
          <label><input type="checkbox" name="docs" value="Other supporting paper"> Deed of Sale</label>
        </div>
      <label><input type="radio" name="claimDocs" value="No"> No</label>
      <label><input type="radio" name="claimDocs" value="Not Sure"> Not sure</label>
    </div>

      <p class="section-label">Please describe what happened briefly, including how you found out about the issue.</p>
      <textarea id="description" name="description" title="Please describe what happened briefly, including how you found out about the issue."></textarea>

      <!-- Section 3 -->
      <div class="section-header">COMPLAINANT’S CONSENT AND DECLARATION</div>
      <div class="consent">
        By submitting this complaint form, I hereby consent to the collection and processing of my personal information as necessary to address the issues raised regarding the lot in question. I confirm that the information provided is accurate and complete to the best of my knowledge. I understand that any false or incomplete information may affect the handling of my complaint, and I acknowledge that my personal details will be processed in compliance with the Privacy Act and other applicable laws.
      </div>

      <div class="signature">
        <input type="file" id="signatureInput" accept="image/*" style="display:none;" />
        <button type="button" class="upload-btn" onclick="document.getElementById('signatureInput').click()">Upload Signature</button>
        <span id="signatureFileName" style="margin-left:10px; font-style:italic;"></span>
        <button type="submit" id="submitBtn" class="btn" style="display:none; margin-top:12px;">Submit Complaint</button>
      </div>
      </form>
    </div>
  </div>


<script>
  // Populate complainant details (same logic)
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const res = await fetch('/complainant/lot_dispute/get_lot_session_data');
      const d = await res.json();
      const container = document.getElementById('complainantDetails');
      if (!container || !d || d.error) return;

  const pairs = document.createElement('div');
      pairs.className = 'pairs';
      let memberWrapper = null;

      function row1(label, value, type = 'text') {
        const r = document.createElement('div');
        r.className = 'pair-row';
        r.innerHTML = `<div class="col"><label class="small">${label}</label><input type="${type}" value="${value || ''}" readonly title="${label}"></div>`;
        return r;
      }
      function row2(l1, v1, l2, v2, t1='text', t2='text') {
        const r = document.createElement('div');
        r.className = 'pair-row';
        r.innerHTML = `
          <div class="col"><label class="small">${l1}</label><input type="${t1}" value="${v1 || ''}" readonly></div>
          <div class="col"><label class="small">${l2}</label><input type="${t2}" value="${v2 || ''}" readonly></div>`;
        return r;
      }
      function row3(l1, v1, l2, v2, l3, v3) {
        const r = document.createElement('div');
        r.className = 'pair-row';
        r.innerHTML = `
          <div class="col"><label class="small">${l1}</label><input type="text" value="${v1 || ''}" readonly></div>
          <div class="col"><label class="small">${l2}</label><input type="text" value="${v2 || ''}" readonly></div>
          <div class="col"><label class="small">${l3}</label><input type="text" value="${v3 || ''}" readonly></div>`;
        return r;
      }

      pairs.appendChild(row1('Full Name:', d.full_name));
      pairs.appendChild(row2('Date of Birth:', d.date_of_birth, 'Sex:', d.sex, 'date', 'text'));
      pairs.appendChild(row2('Citizenship:', d.citizenship, 'Age:', d.age));
      pairs.appendChild(row2('Phone Number:', d.phone_number, 'Year of Residence:', d.year_of_residence));

      if (d.category === 'family_of_member') {
        pairs.appendChild(row2('Relationship:', d.relationship || '', 'Current Address:', d.cur_add));
      } else if (d.category === 'non_member') {
        pairs.appendChild(row2('Civil Status:', d.civil_status || '', 'Recipient of Other Housing:', d.recipient_of_other_housing || ''));
        pairs.appendChild(row1('Current Address:', d.cur_add));
        pairs.appendChild(row1('Area (HOA):', d.hoa || ''));
      } else {
        pairs.appendChild(row1('Current Address:', d.cur_add));
      }

      // For non_member, no Area selection dropdown; Area (HOA) is shown read-only above.

  // HOA details for hoa_member and family_of_member
      if (d.category === 'hoa_member' || d.category === 'family_of_member') {
        if (d.category === 'family_of_member') {
          if (d.parent_info) {
            const wrapper = document.createElement('div');
            wrapper.style.marginTop = '20px';
            const h3 = document.createElement('h3');
            h3.textContent = 'HOA Member Information';
            h3.style.color = '#083048';
            h3.style.marginBottom = '10px';
            wrapper.appendChild(h3);

            const memberPairs = document.createElement('div');
            memberPairs.className = 'pairs';
            const p = d.parent_info;
            memberPairs.appendChild(row2('Full Name:', p.full_name, 'Date of Birth:', p.date_of_birth, 'text', 'date'));
            memberPairs.appendChild(row2('Sex:', p.sex, 'Citizenship:', p.citizenship));
            memberPairs.appendChild(row2('Age:', p.age, 'Year of Residence:', p.year_of_residence));
            memberPairs.appendChild(row1('HOA:', d.hoa || ''));
            memberPairs.appendChild(row3('Block Assignment:', d.blk_num || '', 'Lot Assignment:', d.lot_num || '', 'Lot Size:', d.lot_size || ''));
            memberPairs.appendChild(row2('Civil Status:', d.civil_status || '', 'Recipient of Other Housing:', d.recipient_of_other_housing || ''));

            wrapper.appendChild(memberPairs);
            memberWrapper = wrapper;
          }
        } else {
          pairs.appendChild(row1('HOA:', d.hoa || ''));
          pairs.appendChild(row3('Block Assignment:', d.blk_num || '', 'Lot Assignment:', d.lot_num || '', 'Lot Size:', d.lot_size || ''));
          pairs.appendChild(row2('Civil Status:', d.civil_status || '', 'Recipient of Other Housing:', d.recipient_of_other_housing || ''));
        }
      }

      container.innerHTML = '';
      container.appendChild(pairs);
      if (memberWrapper) {
        container.appendChild(memberWrapper);
      }

      // Show Block/Lot pairs question only for non_members
      const nonMemberPairs = document.getElementById('nonMemberBlockLotSection');
      if (nonMemberPairs) {
        nonMemberPairs.style.display = d.category === 'non_member' ? '' : 'none';
      }

      // Initialize pairs UI only when visible
      if (d.category === 'non_member') {
        initBlockLotPairsUI();
      }
    } catch (e) {
      console.warn('Failed to populate lot dispute header:', e);
    }
  });

  // Error pop-up
  function showErrorPop(msg) {
    const pop = document.getElementById('errorPop');
    const popMsg = document.getElementById('errorPopMsg');
    if (!pop || !popMsg) return;
    popMsg.textContent = msg;
    pop.style.display = 'block';
    pop.style.opacity = '1';
    setTimeout(() => {
      pop.style.opacity = '0';
      setTimeout(() => { pop.style.display = 'none'; }, 400);
    }, 1000);
  }

  // Helper to manage dynamic Block/Lot pairs UI (mirrors overlapping)
  function initBlockLotPairsUI(){
    const pairsContainer = document.getElementById('pairsContainer');
    const addPairBtn = document.getElementById('addPairBtn');
    if (!pairsContainer || !addPairBtn) return;

    function createPairRow(block = '', lot = '') {
      const row = document.createElement('div');
      row.className = 'pair-row';

      const colBlock = document.createElement('div');
      colBlock.className = 'col';
      const lblBlock = document.createElement('label');
      lblBlock.className = 'small';
      lblBlock.textContent = 'Block No.';
      const inputBlock = document.createElement('input');
      inputBlock.type = 'text';
      inputBlock.name = 'block_no[]';
      inputBlock.value = block;
      inputBlock.placeholder = 'Block No.';
      colBlock.appendChild(lblBlock);
      colBlock.appendChild(inputBlock);

      const colLot = document.createElement('div');
      colLot.className = 'col';
      const lblLot = document.createElement('label');
      lblLot.className = 'small';
      lblLot.textContent = 'Lot No.';
      const inputLot = document.createElement('input');
      inputLot.type = 'text';
      inputLot.name = 'lot_no[]';
      inputLot.value = lot;
      inputLot.placeholder = 'Lot No.';
      colLot.appendChild(lblLot);
      colLot.appendChild(inputLot);

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove';
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = () => {
        pairsContainer.removeChild(row);
        updateRemoveButtons();
      };

      row.appendChild(colBlock);
      row.appendChild(colLot);
      row.appendChild(removeBtn);

      return row;
    }

    function updateRemoveButtons() {
      const rows = pairsContainer.querySelectorAll('.pair-row');
      rows.forEach((r) => {
        const btn = r.querySelector('button.remove');
        btn.disabled = rows.length === 1;
        btn.style.opacity = btn.disabled ? 0.45 : 1;
        btn.style.cursor = btn.disabled ? 'not-allowed' : 'pointer';
      });
    }

    // initial
    pairsContainer.appendChild(createPairRow());
    updateRemoveButtons();

    addPairBtn.addEventListener('click', () => {
      pairsContainer.appendChild(createPairRow());
      updateRemoveButtons();
      const rows = pairsContainer.querySelectorAll('.pair-row');
      const last = rows[rows.length-1];
      last.querySelector('input[name="block_no[]"]').focus();
    });
  }

  // Submit Lot Dispute (match overlapping flow: form submit, no alerts)
  (function(){
    const form = document.getElementById('lotDisputeForm');
    const sigInput = document.getElementById('signatureInput');
    const submitBtn = document.getElementById('submitBtn');
    const sigName = document.getElementById('signatureFileName');

    if (sigInput) {
      sigInput.addEventListener('change', function(){
        if (this.files && this.files[0]) {
          if (sigName) sigName.textContent = this.files[0].name;
          if (submitBtn) submitBtn.style.display = 'inline-block';
        } else {
          if (sigName) sigName.textContent = '';
          if (submitBtn) submitBtn.style.display = 'none';
        }
      });
    }

    if (!form) return;
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const getRadio = (name) => {
        const el = document.querySelector(`input[name="${name}"]:checked`);
        return el ? el.value : '';
      };

      // Handle "Other" augmentations for possession field
      let possession = getRadio('possession');
      if (possession === 'Other') {
        const t = document.getElementById('possessionOtherText').value.trim();
        possession = t ? `Other: ${t}` : 'Other';
      }
      possession = possession.substring(0, 200); // Limit to 200 chars

      const reportedTo = Array.from(document.querySelectorAll('.reported_to:checked')).map(x => x.value);
      const disputeDate = document.querySelector('input[name="dispute_start_date"]').value;
      
      // Collect multiple opposing names
      const opposingNames = Array.from(document.querySelectorAll('input[name="opposing_name[]"]'))
        .map(input => input.value.trim())
        .filter(name => name !== '');
      
      // Collect multiple relationships
      const relationships = Array.from(document.querySelectorAll('input[name="relationship_with_person[]"]'))
        .map(input => input.value.trim())
        .filter(rel => rel !== '');
      
      const legalDocs = getRadio('claimDocs');
      const resideAnswer = getRadio('reside');

      // Collect document types if "Yes" was selected for legal documents
      let documentTypes = [];
      if (legalDocs === 'Yes') {
        documentTypes = Array.from(document.querySelectorAll('input[name="docs"]:checked')).map(x => x.value);
      }

      // If non_member, collect Block/Lot pairs and validate before submit
      const nonMemberSection = document.getElementById('nonMemberBlockLotSection');
      let blockLot = [];
      if (nonMemberSection && nonMemberSection.style.display !== 'none') {
        const rows = Array.from(document.querySelectorAll('#pairsContainer .pair-row'));
        blockLot = rows.map(row => {
          const blockInput = row.querySelector('input[name="block_no[]"]');
          const lotInput = row.querySelector('input[name="lot_no[]"]');
          return { block: blockInput ? blockInput.value.trim() : '', lot: lotInput ? lotInput.value.trim() : '' };
        }).filter(item => item.block || item.lot);
        // Validate pairs with backend before actual submit
        try {
          const resp = await fetch('/complainant/lot_dispute/validate_pairs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ pairs: blockLot })
          });
          const data = await resp.json();
          if (!resp.ok || !data.success) {
            let msg = data.message || 'Invalid Block/Lot pairs.';
            if (data.mismatches && Array.isArray(data.mismatches) && data.mismatches.length > 0) {
              // Only show the first unique error message (deduplicate)
              const unique = [...new Set(data.mismatches)];
              msg = unique[0] || msg;
            }
            showErrorPop(msg);
            return;
          }
        } catch (err) {
          showErrorPop('Could not validate Block/Lot pairs. Please try again.');
          return;
        }
      }

      // Collect checkbox values for question 2
      const natureChecked = Array.from(document.querySelectorAll('input[name="nature"]:checked')).map(x => x.value);
      const conflictValue = natureChecked.join(', ').substring(0, 200); // Limit to 200 chars

      // Collect checkbox values for question 4
      const reasonChecked = Array.from(document.querySelectorAll('input[name="reason"]:checked')).map(x => x.value);
      const reasonValue = reasonChecked.join(', ').substring(0, 200); // Limit to 200 chars

      // Collect checkbox values for question 6
      const resultChecked = Array.from(document.querySelectorAll('input[name="result"]:checked')).map(x => x.value);
      const resultValue = resultChecked.join(', ').substring(0, 200); // Limit to 200 chars

      const fd = new FormData();
      fd.append('possession', possession);
      fd.append('conflict', conflictValue);
      fd.append('dispute_start_date', disputeDate);
      fd.append('reason', reasonValue);
      fd.append('reported_to', JSON.stringify(reportedTo));
      fd.append('result', resultValue);
      
      // Append multiple opposing names
      opposingNames.forEach(name => {
        fd.append('opposing_name[]', name.substring(0, 100));
      });
      
      // Append multiple relationships
      relationships.forEach(rel => {
        fd.append('relationship_with_person[]', rel.substring(0, 100));
      });
      
      fd.append('claimDocs', legalDocs);
      fd.append('reside', resideAnswer);
      
      // Append document types if any were selected
      documentTypes.forEach(doc => {
        fd.append('docs', doc);
      });
      // Include free-text description so backend can persist it
      const descriptionText = (document.getElementById('description')?.value || '').trim();
      fd.append('description', descriptionText);
      if (blockLot.length > 0) {
        fd.append('block_lot', JSON.stringify(blockLot));
      }
      if (sigInput && sigInput.files[0]) {
        fd.append('signature', sigInput.files[0]);
      }

      // No Area selection; backend derives Area from registration.

      try {
        const res = await fetch('/complainant/lot_dispute/submit_lot_dispute', {
          method: 'POST',
          body: fd,
          credentials: 'include'
        });

        if (res.ok) {
          const data = await res.json().catch(() => ({}));
          if (data.success) window.location.href = '/complainant/home/dashboard.html';
          else showErrorPop(data.message || 'Failed to submit.');
        } else {
          const data = await res.json().catch(() => ({}));
          showErrorPop(data.message || 'Error occurred while submitting.');
        }
      } catch {
        showErrorPop('An error occurred while submitting the complaint.');
      }
    });
  })();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("lotDisputeForm");
  const claimDocsRadios = form.querySelectorAll("input[name='claimDocs']");
  const docOptions = document.getElementById("docOptions");

  // Show/hide document options when "Yes" is selected
  claimDocsRadios.forEach(radio => {
    radio.addEventListener("change", () => {
      docOptions.style.display = (radio.value === "Yes" && radio.checked) ? "block" : "none";
    });
  });

  // Setup add/remove for "Name of opposing claimant" section
  (function setupOpposingNameInputs() {
    const container = document.getElementById('opposingNameContainer');
    const addBtn = document.getElementById('addOpposingNameBtn');
    if (!container || !addBtn) return;

    function createOpposingNameRow(withRemove = true) {
      const row = document.createElement('div');
      row.className = 'opposing-name-input';
      row.style.display = 'flex';
      row.style.gap = '8px';
      row.style.alignItems = 'center';
      row.style.marginBottom = '8px';

      const input = document.createElement('input');
      input.type = 'text';
      input.name = 'opposing_name[]';
      input.placeholder = 'Enter name';
      input.style.flex = '1';
      input.style.marginLeft = '15px';

      row.appendChild(input);

      if (withRemove) {
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn add small remove-opposing-name';
        removeBtn.textContent = 'Remove';
        removeBtn.style.color = '#999';
        row.appendChild(removeBtn);
      }

      return row;
    }

    // Ensure only rows after the first have remove buttons
    function normalizeOpposingNameRows() {
      const rows = container.querySelectorAll('.opposing-name-input');
      rows.forEach((row, idx) => {
        const removeBtn = row.querySelector('.remove-opposing-name');
        if (idx === 0 && removeBtn) {
          removeBtn.remove();
        } else if (idx > 0 && !removeBtn) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn add small remove-opposing-name';
          btn.textContent = 'Remove';
          btn.style.color = '#999';
          row.appendChild(btn);
        }
      });
    }

    addBtn.addEventListener('click', () => {
      container.appendChild(createOpposingNameRow(true));
      normalizeOpposingNameRows();
      const rows = container.querySelectorAll('.opposing-name-input');
      const last = rows[rows.length-1];
      last.querySelector('input[name="opposing_name[]"]').focus();
    });

    container.addEventListener('click', (e) => {
      if (e.target && e.target.classList.contains('remove-opposing-name')) {
        const row = e.target.closest('.opposing-name-input');
        if (row) row.remove();
        normalizeOpposingNameRows();
      }
    });

    // Normalize initial state
    normalizeOpposingNameRows();
  })();

  // Setup add/remove for "Relationship with person involved" section
  (function setupRelationshipInputs() {
    const container = document.getElementById('relationshipContainer');
    const addBtn = document.getElementById('addRelationshipBtn');
    if (!container || !addBtn) return;

    function createRelationshipRow(withRemove = true) {
      const row = document.createElement('div');
      row.className = 'relationship-input';
      row.style.display = 'flex';
      row.style.gap = '8px';
      row.style.alignItems = 'center';
      row.style.marginBottom = '8px';

      const input = document.createElement('input');
      input.type = 'text';
      input.name = 'relationship_with_person[]';
      input.placeholder = 'Relationship to the individual (neighbor, relative, etc.)';
      input.style.flex = '1';
      input.style.marginLeft = '15px';

      row.appendChild(input);

      if (withRemove) {
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn add small remove-relationship';
        removeBtn.textContent = 'Remove';
        removeBtn.style.color = '#999';
        row.appendChild(removeBtn);
      }

      return row;
    }

    // Ensure only rows after the first have remove buttons
    function normalizeRelationshipRows() {
      const rows = container.querySelectorAll('.relationship-input');
      rows.forEach((row, idx) => {
        const removeBtn = row.querySelector('.remove-relationship');
        if (idx === 0 && removeBtn) {
          removeBtn.remove();
        } else if (idx > 0 && !removeBtn) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn add small remove-relationship';
          btn.textContent = 'Remove';
          btn.style.color = '#999';
          row.appendChild(btn);
        }
      });
    }

    addBtn.addEventListener('click', () => {
      container.appendChild(createRelationshipRow(true));
      normalizeRelationshipRows();
      const rows = container.querySelectorAll('.relationship-input');
      const last = rows[rows.length-1];
      last.querySelector('input[name="relationship_with_person[]"]').focus();
    });

    container.addEventListener('click', (e) => {
      if (e.target && e.target.classList.contains('remove-relationship')) {
        const row = e.target.closest('.relationship-input');
        if (row) row.remove();
        normalizeRelationshipRows();
      }
    });

    // Normalize initial state
    normalizeRelationshipRows();
  })();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form');
  if (!form) return;

  // 🔧 Function that makes “None” exclusive per group
  function setupExclusiveNone(checkboxes) {
    if (!checkboxes || checkboxes.length === 0) return;
    const noneCheckbox = Array.from(checkboxes).find(cb => cb.value.toLowerCase() === 'none');
    const otherCheckboxes = Array.from(checkboxes).filter(cb => cb !== noneCheckbox);
    if (!noneCheckbox) return;

    // When "None" is checked → disable all others
    noneCheckbox.addEventListener('change', () => {
      if (noneCheckbox.checked) {
        otherCheckboxes.forEach(cb => {
          cb.checked = false;
          cb.disabled = true;
          cb.closest('label')?.classList.add('disabled');
        });
      } else {
        otherCheckboxes.forEach(cb => {
          cb.disabled = false;
          cb.closest('label')?.classList.remove('disabled');
        });
      }
    });

    // When any other is checked → uncheck "None"
    otherCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        if (cb.checked) {
          noneCheckbox.checked = false;
          noneCheckbox.disabled = false;
          noneCheckbox.closest('label')?.classList.remove('disabled');
        }
      });
    });
  }

  // ✅ Apply to Question 5 only
  const q5Checkboxes = Array.from(form.querySelectorAll('input[name="boundary_reported_to[]"]'));
  setupExclusiveNone(q5Checkboxes);

  // Optional: subtle styling for disabled ones
  const style = document.createElement('style');
  style.textContent = `
    label.disabled { opacity: 0.6; cursor: not-allowed; }
    label.disabled input { cursor: not-allowed; }
  `;
  document.head.appendChild(style);
});
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
  const q9Checkboxes = document.querySelectorAll('input[name="site_result[]"]');
  if (q9Checkboxes.length === 0) return;

  const notApplicable = Array.from(q9Checkboxes).find(
    cb => (cb.value || "").toLowerCase().includes("not applicable")
  );
  const others = Array.from(q9Checkboxes).filter(cb => cb !== notApplicable);

  if (!notApplicable) return;

  // Initial state check
  if (notApplicable.checked) {
    others.forEach(cb => {
      cb.checked = false;
      cb.disabled = true;
      cb.closest("label")?.classList.add("disabled");
    });
  }

  // When Not Applicable is toggled
  notApplicable.addEventListener("change", () => {
    if (notApplicable.checked) {
      others.forEach(cb => {
        cb.checked = false;
        cb.disabled = true;
        cb.closest("label")?.classList.add("disabled");
      });
    } else {
      others.forEach(cb => {
        cb.disabled = false;
        cb.closest("label")?.classList.remove("disabled");
      });
    }
  });

  // If others are checked, uncheck Not Applicable
  others.forEach(cb => {
    cb.addEventListener("change", () => {
      if (cb.checked) {
        notApplicable.checked = false;
        notApplicable.disabled = false;
        notApplicable.closest("label")?.classList.remove("disabled");
      }
    });
  });
});

</script>
</body>
</html>
