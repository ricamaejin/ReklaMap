<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/complainants.css">
</head>
<body>

  <!-- Error Popup (same as overlapping) -->
  <div id="errorPop" 
    style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);z-index:999;background:#e3f2fd;color:#083048;width:max-content;padding:16px 28px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.12);font-weight:500;min-width:220px;max-width:340px;transition:opacity .2s;">
    <span id="errorPopMsg"></span>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <a href="/complainant/home/dashboard.html" class="nav-item">Home</a>
      <a href="/complainant/complaints/submitted_complaints.html" class="nav-item active">Complaints</a>
    </nav>
  </aside>
  

  <!-- Main Form -->
  <div class="main">
    <div class="form-container">
      <form id="lotDisputeForm">
      <h1 style="text-decoration: underline;">COMPLAINT FORM <br> LOT DISPUTE</h1>
      <div class="instructions">
        <p><strong>INSTRUCTION</strong></p>
        <ul>
          <li>Complete the application form properly and legibly.</li>
          <li>For checkbox items (☑), you may select more than one option if applicable.</li>
          <li>For radio button items (◉), please select only one option.</li>
          <li>If a field or question does not apply to you or you do not know the answer, write “N/A” (Not Applicable).</li>
          <li>Ensure all required fields are filled before submitting the form.</li>
        </ul>
      </div>

      <div class="section-header">COMPLAINANT'S DETAILS:</div>
      <div id="complainantDetails"></div>

      <!-- Section 1 -->
      <div class="section-header">LOT DETAILS AND CLAIM:</div>
      <p>1. How did you come into possession of the lot?</p>
      <label><input type="radio" name="possession" value="Official assignment by NGCHDP/NHA"> I was officially assigned the lot by NGCHDP/NHA</label>
      <label><input type="radio" name="possession" value="Passed on by a family member"> The lot was passed on to me by a family member</label>
      <label><input type="radio" name="possession" value="Purchased from another occupant"> I purchased the lot from another occupant</label>
      <label><input type="radio" name="possession" value="Living since project started"> I have been living here since the NCC project started</label>
      <label><input type="radio" name="possession" value="Relocated after demolition/displacement"> I relocated here after demolition/displacement elsewhere</label>
      <label><input type="radio" name="possession" value="Verbal promise by former officer/neighbor"> I was verbally promised the lot by a former officer or neighbor</label>
      <label><input type="radio" name="possession" value="Other" id="possessionOther"> Other</label>
      <input type="text" id="possessionOtherText" placeholder="Please specify" class="hidden">


      <p>2. What is the nature of the ownership conflict?</p>
      <label><input type="radio" name="conflict" value="Contract duplication for same lot"> Someone else has a contract for the same lot</label>
      <label><input type="radio" name="conflict" value="Another is claiming my assigned lot"> Someone else is claiming my assigned lot</label>
      <label><input type="radio" name="conflict" value="Assigned a different lot than told"> I was assigned a different lot than what I was told</label>
      <label><input type="radio" name="conflict" value="Lot not reflected in masterlist"> My lot is not reflected in the masterlist</label>
      <label><input type="radio" name="conflict" value="Name removed or replaced in beneficiary list"> My name was removed or replaced in the beneficiary list</label>
      <label><input type="radio" name="conflict" value="Lot illegally sold or reassigned"> Lot was illegally sold or reassigned to someone else</label>
      <label><input type="radio" name="conflict" value="Family member/relative claiming the lot I occupy"> A family member/relative is claiming the lot I currently occupy</label>
      <label><input type="radio" name="conflict" value="Assigned lot details incorrect in records"> My assigned lot details (e.g., lot no., area) are incorrect in the records</label>

      <p>3. When did the dispute start?</p>
      <input name="dispute_start_date" type="date" title="Dispute start date">

      <p>4. What led you to raise this complaint?</p>
      <label><input type="radio" name="reason" value="Asked to vacate the lot I occupy"> I was asked to vacate the lot I’ve been occupying</label>
      <label><input type="radio" name="reason" value="Denied access to lot I believe was assigned"> I was denied access to a lot I believe was assigned to me</label>
      <label><input type="radio" name="reason" value="Notice received that someone else is rightful owner"> I received notice that someone else is the rightful owner</label>
      <label><input type="radio" name="reason" value="Attempted to build and was stopped"> I attempted to build on the lot and was stopped</label>
      <label><input type="radio" name="reason" value="Another person listed in official records for my lot"> I discovered another person listed in official records for my lot</label>
      <label><input type="radio" name="reason" value="Other" id="reasonOther"> Other</label>
      <input type="text" id="reasonOtherText" placeholder="Please specify" class="hidden">

      <p>5. Have you reported this to any authority? <i class="hint">(Check all that apply)</i></p>
      <label><input type="checkbox" class="reported_to" value="Barangay"> Barangay</label>
      <label><input type="checkbox" class="reported_to" value="HOA"> HOA</label>
      <label><input type="checkbox" class="reported_to" value="NGC"> NGC</label>
      <label><input type="checkbox" class="reported_to" value="None"> None</label>

      <p>6. What was the result of that report?</p>
      <label><input type="radio" name="result" value="Other party asked to vacate"> The other party was asked to vacate</label>
      <label><input type="radio" name="result" value="Agency asked for more documentation"> The agency asked for more documentation</label>
      <label><input type="radio" name="result" value="No action taken"> No action was taken</label>
      <label><input type="radio" name="result" value="Still under investigation"> Still under investigation</label>
      <label><input type="radio" name="result" value="Told I have no valid claim"> I was told I have no valid claim</label>
      <label><input type="radio" name="result" value="Other" id="resultOther"> Other</label>
      <input type="text" id="resultOtherText" placeholder="Please specify" class="hidden">


      <!-- Section 2 -->
      <div class="section-header">PERSONS INVOLVED (IF ANY)</div>
      <p>1. Name of opposing claimant?</p>
      <input type="text" name="opposing_name" placeholder="Enter name (if known)">
      <p>2. Relationship with person involved?</p>
      <input type="text" name="relationship_with_person" placeholder="Relationship to the individual (if applicable)">
      <p>3. Do they reside on the disputed lot?</p>
      <label><input type="radio" name="reside" value="Yes"> Yes</label>
      <label><input type="radio" name="reside" value="No"> No</label>
      <label><input type="radio" name="reside" value="Not Sure"> Not sure</label>
      <p>4. Do they claim to have legal documents?</p>
      <label><input type="radio" name="legal_docs" value="Yes"> Yes</label>
      <label><input type="radio" name="legal_docs" value="No"> No</label>
      <label><input type="radio" name="legal_docs" value="Not Sure"> Not sure</label>

      <p class="section-label">Please describe what happened briefly, including how you found out about the issue.</p>
      <textarea id="description" placeholder=""></textarea>

      <!-- Section 3 -->
      <div class="section-header">COMPLAINANT’S CONSENT AND DECLARATION</div>
      <div class="consent">
        By submitting this complaint form, I hereby consent to the collection and processing of my personal information as necessary to address the issues raised regarding the lot in question. I confirm that the information provided is accurate and complete to the best of my knowledge. I understand that any false or incomplete information may affect the handling of my complaint, and I acknowledge that my personal details will be processed in compliance with the Privacy Act and other applicable laws.
      </div>

      <div class="signature">
        <input type="file" id="signatureInput" accept="image/*" style="display:none;" />
        <button type="button" class="upload-btn" onclick="document.getElementById('signatureInput').click()">Upload Signature</button>
        <span id="signatureFileName" style="margin-left:10px; font-style:italic;"></span>
        <button type="submit" id="submitBtn" class="btn" style="display:none; margin-top:12px;">Submit Complaint</button>
      </div>
      </form>
    </div>
  </div>


<script>
  function setupOtherRadio(radioId, textId, groupName) {
    const otherRadio = document.getElementById(radioId);
    const otherText = document.getElementById(textId);
    const radios = document.querySelectorAll(`input[name="${groupName}"]`);

    radios.forEach(radio => {
      radio.addEventListener('change', function () {
        if (otherRadio.checked) {
          otherText.style.display = 'inline-block';
        } else {
          otherText.style.display = 'none';
          otherText.value = '';
        }
      });
    });
  }

  // Apply to all "Other" groups
  setupOtherRadio("possessionOther", "possessionOtherText", "possession");
  setupOtherRadio("reasonOther", "reasonOtherText", "reason");
  setupOtherRadio("resultOther", "resultOtherText", "result");

  // Populate complainant details (category-specific) with full fields and HOA Member Information
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const res = await fetch('/complainant/lot_dispute/get_lot_session_data');
      const d = await res.json();
      const container = document.getElementById('complainantDetails');
      if (!container || !d || d.error) return;

      const pairs = document.createElement('div');
      pairs.className = 'pairs';
      // Optional secondary wrapper (outside the first pairs) like overlapping.html
      let memberWrapper = null;

      function row1(label, value, type = 'text') {
        const r = document.createElement('div');
        r.className = 'pair-row';
        r.innerHTML = `
          <div class="col"><label class="small">${label}</label><input type="${type}" value="${value || ''}" readonly title="${label}"></div>
        `;
        return r;
      }
      function row2(l1, v1, l2, v2, t1='text', t2='text') {
        const r = document.createElement('div');
        r.className = 'pair-row';
        r.innerHTML = `
          <div class="col"><label class="small">${l1}</label><input type="${t1}" value="${v1 || ''}" readonly title="${l1}"></div>
          <div class="col"><label class="small">${l2}</label><input type="${t2}" value="${v2 || ''}" readonly title="${l2}"></div>
        `;
        return r;
      }
      function row3(l1, v1, l2, v2, l3, v3) {
        const r = document.createElement('div');
        r.className = 'pair-row';
        r.innerHTML = `
          <div class="col"><label class="small">${l1}</label><input type="text" value="${v1 || ''}" readonly title="${l1}"></div>
          <div class="col"><label class="small">${l2}</label><input type="text" value="${v2 || ''}" readonly title="${l2}"></div>
          <div class="col"><label class="small">${l3}</label><input type="text" value="${v3 || ''}" readonly title="${l3}"></div>
        `;
        return r;
      }

      // Common complainant info
      pairs.appendChild(row1('Full Name:', d.full_name));
      pairs.appendChild(row2('Date of Birth:', d.date_of_birth, 'Sex:', d.sex, 'date', 'text'));
      pairs.appendChild(row2('Citizenship:', d.citizenship, 'Age:', d.age));
      pairs.appendChild(row2('Phone Number:', d.phone_number, 'Year of Residence:', d.year_of_residence));

      // Category-specific additions and address placement
      if (d.category === 'family_of_member') {
        // Place Relationship and Current Address side-by-side in a single row
        pairs.appendChild(row2('Relationship:', d.relationship || '', 'Current Address:', d.cur_add));
      } else if (d.category === 'non_member') {
        // For non_member, show Civil Status and Recipient here
        pairs.appendChild(row2('Civil Status:', d.civil_status || '', 'Recipient of Other Housing:', d.recipient_of_other_housing || ''));
        // Current Address as its own row
        pairs.appendChild(row1('Current Address:', d.cur_add));
        // Show Area (HOA) from registration (read-only); selection comes next
        pairs.appendChild(row1('Area (HOA):', d.hoa || ''));        
      } else {
        // Default: Current Address as its own row
        pairs.appendChild(row1('Current Address:', d.cur_add));
      }

      // For non_member, no Area selection dropdown; Area (HOA) is shown read-only above.

      // HOA details for hoa_member and family_of_member
      if (d.category === 'hoa_member' || d.category === 'family_of_member') {
  if (d.category === 'family_of_member') {
          // For family_of_member, mirror overlapping.html style:
          // Add a blue header outside and a separate light-blue box (pairs) for HOA member info
          if (d.parent_info) {
            const wrapper = document.createElement('div');
            wrapper.style.marginTop = '20px';
            const h3 = document.createElement('h3');
            h3.textContent = 'HOA Member Information';
            h3.style.color = '#083048';
            h3.style.marginBottom = '10px';
            wrapper.appendChild(h3);

            const memberPairs = document.createElement('div');
            memberPairs.className = 'pairs';
            const p = d.parent_info;
            memberPairs.appendChild(row2('Full Name:', p.full_name, 'Date of Birth:', p.date_of_birth, 'text', 'date'));
            memberPairs.appendChild(row2('Sex:', p.sex, 'Citizenship:', p.citizenship));
            memberPairs.appendChild(row2('Age:', p.age, 'Phone Number:', p.phone_number));
            memberPairs.appendChild(row1('Year of Residence:', p.year_of_residence));
            // HOA assignment details under the member info box
            // HOA as single row, then Block/Lot/Lot Size in one row
            memberPairs.appendChild(row1('HOA:', d.hoa || ''));
            memberPairs.appendChild(row3('Block Assignment:', d.blk_num || '', 'Lot Assignment:', d.lot_num || '', 'Lot Size:', d.lot_size || ''));
            // Civil Status and Recipient at the end
            memberPairs.appendChild(row2('Civil Status:', d.civil_status || '', 'Recipient of Other Housing:', d.recipient_of_other_housing || ''));

            wrapper.appendChild(memberPairs);
            memberWrapper = wrapper; // append later after we place the main pairs block
          }
        } else {
          // hoa_member: keep HOA assignment details within the main box, with end fields
          // HOA as single row, then Block/Lot/Lot Size grouped
          pairs.appendChild(row1('HOA:', d.hoa || ''));
          pairs.appendChild(row3('Block Assignment:', d.blk_num || '', 'Lot Assignment:', d.lot_num || '', 'Lot Size:', d.lot_size || ''));
          pairs.appendChild(row2('Civil Status:', d.civil_status || '', 'Recipient of Other Housing:', d.recipient_of_other_housing || ''));
        }
      }

      container.innerHTML = '';
      container.appendChild(pairs);
      if (memberWrapper) {
        container.appendChild(memberWrapper);
      }
    } catch (e) {
      console.warn('Failed to populate lot dispute header:', e);
    }
  });

  // Error pop-up (same helper as overlapping)
  function showErrorPop(msg) {
    const pop = document.getElementById('errorPop');
    const popMsg = document.getElementById('errorPopMsg');
    if (!pop || !popMsg) return;
    popMsg.textContent = msg;
    pop.style.display = 'block';
    pop.style.opacity = '1';
    setTimeout(() => {
      pop.style.opacity = '0';
      setTimeout(() => { pop.style.display = 'none'; }, 400);
    }, 1000);
  }

  // Submit Lot Dispute (match overlapping flow: form submit, no alerts)
  (function(){
    const form = document.getElementById('lotDisputeForm');
    const sigInput = document.getElementById('signatureInput');
    const submitBtn = document.getElementById('submitBtn');
    const sigName = document.getElementById('signatureFileName');

    if (sigInput) {
      sigInput.addEventListener('change', function(){
        if (this.files && this.files[0]) {
          if (sigName) sigName.textContent = this.files[0].name;
          if (submitBtn) submitBtn.style.display = 'inline-block';
        } else {
          if (sigName) sigName.textContent = '';
          if (submitBtn) submitBtn.style.display = 'none';
        }
      });
    }

    if (!form) return;
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const getRadio = (name) => {
        const el = document.querySelector(`input[name="${name}"]:checked`);
        return el ? el.value : '';
      };

      // Handle "Other" augmentations
      let possession = getRadio('possession');
      if (possession === 'Other') {
        const t = document.getElementById('possessionOtherText').value.trim();
        possession = t ? `Other: ${t}` : 'Other';
      }
      let reason = getRadio('reason');
      if (reason === 'Other') {
        const t = document.getElementById('reasonOtherText').value.trim();
        reason = t ? `Other: ${t}` : 'Other';
      }
      let resultVal = getRadio('result');
      if (resultVal === 'Other') {
        const t = document.getElementById('resultOtherText').value.trim();
        resultVal = t ? `Other: ${t}` : 'Other';
      }

      const reportedTo = Array.from(document.querySelectorAll('.reported_to:checked')).map(x => x.value);
      const disputeDate = document.querySelector('input[name="dispute_start_date"]').value;
      const opposingName = document.querySelector('input[name="opposing_name"]').value.trim();
      const relationshipWithPerson = document.querySelector('input[name="relationship_with_person"]').value.trim();
      const legalDocs = getRadio('legal_docs');

      const fd = new FormData();
      fd.append('possession', possession);
      fd.append('conflict', getRadio('conflict'));
      fd.append('dispute_start_date', disputeDate);
      fd.append('reason', reason);
      fd.append('reported_to', JSON.stringify(reportedTo));
      fd.append('result', resultVal);
      fd.append('opposing_name', opposingName);
      fd.append('relationship_with_person', relationshipWithPerson);
      fd.append('legal_docs', legalDocs);
      if (sigInput && sigInput.files[0]) {
        fd.append('signature', sigInput.files[0]);
      }

      // No Area selection; backend derives Area from registration.

      try {
        const res = await fetch('/complainant/lot_dispute/submit_lot_dispute', {
          method: 'POST',
          body: fd,
          credentials: 'include'
        });

        if (res.ok) {
          // Try JSON, otherwise assume success and redirect like overlapping
          try {
            const data = await res.json();
            if (data.success) {
              window.location.href = '/complainant/home/dashboard.html';
              return;
            }
            showErrorPop(data.message || 'Failed to submit.');
          } catch (_) {
            window.location.href = '/complainant/home/dashboard.html';
          }
        } else {
          try {
            const data = await res.json();
            showErrorPop(data.message || 'Error occurred while submitting.');
          } catch (_) {
            const text = await res.text();
            showErrorPop(text || 'Unknown error occurred.');
          }
        }
      } catch (e) {
        showErrorPop('An error occurred while submitting the complaint.');
      }
    });
  })();
</script>
</body>
</html>