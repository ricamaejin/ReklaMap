<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/complainants.css">
</head>
<body>

  <!-- Error Popup -->
  <div id="errorPop" 
    style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);z-index:999;background:#e3f2fd;color:#083048;width:max-content;padding:16px 28px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.12);font-weight:500;min-width:220px;max-width:340px;transition:opacity .2s;">
    <span id="errorPopMsg"></span>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <a href="/complainant/home/dashboard.html" class="nav-item">Home</a>
      <a href="/complainant/complaints/submitted_complaints.html" class="nav-item active">Complaints</a>
    </nav>
  </aside>
  

  <!-- Main Form -->
  <div class="main">
    <div class="form-container">
      <form id="lotDisputeForm">
      <h1 style="text-decoration: underline;">COMPLAINT FORM <br> LOT DISPUTE</h1>
      <div class="instructions">
        <p><strong>INSTRUCTION</strong></p>
        <ul>
          <li>Complete the application form properly and legibly.</li>
          <li>For checkbox items (☑), you may select more than one option if applicable.</li>
          <li>For radio button items (◉), please select only one option.</li>
          <li>If a field or question does not apply to you or you do not know the answer, write “N/A”.</li>
          <li>Ensure all required fields are filled before submitting the form.</li>
        </ul>
      </div>

      <div class="section-header">COMPLAINANT'S DETAILS:</div>
      <div id="complainantDetails"></div>

      <!-- Section 1 -->
      <div class="section-header">LOT DETAILS AND CLAIM:</div>
      <p style="font-weight: bold;">1. How did you come into possession of the lot?</p>
      <label><input type="checkbox" name="possession" value="Assigned by NGCHDP/NHA" required> I was officially assigned the lot by NGCHDP/NHA</label>
      <label><input type="checkbox" name="possession" value="Passed by family member"> The lot was passed on to me by a family member</label>
      <label><input type="checkbox" name="possession" value="Purchased from occupant"> I purchased the lot from another occupant</label>
      <label><input type="checkbox" name="possession" value="Living since NCC project"> I have been living here since the NCC project started</label>
      <label><input type="checkbox" name="possession" value="Relocated after demolition"> I relocated here after demolition/displacement elsewhere</label>
      <label><input type="checkbox" name="possession" value="Verbal promise"> I was verbally promised the lot by a former officer or neighbor</label>
      <label><input type="checkbox" name="possession" value="Not sure" style="margin-bottom: 12px;"> I am not sure / I do not have any official assignment</label>

      <p style="font-weight: bold;">2. What is the nature of the ownership conflict?</p>
      <label><input type="checkbox" name="nature" value="Someone else has a contract"> Someone else has a contract for the same lot</label>
      <label><input type="checkbox" name="nature" value="Someone else claiming lot"> Someone else is claiming my assigned lot</label>
      <label><input type="checkbox" name="nature" value="Assigned different lot"> I was assigned a different lot than what I was told</label>
      <label><input type="checkbox" name="nature" value="Lot not reflected in masterlist"> My lot is not reflected in the masterlist</label>
      <label><input type="checkbox" name="nature" value="Name removed from list"> My name was removed or replaced in the beneficiary list</label>
      <label><input type="checkbox" name="nature" value="Lot illegally sold"> The lot was illegally sold or reassigned to someone else</label>
      <label><input type="checkbox" name="nature" value="Family member claiming"> A family member/relative is claiming the lot I currently occupy</label>
      <label><input type="checkbox" name="nature" value="Lot details incorrect"> My assigned lot details (e.g., lot no., area) are incorrect in the records</label>
      <label><input type="checkbox" name="nature" value="Not sure" style="margin-bottom: 12px;"> I am not sure what caused the dispute</label>
      
      <p style="font-weight: bold;">3. When did the dispute start?</p>
      <input name="dispute_start_date" type="date" title="Dispute start date">

      <p style="font-weight: bold;">4. What led you to raise this complaint?</p>
      <label><input type="checkbox" name="reason" value="Asked to vacate"> I was asked to vacate the lot I’ve been occupying</label>
      <label><input type="checkbox" name="reason" value="Denied access"> I was denied access to a lot I believe was assigned to me</label>
      <label><input type="checkbox" name="reason" value="Received notice"> I received notice that someone else is the rightful owner</label>
      <label><input type="checkbox" name="reason" value="Stopped from building"> I attempted to build on the lot and was stopped</label>
      <label><input type="checkbox" name="reason" value="Discovered duplicate record"> I discovered another person listed in official records for my lot</label>
      <label><input type="checkbox" name="reason" value="Clarification only" style="margin-bottom: 12px;"> I just want clarification about my assigned lot (no direct conflict yet)</label>

      <p style="font-weight: bold;">5. Have you reported this to any authority? <i class="hint">(Check all that apply)</i></p>
      <label><input type="checkbox" class="reported_to" value="Barangay"> Barangay</label>
      <label><input type="checkbox" class="reported_to" value="HOA"> HOA</label>
      <label><input type="checkbox" class="reported_to" value="NGC"> NGC</label>
      <label><input type="checkbox" class="reported_to" value="None" style="margin-bottom: 12px;"> None</label>

      <p style="font-weight: bold;">6. What was the result of that report?</p>
      <label><input type="checkbox" name="result" value="Other party vacate" required> The other party was asked to vacate</label>
      <label><input type="checkbox" name="result" value="Asked for documentation"> The agency asked for more documentation</label>
      <label><input type="checkbox" name="result" value="No action taken"> No action was taken</label>
      <label><input type="checkbox" name="result" value="Under investigation"> The issue is still under investigation</label>
      <label><input type="checkbox" name="result" value="No valid claim"> I was told I have no valid claim</label>
      <label><input type="checkbox" name="result" value="No report made" style="margin-bottom: 12px;"> I did not make any report</label>

      <!-- Section 2 -->
      <div class="section-header">PERSONS INVOLVED DETAILS</div>
      <p style="font-weight: bold;">1. Name of opposing claimant?</p>
      <input type="text" name="opposing_name" placeholder="Enter name">
      <p style="font-weight: bold;">2. Relationship with person involved?</p>
      <input type="text" name="relationship_with_person" placeholder="Relationship to the individual (if applicable)">
      <p style="font-weight: bold;">3. Do they reside on the disputed lot?</p>
      <label><input type="radio" name="reside" value="Yes"> Yes</label>
      <label><input type="radio" name="reside" value="No"> No</label>
      <label><input type="radio" name="reside" value="Not Sure"> Not sure</label>
      <p style="font-weight: bold;">4. Do they claim to have legal documents?</p>
      <div class="options-group" id="claimDocs">
      <label><input type="radio" name="claimDocs" value="Yes"> Yes</label>
        <div id="docOptions" style="display:none; margin-left: 35px;">
          <p style="margin-left: 5px; font-weight: bold;">What documents do they have?</p>
          <label><input type="checkbox" name="docs" value="Certificate of Lot Award (CLA)"> Certificate of Lot Award (CLA)</label>
          <label><input type="checkbox" name="docs" value="Notice of Award"> Notice of Award</label>
          <label><input type="checkbox" name="docs" value="Deed of Assignment / Transfer"> Deed of Assignment / Transfer</label>
          <label><input type="checkbox" name="docs" value="Certification from NGC/NHA/Barangay"> Certification from NGC/NHA/Barangay</label>
          <label><input type="checkbox" name="docs" value="Other supporting paper"> Other supporting paper (e.g., tax receipt, ID copy, etc.)</label>
        </div>
      <label><input type="radio" name="claimDocs" value="No"> No</label>
      <label><input type="radio" name="claimDocs" value="Not sure"> Not sure</label>
    </div>

      <p class="section-label">Please describe what happened briefly, including how you found out about the issue.</p>
      <textarea id="description" name="description" title="Please describe what happened briefly, including how you found out about the issue."></textarea>

      <!-- Section 3 -->
      <div class="section-header">COMPLAINANT’S CONSENT AND DECLARATION</div>
      <div class="consent">
        By submitting this complaint form, I hereby consent to the collection and processing of my personal information as necessary to address the issues raised regarding the lot in question. I confirm that the information provided is accurate and complete to the best of my knowledge. I understand that any false or incomplete information may affect the handling of my complaint, and I acknowledge that my personal details will be processed in compliance with the Privacy Act and other applicable laws.
      </div>

      <div class="signature">
        <input type="file" id="signatureInput" accept="image/*" style="display:none;" />
        <button type="button" class="upload-btn" onclick="document.getElementById('signatureInput').click()">Upload Signature</button>
        <span id="signatureFileName" style="margin-left:10px; font-style:italic;"></span>
        <button type="submit" id="submitBtn" class="btn" style="display:none; margin-top:12px;">Submit Complaint</button>
      </div>
      </form>
    </div>
  </div>


<script>
  // Populate complainant details (same logic)
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const res = await fetch('/complainant/lot_dispute/get_lot_session_data');
      const d = await res.json();
      const container = document.getElementById('complainantDetails');
      if (!container || !d || d.error) return;

      const pairs = document.createElement('div');
      pairs.className = 'pairs';
      let memberWrapper = null;

      function row1(label, value, type = 'text') {
        const r = document.createElement('div');
        r.className = 'pair-row';
        r.innerHTML = `<div class="col"><label class="small">${label}</label><input type="${type}" value="${value || ''}" readonly title="${label}"></div>`;
        return r;
      }
      function row2(l1, v1, l2, v2, t1='text', t2='text') {
        const r = document.createElement('div');
        r.className = 'pair-row';
        r.innerHTML = `
          <div class="col"><label class="small">${l1}</label><input type="${t1}" value="${v1 || ''}" readonly></div>
          <div class="col"><label class="small">${l2}</label><input type="${t2}" value="${v2 || ''}" readonly></div>`;
        return r;
      }
      function row3(l1, v1, l2, v2, l3, v3) {
        const r = document.createElement('div');
        r.className = 'pair-row';
        r.innerHTML = `
          <div class="col"><label class="small">${l1}</label><input type="text" value="${v1 || ''}" readonly></div>
          <div class="col"><label class="small">${l2}</label><input type="text" value="${v2 || ''}" readonly></div>
          <div class="col"><label class="small">${l3}</label><input type="text" value="${v3 || ''}" readonly></div>`;
        return r;
      }

      pairs.appendChild(row1('Full Name:', d.full_name));
      pairs.appendChild(row2('Date of Birth:', d.date_of_birth, 'Sex:', d.sex, 'date', 'text'));
      pairs.appendChild(row2('Citizenship:', d.citizenship, 'Age:', d.age));
      pairs.appendChild(row2('Phone Number:', d.phone_number, 'Year of Residence:', d.year_of_residence));

      if (d.category === 'family_of_member') {
        pairs.appendChild(row2('Relationship:', d.relationship || '', 'Current Address:', d.cur_add));
      } else if (d.category === 'non_member') {
        pairs.appendChild(row2('Civil Status:', d.civil_status || '', 'Recipient of Other Housing:', d.recipient_of_other_housing || ''));
        pairs.appendChild(row1('Current Address:', d.cur_add));
        pairs.appendChild(row1('Area (HOA):', d.hoa || ''));
      } else {
        pairs.appendChild(row1('Current Address:', d.cur_add));
      }

      if (d.category === 'hoa_member' || d.category === 'family_of_member') {
        if (d.category === 'family_of_member') {
          if (d.parent_info) {
            const wrapper = document.createElement('div');
            wrapper.style.marginTop = '20px';
            const h3 = document.createElement('h3');
            h3.textContent = 'HOA Member Information';
            h3.style.color = '#083048';
            h3.style.marginBottom = '10px';
            wrapper.appendChild(h3);

            const memberPairs = document.createElement('div');
            memberPairs.className = 'pairs';
            const p = d.parent_info;
            memberPairs.appendChild(row2('Full Name:', p.full_name, 'Date of Birth:', p.date_of_birth, 'text', 'date'));
            memberPairs.appendChild(row2('Sex:', p.sex, 'Citizenship:', p.citizenship));
            memberPairs.appendChild(row2('Age:', p.age, 'Phone Number:', p.phone_number));
            memberPairs.appendChild(row1('Year of Residence:', p.year_of_residence));
            memberPairs.appendChild(row1('HOA:', d.hoa || ''));
            memberPairs.appendChild(row3('Block Assignment:', d.blk_num || '', 'Lot Assignment:', d.lot_num || '', 'Lot Size:', d.lot_size || ''));
            memberPairs.appendChild(row2('Civil Status:', d.civil_status || '', 'Recipient of Other Housing:', d.recipient_of_other_housing || ''));

            wrapper.appendChild(memberPairs);
            memberWrapper = wrapper;
          }
        } else {
          pairs.appendChild(row1('HOA:', d.hoa || ''));
          pairs.appendChild(row3('Block Assignment:', d.blk_num || '', 'Lot Assignment:', d.lot_num || '', 'Lot Size:', d.lot_size || ''));
          pairs.appendChild(row2('Civil Status:', d.civil_status || '', 'Recipient of Other Housing:', d.recipient_of_other_housing || ''));
        }
      }

      container.innerHTML = '';
      container.appendChild(pairs);
      if (memberWrapper) container.appendChild(memberWrapper);
    } catch (e) {
      console.warn('Failed to populate lot dispute header:', e);
    }
  });

  // Error pop-up
  function showErrorPop(msg) {
    const pop = document.getElementById('errorPop');
    const popMsg = document.getElementById('errorPopMsg');
    if (!pop || !popMsg) return;
    popMsg.textContent = msg;
    pop.style.display = 'block';
    pop.style.opacity = '1';
    setTimeout(() => {
      pop.style.opacity = '0';
      setTimeout(() => { pop.style.display = 'none'; }, 400);
    }, 1000);
  }

  // Submit handler (cleaned)
  (function(){
    const form = document.getElementById('lotDisputeForm');
    const sigInput = document.getElementById('signatureInput');
    const submitBtn = document.getElementById('submitBtn');
    const sigName = document.getElementById('signatureFileName');

    if (sigInput) {
      sigInput.addEventListener('change', function(){
        if (this.files && this.files[0]) {
          if (sigName) sigName.textContent = this.files[0].name;
          if (submitBtn) submitBtn.style.display = 'inline-block';
        } else {
          if (sigName) sigName.textContent = '';
          if (submitBtn) submitBtn.style.display = 'none';
        }
      });
    }

    if (!form) return;
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const getRadio = (name) => {
        const el = document.querySelector(`input[name="${name}"]:checked`);
        return el ? el.value : '';
      };

      const fd = new FormData();
      fd.append('possession', getRadio('possession'));
      fd.append('conflict', getRadio('conflict'));
      fd.append('dispute_start_date', document.querySelector('input[name="dispute_start_date"]').value);
      fd.append('reason', getRadio('reason'));
      fd.append('reported_to', JSON.stringify(Array.from(document.querySelectorAll('.reported_to:checked')).map(x => x.value)));
      fd.append('result', getRadio('result'));
      fd.append('opposing_name', document.querySelector('input[name="opposing_name"]').value.trim());
      fd.append('relationship_with_person', document.querySelector('input[name="relationship_with_person"]').value.trim());
      fd.append('legal_docs', getRadio('legal_docs'));
      fd.append('description', (document.getElementById('description')?.value || '').trim());
      if (sigInput && sigInput.files[0]) fd.append('signature', sigInput.files[0]);

      try {
        const res = await fetch('/complainant/lot_dispute/submit_lot_dispute', {
          method: 'POST',
          body: fd,
          credentials: 'include'
        });

        if (res.ok) {
          const data = await res.json().catch(() => ({}));
          if (data.success) window.location.href = '/complainant/home/dashboard.html';
          else showErrorPop(data.message || 'Failed to submit.');
        } else {
          const data = await res.json().catch(() => ({}));
          showErrorPop(data.message || 'Error occurred while submitting.');
        }
      } catch {
        showErrorPop('An error occurred while submitting the complaint.');
      }
    });
  })();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("lotDisputeForm");
  const claimDocsRadios = form.querySelectorAll("input[name='claimDocs']");
  const docOptions = document.getElementById("docOptions");

  // Show/hide document options when "Yes" is selected
  claimDocsRadios.forEach(radio => {
    radio.addEventListener("change", () => {
      docOptions.style.display = (radio.value === "Yes" && radio.checked) ? "block" : "none";
    });
  });

  // Validate form before submit
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Basic required validation
    const requiredGroups = [
      "possession", "nature", "result"
    ];
    for (let name of requiredGroups) {
      const inputs = form.querySelectorAll(`[name='${name}']`);
      const isChecked = Array.from(inputs).some(input => input.checked);
      if (!isChecked) {
        alert("Please answer all required questions before submitting.");
        return;
      }
    }

    try {
      const formData = new FormData(form);
      const res = await fetch("/complainant/submit_lot_dispute", {
        method: "POST",
        body: formData,
        credentials: "include"
      });

      const data = await res.json();
      if (res.ok && data.success) {
        window.location.href = "/complainant/home/dashboard.html";
      } else {
        alert(data.message || "Failed to submit the complaint.");
      }
    } catch (err) {
      alert("An error occurred while submitting the complaint.");
    }
  });
});
</script>
</body>
</html>
