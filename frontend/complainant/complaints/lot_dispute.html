<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/complainants.css">
  <style>
    /* Grey out autofilled (read-only) complainant detail fields */
    #complainantDetails .pairs input[readonly] {
      color: #555 !important; /* grey text */
      background: #f1f3f5 !important; /* subtle grey background */
    }
    #complainantDetails .pairs input[readonly]::placeholder { color: #888; }
  </style>
</head>
<body>

  <!-- Error Popup -->
  <div id="errorPop" 
    style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);z-index:999;background:#e3f2fd;color:#083048;width:max-content;padding:16px 28px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.12);font-weight:500;min-width:220px;max-width:340px;transition:opacity .2s;">
    <span id="errorPopMsg"></span>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <a href="/complainant/home/dashboard.html" class="nav-item">Home</a>
      <a href="/complainant/complaints/submitted_complaints.html" class="nav-item active">Complaints</a>
    </nav>
  </aside>
  

  <!-- Main Form -->
  <div class="main">
    <div class="form-container">
      <form id="lotDisputeForm">
      <h1 style="text-decoration: underline;">COMPLAINT FORM <br> LOT DISPUTE</h1>
      <div class="instructions">
        <p><strong>INSTRUCTION</strong></p>
        <ul>
          <li>Complete the application form properly and legibly.</li>
          <li>For checkbox items (☑), you may select more than one option if applicable.</li>
          <li>For radio button items (◉), please select only one option.</li>
          <li>If a field or question does not apply to you or you do not know the answer, write “N/A”.</li>
          <li>Ensure all required fields are filled before submitting the form.</li>
        </ul>
      </div>

      <div class="section-header">COMPLAINANT'S DETAILS:</div>
      <div id="complainantDetails"></div>

      <!-- Section 1 -->
      <div class="section-header">LOT DETAILS AND CLAIM:</div>
      <!-- Non-member only: Block/Lot pairs involved in the dispute (excluding theirs) -->
      <div id="nonMemberBlockLotSection" style="display:none;">
  <p style="font-weight:bold;">What is the specific block and lot involved in the lot dispute?</p>
        <div class="pairs" id="pairsContainer" aria-live="polite">
          <!-- rows will be added here -->
        </div>
      </div>
      <p style="font-weight: bold;">1. How did you come into possession of the lot?</p>
      <label><input type="radio" name="possession" value="Official assignment by NGCHDP/NHA"> I was officially assigned the lot by NGCHDP/NHA</label>
      <label><input type="radio" name="possession" value="Passed on by a family member"> The lot was passed on to me by a family member</label>
      <label><input type="radio" name="possession" value="Purchased from another occupant"> I purchased the lot from another occupant</label>
      <label><input type="radio" name="possession" value="Living since project started"> I have been living here since the NCC project started</label>
      <label><input type="radio" name="possession" value="Relocated after demolition/displacement"> I relocated here after demolition/displacement elsewhere</label>
      <label><input type="radio" name="possession" value="Verbal promise by former officer/neighbor" style="margin-bottom: 12px;"> I was verbally promised the lot by a former officer or neighbor</label>

      <p style="font-weight: bold;">2. What is the nature of the ownership conflict? <i class="hint">(Check all that apply)</i></p>
      <label><input type="checkbox" name="nature" value="Someone else has a contract"> Someone else has a contract for the same lot</label>
      <label><input type="checkbox" name="nature" value="Someone else claiming lot"> Someone else is claiming my assigned lot</label>
      <label><input type="checkbox" name="nature" value="Assigned different lot"> I was assigned a different lot than what I was told</label>
      <label><input type="checkbox" name="nature" value="Lot not reflected in masterlist"> My lot is not reflected in the masterlist</label>
      <label><input type="checkbox" name="nature" value="Name removed from list"> My name was removed or replaced in the beneficiary list</label>
      <label><input type="checkbox" name="nature" value="Lot illegally sold"> The lot was illegally sold or reassigned to someone else</label>
      <label><input type="checkbox" name="nature" value="Family member claiming"> A family member/relative is claiming the lot I currently occupy</label>
      <label><input type="checkbox" name="nature" value="Lot details incorrect"> My assigned lot details (e.g., lot no., area) are incorrect in the records</label>
      <label><input type="checkbox" name="nature" value="Not sure" style="margin-bottom: 12px;"> I am not sure what caused the dispute</label>
      
      <p style="font-weight: bold;">3. When did the dispute start?</p>
      <input name="dispute_start_date" type="date" title="Dispute start date" 
      style="width: 20%; padding: 8px; margin-top: 6px; margin-left: 18px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">

      <p style="font-weight: bold;">4. What led you to raise this complaint? <i class="hint">(Check all that apply)</i></p>
      <label><input type="checkbox" name="reason" value="Asked to vacate"> I was asked to vacate the lot I’ve been occupying</label>
      <label><input type="checkbox" name="reason" value="Denied access"> I was denied access to a lot I believe was assigned to me</label>
      <label><input type="checkbox" name="reason" value="Received notice"> I received notice that someone else is the rightful owner</label>
      <label><input type="checkbox" name="reason" value="Stopped from building"> I attempted to build on the lot and was stopped</label>
      <label><input type="checkbox" name="reason" value="Discovered duplicate record"> I discovered another person listed in official records for my lot</label>
      <label><input type="checkbox" name="reason" value="Clarification only" style="margin-bottom: 12px;"> I just want clarification about my assigned lot (no direct conflict yet)</label>

      <label><strong>5. Have you reported this boundary issue to any office or authority?</strong></label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="Barangay"> Barangay</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="HOA"> HOA</label>
  <label><input type="checkbox" name="boundary_reported_to[]" value="NGC"> NGC</label>
  <label><input type="checkbox" name="boundary_reported_to[]" value="USAD - PHASELAD"> USAD - PHASELAD</label>
  <label><input type="checkbox" name="boundary_reported_to[]" value="None"> None</label>

      <label><strong>6. What was the result of the report or inspection?</strong> <i style="font-size: 14px; font-weight: normal; color: grey;">(Check all that apply)</i></label>
      <label><input type="checkbox" name="site_result[]" value="Advised to adjust or vacate"> The other party was advised to adjust or vacate</label>
      <label><input type="checkbox" name="site_result[]" value="Asked to provide more documents"> I was advised to provide more documents</label>
      <label><input type="checkbox" name="site_result[]" value="Still under investigation"> The issue is still under investigation</label>
      <label><input type="checkbox" name="site_result[]" value="No valid claim"> I was told I have no valid claim</label>
      <label><input type="checkbox" name="site_result[]" value="No action taken"> No action was taken</label>
      <label><input type="checkbox" name="site_result[]" value="Not applicable"> Not applicable / No inspection yet</label>

      <!-- Section 2 -->
      <div class="section-header">PERSONS INVOLVED DETAILS</div>
      <p style="font-weight: bold;">1. Name of opposing claimant?</p>
      <div id="opposingNameContainer">
        <div class="opposing-name-input" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
          <input type="text" name="opposing_name[]" placeholder="Enter name" style="flex: 1; margin-left: 15px;">
        </div>
      </div>
      <!-- Removed multi-add for opposing claimant -->

      <p style="font-weight: bold;">2. Relationship with person involved?</p>
      <div id="relationshipContainer">
        <div class="relationship-input" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
          <input type="text" name="relationship_with_person[]" placeholder="Relationship to the individual (neighbor, relative, etc.)" style="flex: 1; margin-left: 15px;">
        </div>
      </div>
      <!-- Removed multi-add for relationship -->
      <p style="font-weight: bold;">3. Do they reside on the disputed lot?</p>
      <label><input type="radio" name="reside" value="Yes"> Yes</label>
      <label><input type="radio" name="reside" value="No"> No</label>
      <label><input type="radio" name="reside" value="Not Sure"> Not sure</label>
      <p style="font-weight: bold;">4. Do they claim to have legal documents?</p>
      <div class="options-group" id="claimDocs">
      <label><input type="radio" name="claimDocs" value="Yes"> Yes</label>
        <div id="docOptions" style="display:none; margin-left: 35px;">
          <p style="margin-left: 5px; font-weight: bold;">What documents do they have?</p>
          <label><input type="checkbox" name="docs" value="Title"> Title</label>
          <label><input type="checkbox" name="docs" value="Contract to Sell"> Contract to Sell</label>
          <label><input type="checkbox" name="docs" value="Certificate of Full Payment"> Certificate of Full Payment</label>
          <label><input type="checkbox" name="docs" value="Pre-qualification Stub"> Pre-qualification Stub</label>
          <label><input type="checkbox" name="docs" value="Contract/Agreement"> Contract/Agreement</label>
          <label><input type="checkbox" name="docs" value="Deed of Sale"> Deed of Sale</label>
        </div>
      <label><input type="radio" name="claimDocs" value="No"> No</label>
      <label><input type="radio" name="claimDocs" value="Not Sure"> Not sure</label>
    </div>

      <p class="section-label" style="color: black;">Please describe what happened briefly, including how you found out about the issue.</p>
      <textarea id="description" name="description" title="Please describe what happened briefly, including how you found out about the issue."></textarea>

      <!-- Section 3 -->
      <div class="section-header">COMPLAINANT’S CONSENT AND DECLARATION</div>
      <div class="consent">
        By submitting this complaint form, I hereby consent to the collection and processing of my personal information as necessary to address the issues raised regarding the lot in question. I confirm that the information provided is accurate and complete to the best of my knowledge. I understand that any false or incomplete information may affect the handling of my complaint, and I acknowledge that my personal details will be processed in compliance with the Privacy Act and other applicable laws.
      </div>

      <div class="signature">
        <input type="file" id="signatureInput" accept="image/*" style="display:none;" />
        <button type="button" class="upload-btn" onclick="document.getElementById('signatureInput').click()">Upload Signature</button>
        <span id="signatureFileName" style="margin-left:10px; font-style:italic;"></span>
        <button type="submit" id="submitBtn" class="btn" style="display:none; margin-top:12px;">Submit Complaint</button>
      </div>
      </form>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const container = document.getElementById('complainantDetails');
  if(!container) return;

  // --- Helper Functions ---
  function row1(label, value, type='text') {
    const r = document.createElement('div');
    r.className = 'pair-row';
    r.innerHTML = `<div class="col"><label class="small">${label}</label><input type="${type}" value="${value || ''}" readonly></div>`;
    return r;
  }

  function row2(l1,v1,l2,v2,t1='text',t2='text'){
    const r=document.createElement('div');
    r.className='pair-row';
    r.innerHTML=`
      <div class="col"><label class="small">${l1}</label><input type="${t1}" value="${v1||''}" readonly></div>
      <div class="col"><label class="small">${l2}</label><input type="${t2}" value="${v2||''}" readonly></div>`;
    return r;
  }

  function row3(l1,v1,l2,v2,l3,v3){
    const r=document.createElement('div');
    r.className='pair-row';
    r.innerHTML=`
      <div class="col"><label class="small">${l1}</label><input type="text" value="${v1||''}" readonly></div>
      <div class="col"><label class="small">${l2}</label><input type="text" value="${v2||''}" readonly></div>
      <div class="col"><label class="small">${l3}</label><input type="text" value="${v3||''}" readonly></div>`;
    return r;
  }

  function normalizeName(name){
    if(!name || typeof name!=='string') return name||'';
    return name.replace(/\b([A-Z])\.*\b/g,'$1.');
  }

  function createSupportingDocsSection(docs, category){
    if(!docs || (!Array.isArray(docs) && typeof docs!=='object')) return null;
    const docDiv = document.createElement('div');
    docDiv.style.margin='8px 0 16px 0';
    const labelText = category==='family_of_member' ? 
      'What Supporting Documents does your Family Member have?' : 
      'What Supporting Documents do you have?';
    docDiv.innerHTML=`<label style="font-weight:600; display:block; margin-bottom:2px;">${labelText}</label>`;

    const docList = [
      {key:'title',label:'Title'},
      {key:'contract_to_sell',label:'Contract to Sell'},
      {key:'certificate_of_full_payment',label:'Certificate of Full Payment'},
      {key:'pre_qualification_stub',label:'Pre-qualification Stub'},
      {key:'contract_agreement',label:'Contract/Agreement'},
      {key:'deed_of_sale',label:'Deed of Sale'}
    ];

    let selected={};
    if(Array.isArray(docs)) docs.forEach(k=>selected[k]=true);
    else if(typeof docs==='object') selected=docs;

    let group=`<div class='checkbox-group' style="display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:6px 16px;">`;
    docList.forEach(doc=>{
      const checked = selected[doc.key]? 'checked':'';
      group+=`<label style="white-space:nowrap;"><input type="checkbox" disabled ${checked}> ${doc.label}</label>`;
    });
    group+='</div>';
    docDiv.innerHTML+=group;
    return docDiv;
  }

  function showErrorPop(msg) {
    const pop = document.getElementById('errorPop');
    const popMsg = document.getElementById('errorPopMsg');
    if(!pop || !popMsg) return;
    popMsg.textContent = msg;
    pop.style.display='block';
    pop.style.opacity='1';
    setTimeout(()=>{
      pop.style.opacity='0';
      setTimeout(()=>{pop.style.display='none';},400);
    },1000);
  }

  try{
    const res = await fetch('/complainant/boundary_dispute/get_boundary_session_data', {credentials:'same-origin'});
    if(!res.ok) throw new Error('Failed to fetch session data');
    const d = await res.json();
    if(!d || d.error) throw new Error(d?.error || 'No data returned');

    const pairs = document.createElement('div');
    pairs.className='pairs';
    const cat = d.category;
    let memberWrapper = null;

    // --- Basic info ---
    pairs.appendChild(row1('Full Name:', normalizeName(d.full_name)));
    // Format date_of_birth as 'Month Day, Year' if possible
    let dob = d.date_of_birth;
    if (dob && typeof dob === 'string' && dob.match(/\d{4}-\d{2}-\d{2}/)) {
      const dt = new Date(dob);
      dob = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    } else if (dob && typeof dob === 'string' && dob.match(/\w{3},/)) {
      // Try to parse RFC date string
      const dt = new Date(dob);
      if (!isNaN(dt)) dob = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }
    pairs.appendChild(row2('Date of Birth:', dob, 'Age:', d.age));
    pairs.appendChild(row2('Sex:', d.sex,'Citizenship:', d.citizenship));
    pairs.appendChild(row3('Current Address:', d.cur_add,'Year of Residence:', d.year_of_residence,'Phone Number:', d.phone_number));

    if(cat!=='family_of_member'){
      pairs.appendChild(row1('Area (HOA):', d.hoa||''));
      pairs.appendChild(row2('Civil Status:', d.civil_status||'','Recipient of Other Housing:', d.recipient_of_other_housing||''));
      if(cat==='hoa_member'){
        pairs.appendChild(row3('Block Assignment:', d.blk_num || '', 'Lot Assignment:', d.lot_num || '', 'Lot Size:', d.lot_size || ''));
        const docSection = createSupportingDocsSection(d.supporting_documents, cat);
        if(docSection) pairs.appendChild(docSection);
      }
      if(cat==='non_member'){
        let connVal='';
        if(Array.isArray(d.connections)) connVal=d.connections.join(', ');
        else if(typeof d.connections==='string') connVal=d.connections;
        else if(d.connections) connVal=String(d.connections);
        const connRow = document.createElement('div');
        connRow.className='pair-row';
        connRow.innerHTML=`<div class="col" style="width:100%"><label class="small">How are you connected to the lot you are complaining about?</label><input type="text" value="${connVal}" readonly></div>`;
        pairs.appendChild(connRow);
      }
    }

    // --- family_of_member HOA MEMBER INFORMATION ---
    if(cat==='family_of_member' && d.parent_info){
      const wrapper = document.createElement('div');
      wrapper.style.marginTop='20px';
      const sectionHeader = document.createElement('div');
      sectionHeader.className='section-header';
      sectionHeader.textContent='HOA MEMBER INFORMATION';
      wrapper.appendChild(sectionHeader);

      const memberPairs = document.createElement('div');
      memberPairs.className='pairs';
      const p = d.parent_info;

      memberPairs.appendChild(row1('Full Name:', normalizeName(p.full_name)));
      // Format parent date_of_birth as 'Month Day, Year' if possible
      let pdob = p.date_of_birth;
      if (pdob && typeof pdob === 'string' && pdob.match(/\d{4}-\d{2}-\d{2}/)) {
        const dt = new Date(pdob);
        pdob = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      } else if (pdob && typeof pdob === 'string' && pdob.match(/\w{3},/)) {
        // Try to parse RFC date string
        const dt = new Date(pdob);
        if (!isNaN(dt)) pdob = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      }
      memberPairs.appendChild(row2('Date of Birth:', pdob, 'Age:', p.age));
      memberPairs.appendChild(row2('Sex:', p.sex, 'Citizenship:', p.citizenship));
      memberPairs.appendChild(row2('Current Address:', p.current_address, 'Year of Residence:', p.year_of_residence || ''));

      // Use top-level `d` for overridden fields
      memberPairs.appendChild(row1('Area (HOA):', d.hoa || ''));
      memberPairs.appendChild(row3(
        'Block Assignment:', d.blk_num || '',
        'Lot Assignment:', d.lot_num || '',
        'Lot Size:', d.lot_size || ''
      ));
      memberPairs.appendChild(row3(
        'Civil Status:', d.civil_status || '',
        'Recipient of Other Housing:', d.recipient_of_other_housing || '',
        'Relationship:', d.relationship || ''
      ));

      // Supporting documents at the very bottom
      const docSection = createSupportingDocsSection(p.supporting_documents || d.supporting_documents, 'family_of_member');
      if(docSection) memberPairs.appendChild(docSection);

      wrapper.appendChild(memberPairs);
      memberWrapper = wrapper;
    }

    container.innerHTML='';
    container.appendChild(pairs);
    if(memberWrapper) container.appendChild(memberWrapper);

  }catch(e){
    console.warn('Failed to populate boundary dispute header:', e);
    showErrorPop('Failed to load your details. Please refresh the page.');
  }

});
</script>



<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("lotDisputeForm");
  if (!form) return;
  const claimDocsRadios = form.querySelectorAll("input[name='claimDocs']");
  const docOptions = document.getElementById("docOptions");

  // Guard missing optional container
  if (claimDocsRadios.length && docOptions) {
    // Show/hide document options when "Yes" is selected
    claimDocsRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        docOptions.style.display = (radio.value === "Yes" && radio.checked) ? "block" : "none";
      });
    });
  }

  // Setup add/remove for "Name of opposing claimant" section
  // Multi-add for opposing claimant removed; single input retained.

  // Setup add/remove for "Relationship with person involved" section
  // Multi-add for relationship removed; single input retained.
});
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form');
  if (!form) return;

  // 🔧 Function that makes “None” exclusive per group
  function setupExclusiveNone(checkboxes) {
    if (!checkboxes || checkboxes.length === 0) return;
    const noneCheckbox = Array.from(checkboxes).find(cb => cb.value.toLowerCase() === 'none');
    const otherCheckboxes = Array.from(checkboxes).filter(cb => cb !== noneCheckbox);
    if (!noneCheckbox) return;

    // When "None" is checked → disable all others
    noneCheckbox.addEventListener('change', () => {
      if (noneCheckbox.checked) {
        otherCheckboxes.forEach(cb => {
          cb.checked = false;
          cb.disabled = true;
          cb.closest('label')?.classList.add('disabled');
        });
      } else {
        otherCheckboxes.forEach(cb => {
          cb.disabled = false;
          cb.closest('label')?.classList.remove('disabled');
        });
      }
    });

    // When any other is checked → uncheck "None"
    otherCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        if (cb.checked) {
          noneCheckbox.checked = false;
          noneCheckbox.disabled = false;
          noneCheckbox.closest('label')?.classList.remove('disabled');
        }
      });
    });
  }

  // ✅ Apply to Question 5 only
  const q5Checkboxes = Array.from(form.querySelectorAll('input[name="boundary_reported_to[]"]'));
  setupExclusiveNone(q5Checkboxes);

  // Optional: subtle styling for disabled ones
  const style = document.createElement('style');
  style.textContent = `
    label.disabled { opacity: 0.6; cursor: not-allowed; }
    label.disabled input { cursor: not-allowed; }
  `;
  document.head.appendChild(style);
});
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
  const q9Checkboxes = document.querySelectorAll('input[name="site_result[]"]');
  if (q9Checkboxes.length === 0) return;

  const notApplicable = Array.from(q9Checkboxes).find(
    cb => (cb.value || "").toLowerCase().includes("not applicable")
  );
  const others = Array.from(q9Checkboxes).filter(cb => cb !== notApplicable);

  if (!notApplicable) return;

  // Initial state check
  if (notApplicable.checked) {
    others.forEach(cb => {
      cb.checked = false;
      cb.disabled = true;
      cb.closest("label")?.classList.add("disabled");
    });
  }

  // When Not Applicable is toggled
  notApplicable.addEventListener("change", () => {
    if (notApplicable.checked) {
      others.forEach(cb => {
        cb.checked = false;
        cb.disabled = true;
        cb.closest("label")?.classList.add("disabled");
      });
    } else {
      others.forEach(cb => {
        cb.disabled = false;
        cb.closest("label")?.classList.remove("disabled");
      });
    }
  });

  // If others are checked, uncheck Not Applicable
  others.forEach(cb => {
    cb.addEventListener("change", () => {
      if (cb.checked) {
        notApplicable.checked = false;
        notApplicable.disabled = false;
        notApplicable.closest("label")?.classList.remove("disabled");
      }
    });
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('lotDisputeForm');
  const submitBtn = document.getElementById('submitBtn');
  const sigInput = document.getElementById('signatureInput');
  const sigName = document.getElementById('signatureFileName');

  if (!form || !submitBtn) return;

  // --- Helper to show blue popup errors ---
  function showErrorPop(msg) {
    const pop = document.getElementById('errorPop');
    const popMsg = document.getElementById('errorPopMsg');
    if (!pop || !popMsg) return;
    popMsg.textContent = msg;
    pop.style.display = 'block';
    pop.style.opacity = '1';
    setTimeout(() => {
      pop.style.opacity = '0';
      setTimeout(() => { pop.style.display = 'none'; }, 400);
    }, 1000);
  }

  // --- Enable submit button when signature is uploaded ---
  if (sigInput) {
    sigInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        if (sigName) sigName.textContent = this.files[0].name;
        submitBtn.style.display = 'inline-block';
        submitBtn.disabled = false;
      } else {
        if (sigName) sigName.textContent = '';
        submitBtn.style.display = 'none';
        submitBtn.disabled = true;
      }
    });
  }

  // --- Form submission ---
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    if (submitBtn) submitBtn.disabled = true;

    try {
      const fd = new FormData(form);

      // Gather dynamic block/lot pairs for non-members (if any)
      const pairsContainer = document.getElementById('pairsContainer');
      if (pairsContainer) {
        const rows = Array.from(pairsContainer.querySelectorAll('.pair-row'));
        const blockLotData = rows.map(row => {
          const block = row.querySelector('input[name="block_no[]"]')?.value.trim() || '';
          const lot = row.querySelector('input[name="lot_no[]"]')?.value.trim() || '';
          return { block, lot };
        }).filter(r => r.block || r.lot);
        if (blockLotData.length) fd.append('block_lot', JSON.stringify(blockLotData));
      }

      // Submit via fetch to lot dispute endpoint
      const res = await fetch('/complainant/lot_dispute/submit_lot_dispute', {
        method: 'POST',
        body: fd,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      let data;
      try { data = await res.json(); } catch { data = {}; }

      if (data.success) {
        // Success: redirect to dashboard
        window.location.href = '/complainant/home/dashboard.html';
      } else {
        // Failure: show popup or alert
        if (data.field === 'block_lot' && data.message) {
          showErrorPop(data.message);
        } else if (data.errors) {
          showErrorPop(Array.isArray(data.errors) ? data.errors.join('\n') : data.errors);
        } else {
          showErrorPop(data.message || 'Submission failed.');
        }
        if (submitBtn) submitBtn.disabled = false;
      }

    } catch (err) {
      showErrorPop('An error occurred during submission. Please try again.');
      if (submitBtn) submitBtn.disabled = false;
    }
  });
});
</script>

</body>
</html>
