<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/complainants.css">
  <link rel="stylesheet" href="/css/modal_shared.css">
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <a href="/complainant/home/dashboard.html" class="nav-item">Home</a>
      <a href="/complainant/complaints/submitted_complaints.html" class="nav-item active">Complaints</a>
    </nav>
  </aside>
  

  <!-- Main Form -->
  <div class="main">
    <div class="form-container">
  <form  id="BoundaryDisputeForm" enctype="multipart/form-data">
      <h1 style="text-decoration: underline;">COMPLAINT FORM <br> BOUNDARY DISPUTE</h1>
      <div class="instructions">
        <p><strong>INSTRUCTION</strong></p>
        <ul>
          <li>Complete the application form properly and legibly.</li>
          <li>For checkbox items (☑), you may select more than one option if applicable.</li>
          <li>For radio button items (◉), please select only one option.</li>
          <li>If a field or question does not apply to you or you do not know the answer, write “N/A” (Not Applicable).</li>
          <li>Ensure all required fields are filled before submitting the form.</li>
        </ul>
      </div>

  <div class="section-header">COMPLAINANT'S DETAILS:</div>
  <div id="complainantDetails"></div>

<!-- CSS for complainant details (keep at top, before scripts) -->
<style>
  /* Grey out autofilled (read-only) complainant detail fields, match lot_dispute.html */
  #complainantDetails .pairs input[readonly] {
    color: #555 !important;
    background: #f1f3f5 !important;
  }
  #complainantDetails .pairs input[readonly]::placeholder { color: #888; }
  #complainantDetails .pair-row { display: flex; gap: 16px; margin-bottom: 8px; }
  #complainantDetails .col { flex: 1; min-width: 120px; }
  #complainantDetails label.small { font-size: 13px; color: #333; margin-bottom: 2px; display: block; }
</style>

  <!-- Modal popup for error messages (shared styles) -->
  <div id="errorModalBackdrop" class="rk-modal-backdrop" aria-hidden="true">
    <div class="rk-modal" role="dialog" aria-modal="true" aria-labelledby="errorModalTitle">
      <div class="rk-modal-header">
        <div class="rk-modal-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" fill="#1a33a0" opacity="0.12"/><path d="M11 16h2v-2h-2v2zm0-8h2v6h-2V8z" fill="#1a33a0"/></svg>
        </div>
        <p class="rk-modal-title" id="errorModalTitle">Notice</p>
      </div>
      <div class="rk-modal-body" id="errorPopMsg"></div>
      <div class="rk-modal-actions">
        <button type="button" id="errorPopClose" class="rk-btn-ghost">Close</button>
      </div>
    </div>
  </div>

      <!-- Section 1 -->
      <div class="section-header">LOT DETAILS AND CLAIM:</div>
      <!-- Non-member only: Block/Lot pairs involved in the dispute (excluding theirs) -->
      <div id="nonMemberBlockLotSection" style="display:none; margin-bottom: 18px;">
        <p style="font-weight:bold;">Please indicate your Block and Lot number.</p>
        <div class="pairs" id="blockLotPairsContainer" aria-live="polite">
          <div class="pair-row">
            <div class="col">
              <label class="small">Block No.</label>
              <input type="text" name="block_no[]" placeholder="Block No.">
            </div>
            <div class="col">
              <label class="small">Lot No.</label>
              <input type="text" name="lot_no[]" placeholder="Lot No.">
            </div>
          </div>
        </div>
      </div>
  <p><strong>1. What is the nature of the boundary issue? </strong> <i style="font-size: 14px; font-weight: normal; color: grey;">(Check all that apply)</i></p>
  <label><input type="checkbox" name="nature_of_issue" value="Neighbor structure extends beyond line"> A neighbor’s house or structure extends beyond their boundary line</label>
  <label><input type="checkbox" name="nature_of_issue" value="Fence overlaps into my property"> A fence or wall installed by the neighbor overlaps into my property</label>
  <label><input type="checkbox" name="nature_of_issue" value="Construction within my claimed boundary"> Construction is ongoing within my claimed boundary</label>
  <label><input type="checkbox" name="nature_of_issue" value="Shared boundary demolished"> Shared boundary structure (wall/fence) was demolished without consent</label>
  <label><input type="checkbox" name="nature_of_issue" value="Boundary markers moved"> Boundary markers (mohon) were moved or removed</label>
  <label><input type="checkbox" name="nature_of_issue" value="Neighbor expanded structure beyond assigned area"> The neighbor expanded their structure beyond their assigned area</label>
  <label><input type="checkbox" name="nature_of_issue" style="margin-bottom: 12px;" value="Encroachment affects utilities"> Encroachment is affecting access to utilities (e.g., water, drainage, electricity)</label>


      <p><strong>2. How long has this encroachment existed?</strong></p>
  <label><input type="radio" name="conflict" value="Less than 1 month"> Less than 1 month</label>
  <label><input type="radio" name="conflict" value="1-6 months"> 1-6 months</label>
  <label><input type="radio" name="conflict" value="More than 6 months"> More than 6 months</label>
  <label><input type="radio" name="conflict" value="Not sure" style="margin-bottom: 12px;"> Not sure</label>

  <p><strong>3. Has the encroaching structure already been built or is it under construction?</strong></p>
  <label><input type="radio" name="structure_status" value="Fully constructed"> Fully constructed</label>
  <label><input type="radio" name="structure_status" value="Partially constructed"> Partially constructed</label>
  <label><input type="radio" name="structure_status" value="Ongoing construction"> Ongoing construction</label>
  <label><input type="radio" name="structure_status" value="Structure was removed but boundary still contested" style="margin-bottom: 12px;"> Structure was removed but boundary still contested</label>
      

  <p><strong>4. Were you given any prior notice before the structure crossed into your property?</strong></p>
  <label><input type="radio" name="notice" value="Yes"> Yes</label>
  <label><input type="radio" name="notice" value="No" style="margin-bottom: 12px;"> No</label>
      
      <p> <strong>5. Have you discussed or confronted the other party about the boundary issue?</strong></p>
      <label><input type="radio" name="confronted" value="yes" id="reasonYes"> Yes</label>
      <div id="reasonDetails" style="display: none; margin-left: 22px;">
        <p><strong>Date Reported</strong></p>
        <input id="reasonDateInput" name="reasonDateInput" type="date" style="width: 20%; padding: 8px; margin-top: 6px; margin-left: 18px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"/>
      </div>
      <label><input type="radio" name="confronted" value="no"> No</label>

  <p><strong>6. Has the dispute led to any of the following? </strong><i style="font-size: 14px; font-weight: normal; color: grey;">(Check all that apply)</i></p>
  <label><input type="checkbox" name="dispute_effects" value="Threats or harassment"> Threats or harassment</label>
  <label><input type="checkbox" name="dispute_effects" value="Physical altercation"> Physical altercation</label>
  <label><input type="checkbox" name="dispute_effects" value="Demolition or forced entry"> Demolition or forced entry</label>
  <label><input type="checkbox" name="dispute_effects" value="Property damage"> Property damage</label>
  <label><input type="checkbox" name="dispute_effects" style="margin-bottom: 12px;" value="None"> None</label>

      <label><strong>7. Have you reported this boundary issue to any office or authority?</strong> <i style="font-size: 14px; font-weight: normal; color: grey;">(Check all that apply)</i></label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="Barangay"> Barangay</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="HOA"> HOA</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="NGC"> NGC</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="NGC"> USAD - PHASELAD</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="none"> None</label>

      <label><strong>8. Was there any site inspection or verification conducted?</strong></label>
      <label><input type="radio" name="site_inspection" value="Yes - Barangay" required> Yes – by Barangay</label>
      <label><input type="radio" name="site_inspection" value="Yes - HOA"> Yes – by HOA</label>
      <label><input type="radio" name="site_inspection" value="Yes - NGC"> Yes – by NGC</label>
      <label><input type="radio" name="site_inspection" value="Yes - NGC"> Yes – by USAD - PHASELAD</label>
      <label><input type="radio" name="site_inspection" value="No"> No</label>
      <label><input type="radio" name="site_inspection" value="Not sure"> Not sure</label>

      <label><strong>9. What was the result of the report or inspection?</strong> <i style="font-size: 14px; font-weight: normal; color: grey;">(Check all that apply)</i></label>
      <label><input type="checkbox" name="site_result[]" value="Advised to adjust or vacate"> The other party was advised to adjust or vacate</label>
      <label><input type="checkbox" name="site_result[]" value="Asked to provide more documents"> I was advised to provide more documents</label>
      <label><input type="checkbox" name="site_result[]" value="Still under investigation"> The issue is still under investigation</label>
      <label><input type="checkbox" name="site_result[]" value="No valid claim"> I was told I have no valid claim</label>
      <label><input type="checkbox" name="site_result[]" value="No action taken"> No action was taken</label>
      <label><input type="checkbox" name="site_result[]" value="Not applicable"> Not applicable / No inspection yet</label>

      <label><strong>10. Do you have any documents or proof showing your boundary or property line?</strong></label>
      <label><input type="radio" name="have_docs" value="Yes" required> Yes</label>
        <div id="boundaryDocOptions" style="display:none; margin-left: 15px;">
          <p><strong>Please specify:</strong> <i style="font-size: 14px; font-weight: normal; color: grey;">(Check all that apply)</i></p>
          <label><input type="checkbox" name="boundary_docs[]" value="Subdivision or site survey map"> Subdivision or site survey map</label>
          <label><input type="checkbox" name="boundary_docs[]" value="Certificate of Lot Award (CLA)"> Title</label>
          <label><input type="checkbox" name="boundary_docs[]" value="Approved fence or building plan"> Building permit</label>
          <label><input type="checkbox" name="boundary_docs[]" value="Barangay certification or inspection report"> Barangay certification or inspection report</label>
          <label><input type="checkbox" name="boundary_docs[]" value="Photographs showing boundary markers or encroachment"> Photographs showing boundary markers or encroachment</label>
        </div>
      <label><input type="radio" name="have_docs" value="No"> No</label>

  <p><strong>11. Is there an ongoing development or government housing project in the area?</strong></p>
  <label><input type="radio" name="reason" value="Yes"> Yes</label>
  <label><input type="radio" name="reason" value="No"> No</label>
  <label><input type="radio" name="reason" value="Not sure" style="margin-bottom: 12px;"> Not sure</label>

      <!-- Section 2 -->
      <div class="section-header">PERSONS INVOLVED DETAILS</div>
      <p><strong>1. Who are the persons and specific block and lot numbers involved in the boundary dispute?</strong> 
        <i style="font-size: 14px; font-weight: normal; color: grey;">(Excluding yours)</i>
      </p>

      <div class="pairs" id="pairsContainer" aria-live="polite" style="background-color: #f8fbff; border-radius: 6px; padding: 12px;">
        <div class="pair-row" style="display: flex; gap: 12px; align-items: center; margin-bottom: 10px;">
          <div style="flex: 1;">
            <label for="personName_0">Name of Person</label>
            <input type="text" id="personName_0" name="q12[0][name]" placeholder="Enter name" class="form-control" required />
          </div>
          <div style="width: 140px;">
            <label for="blockNo_0">Block No.</label>
            <input type="text" id="blockNo_0" name="q12[0][block]" placeholder="Block No." class="form-control" required />
          </div>
          <div style="width: 140px;">
            <label for="lotNo_0">Lot No.</label>
            <input type="text" id="lotNo_0" name="q12[0][lot]" placeholder="Lot No." class="form-control" required />
          </div>
          <button type="button" class="btn remove small" style="margin-top: 24px; color: #999;">Remove</button>
        </div>
      </div>

      <div class="pair-controls" style="margin-top: 10px;">
        <button type="button" class="btn add small" id="addPairBtn" style="margin-bottom: 8px;">+ Add</button>
        <span style="color: var(--muted); font-size: 13px; margin-left: 8px;">
          <i style="font-size: 14px; font-weight: normal; color: grey;">
            (If more than one person or area is affected, list all applicable entries.)
          </i>
        </span>
      </div>

      <label><strong>2. Relationship with the person involved:</strong></label>
      <div id="relationshipContainer">
        <div class="relationship-input" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
          <input type="text" name="boundary_relationship" placeholder="Specify relationship (neighbor, relative, etc.)" style="flex: 1; margin-left: 15px;">
        </div>
      </div>
      <button type="button" class="btn add small" id="addRelationshipBtn" style="margin-left: 15px; margin-bottom: 12px;">+ Add another relationship</button>

      <label><strong>3. Do they reside on or near the disputed boundary?</strong></label>
      <div class="options-group">
        <label><input type="radio" name="boundary_reside" value="Yes"> Yes</label>
        <label><input type="radio" name="boundary_reside" value="No"> No</label>
        <label><input type="radio" name="boundary_reside" value="Not sure"> Not sure</label>
      </div>

      <label><strong>4. Do they claim to have legal or assignment documents?</strong></label>
      <div class="options-group" id="claimDocs">
        <label><input type="radio" name="claimDocs" value="Yes"> Yes</label>
        <div id="docOptions" style="display:none; margin-left: 35px;">
          <p style="margin-left: 5px; font-weight: bold;">What documents do they have?</p>
          <label><input type="checkbox" name="docs" value="Title"> Title</label>
          <label><input type="checkbox" name="docs" value="Contract to Sell"> Contract to Sell</label>
          <label><input type="checkbox" name="docs" value="Certificate of Full Payment"> Certificate of Full Payment</label>
          <label><input type="checkbox" name="docs" value="Pre-qualification Stub"> Pre-qualification Stub</label>
          <label><input type="checkbox" name="docs" value="Contract/Agreement"> Contract/Agreement</label>
          <label><input type="checkbox" name="docs" value="Deed of Sale"> Deed of Sale</label>
        </div>
        <label><input type="radio" name="claimDocs" value="No"> No</label>
      </div>

      <!-- Section 3 -->
  <p class="section-label" style="color: #222;">Please describe what happened briefly, including how you found out about the issue.</p>
  <textarea name="description"></textarea>

        <div class="section-header">COMPLAINANT’S CONSENT AND DECLARATION</div>
        <div class="consent">
          By submitting this complaint form, I hereby consent to the collection and processing of my personal information as necessary to address the issues raised regarding the lot in question. I confirm that the information provided is accurate and complete to the best of my knowledge. I understand that any false or incomplete information may affect the handling of my complaint, and I acknowledge that my personal details will be processed in compliance with the Privacy Act and other applicable laws.
        </div>
        <div class="signature">
          <input type="file" id="signatureInput" name="signature_path" accept="image/*" style="display:none;" />
          <button type="button" class="upload-btn" onclick="document.getElementById('signatureInput').click()">Upload Signature</button>
          <span id="signatureFileName" style="margin-left:10px; font-style:italic;"></span>
          <button type="submit" id="submitBtn" class="btn" style="display:none; margin-top:12px;">Submit Complaint</button>
        </div>

<script>
// Unified modal show/hide using shared modal markup
function showErrorPop(msg) {
  const backdrop = document.getElementById('errorModalBackdrop');
  const popMsg = document.getElementById('errorPopMsg');
  if (!popMsg) return;
  popMsg.textContent = msg;

  if (backdrop) {
    backdrop.style.display = 'flex';
    backdrop.classList.add('show');
    backdrop.setAttribute('aria-hidden', 'false');

    const closeBtn = document.getElementById('errorPopClose');
    const onClose = (e) => { e && e.preventDefault(); hideErrorPop(); };
    const onBackdropClick = (ev) => { if (ev.target === backdrop) hideErrorPop(); };
    const onKeydown = (ev) => { if (ev.key === 'Escape') hideErrorPop(); };

    if (closeBtn) closeBtn.addEventListener('click', onClose);
    backdrop.addEventListener('click', onBackdropClick);
    document.addEventListener('keydown', onKeydown);

    backdrop._errHandlers = { onClose, onBackdropClick, onKeydown, closeBtn };
    return;
  }

  // fallback: transient popup (if present)
  const transientPop = document.getElementById('errorPop');
  if (transientPop) {
    transientPop.style.display = 'block';
    transientPop.style.opacity = '1';
    setTimeout(() => {
      transientPop.style.opacity = '0';
      setTimeout(() => { transientPop.style.display = 'none'; }, 400);
    }, 1000);
  }
}

function hideErrorPop(){
  const backdrop = document.getElementById('errorModalBackdrop');
  if (!backdrop) return;
  backdrop.style.display = 'none';
  backdrop.classList.remove('show');
  backdrop.setAttribute('aria-hidden', 'true');
  const h = backdrop._errHandlers;
  if (h) {
    if (h.closeBtn) h.closeBtn.removeEventListener('click', h.onClose);
    backdrop.removeEventListener('click', h.onBackdropClick);
    document.removeEventListener('keydown', h.onKeydown);
    delete backdrop._errHandlers;
  }
}

// Close button and click-outside handling
document.addEventListener('click', function(e){
  const backdrop = document.getElementById('errorModalBackdrop');
  if (!backdrop) return;
  const modal = backdrop.querySelector('.rk-modal');
  if (backdrop.classList.contains('show') && !modal.contains(e.target)) {
    hideErrorPop();
  }
});
document.addEventListener('DOMContentLoaded', function(){
  const closeBtn = document.getElementById('errorPopClose');
  if (closeBtn) closeBtn.addEventListener('click', hideErrorPop);
});
// Signature file name display and submit button logic (EXACTLY match lot_dispute.html)
document.addEventListener('DOMContentLoaded', () => {
  // Show/hide docOptions when Yes/No is selected for claimDocs
  const claimDocsYes = document.querySelector('input[name="claimDocs"][value="Yes"]');
  const claimDocsNo = document.querySelector('input[name="claimDocs"][value="No"]');
  const docOptions = document.getElementById('docOptions');
  function toggleDocOptions() {
    if (claimDocsYes && claimDocsYes.checked) {
      if (docOptions) docOptions.style.display = '';
    } else {
      if (docOptions) docOptions.style.display = 'none';
    }
  }
  if (claimDocsYes && claimDocsNo && docOptions) {
    claimDocsYes.addEventListener('change', toggleDocOptions);
    claimDocsNo.addEventListener('change', toggleDocOptions);
    // Initialize on load
    toggleDocOptions();
  }
  // Show/hide boundaryDocOptions when Yes/No is selected for have_docs
  const haveDocsYes = document.querySelector('input[name="have_docs"][value="Yes"]');
  const haveDocsNo = document.querySelector('input[name="have_docs"][value="No"]');
  const boundaryDocOptions = document.getElementById('boundaryDocOptions');
  function toggleBoundaryDocOptions() {
    if (haveDocsYes && haveDocsYes.checked) {
      if (boundaryDocOptions) boundaryDocOptions.style.display = '';
    } else {
      if (boundaryDocOptions) boundaryDocOptions.style.display = 'none';
    }
  }
  if (haveDocsYes && haveDocsNo && boundaryDocOptions) {
    haveDocsYes.addEventListener('change', toggleBoundaryDocOptions);
    haveDocsNo.addEventListener('change', toggleBoundaryDocOptions);
    // Initialize on load
    toggleBoundaryDocOptions();
  }
  const sigInput = document.getElementById('signatureInput');
  const sigName = document.getElementById('signatureFileName');
  const submitBtn = document.getElementById('submitBtn');
  if (sigInput) {
    sigInput.addEventListener('change', function(){
      if (this.files && this.files[0]) {
        if (sigName) sigName.textContent = this.files[0].name;
        if (submitBtn) submitBtn.style.display = 'inline-block';
      } else {
        if (sigName) sigName.textContent = '';
        if (submitBtn) submitBtn.style.display = 'none';
      }
    });
  }

  // Show/hide additional question for 'Have you discussed or confronted the other party...'
  const reasonYes = document.getElementById('reasonYes');
  const reasonNo = document.querySelector('input[name="confronted"][value="no"]');
  const reasonDetails = document.getElementById('reasonDetails');
  function toggleReasonDetails() {
    if (reasonYes && reasonYes.checked) {
      if (reasonDetails) reasonDetails.style.display = '';
    } else {
      if (reasonDetails) reasonDetails.style.display = 'none';
    }
  }
  if (reasonYes && reasonNo && reasonDetails) {
    reasonYes.addEventListener('change', toggleReasonDetails);
    reasonNo.addEventListener('change', toggleReasonDetails);
    // Initialize on load
    toggleReasonDetails();
  }
});

document.addEventListener('DOMContentLoaded', async () => {
  const form = document.getElementById('BoundaryDisputeForm');
  const container = document.getElementById('complainantDetails');

  if (!form || !container) return;

    // NOTE: Do not check active-complaint on page load. The active-complaint
    // verification will be performed when the user clicks Submit so the
    // notice only appears at submit time.

  // --- Helper functions ---

  // Helper to format date as 'Month Day, Year'
  function formatDateMDY(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    const opts = { month: 'long', day: 'numeric', year: 'numeric' };
    return d.toLocaleDateString('en-US', opts);
  }

  function row1(label, value, type='text', isDate=false) {
    const displayValue = isDate ? formatDateMDY(value) : value;
    const r = document.createElement('div');
    r.className = 'pair-row';
    r.innerHTML = `<div class="col"><label class="small">${label}</label><input type="${type}" value="${displayValue || ''}" readonly></div>`;
    return r;
  }

  function row2(l1, v1, l2, v2, t1='text', t2='text', isDate1=false, isDate2=false) {
    const displayV1 = isDate1 ? formatDateMDY(v1) : v1;
    const displayV2 = isDate2 ? formatDateMDY(v2) : v2;
    const r = document.createElement('div');
    r.className = 'pair-row';
    r.innerHTML = `
      <div class="col"><label class="small">${l1}</label><input type="${t1}" value="${displayV1 || ''}" readonly></div>
      <div class="col"><label class="small">${l2}</label><input type="${t2}" value="${displayV2 || ''}" readonly></div>`;
    return r;
  }

  function row3(l1, v1, l2, v2, l3, v3) {
    const r = document.createElement('div');
    r.className = 'pair-row';
    r.innerHTML = `
      <div class="col"><label class="small">${l1}</label><input type="text" value="${v1 || ''}" readonly></div>
      <div class="col"><label class="small">${l2}</label><input type="text" value="${v2 || ''}" readonly></div>
      <div class="col"><label class="small">${l3}</label><input type="text" value="${v3 || ''}" readonly></div>`;
    return r;
  }

  function normalizeName(name) {
    if (!name || typeof name !== 'string') return name || '';
    return name.replace(/\b([A-Z])\.*\b/g, '$1.');
  }

  function createSupportingDocsSection(docs, category) {
    if (!docs || (!Array.isArray(docs) && typeof docs !== 'object')) return null;
    const docDiv = document.createElement('div');
    docDiv.style.margin = '8px 0 16px 0';
    const labelText = category === 'family_of_member'
      ? 'What Supporting Documents does your Family Member have?'
      : 'What Supporting Documents do you have?';
    docDiv.innerHTML = `<label style="font-weight:600; display:block; margin-bottom:2px;">${labelText}</label>`;

    const docList = [
      {key: 'title', label: 'Title'},
      {key: 'contract_to_sell', label: 'Contract to Sell'},
      {key: 'certificate_of_full_payment', label: 'Certificate of Full Payment'},
      {key: 'pre_qualification_stub', label: 'Pre-qualification Stub'},
      {key: 'contract_agreement', label: 'Contract/Agreement'},
      {key: 'deed_of_sale', label: 'Deed of Sale'}
    ];

    let selected = {};
    if (Array.isArray(docs)) docs.forEach(k => selected[k] = true);
    else if (typeof docs === 'object') selected = docs;

    let group = `<div class='checkbox-group' style="display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:6px 16px;">`;
    docList.forEach(doc => {
      const checked = selected[doc.key] ? 'checked' : '';
      group += `<label style="white-space:nowrap;"><input type="checkbox" disabled ${checked}> ${doc.label}</label>`;
    });
    group += '</div>';
    docDiv.innerHTML += group;
    return docDiv;
  }

  // --- Fetch complainant session data ---
  try {
    const res = await fetch('/complainant/boundary_dispute/get_boundary_session_data', { credentials: 'same-origin' });
    if (!res.ok) return;
    const d = await res.json();
    if (!d || d.error) return;

    const pairs = document.createElement('div');
    pairs.className = 'pairs';
    const cat = d.category;
    let memberWrapper = null;


    // Basic info
    pairs.appendChild(row1('Full Name:', normalizeName(d.full_name)));

    if (cat === 'family_of_member') {
      pairs.appendChild(row2('Date of Birth:', d.date_of_birth, 'Age:', d.age, 'text', 'text', true, false));
      pairs.appendChild(row2('Sex:', d.sex, 'Citizenship:', d.citizenship));
      pairs.appendChild(row3('Current Address:', d.cur_add, 'Year of Residence:', d.year_of_residence, 'Phone Number:', d.phone_number));
    } else {
      pairs.appendChild(row2('Date of Birth:', d.date_of_birth, 'Age:', d.age, 'text', 'text', true, false));
      pairs.appendChild(row2('Sex:', d.sex, 'Citizenship:', d.citizenship));
      pairs.appendChild(row3('Current Address:', d.cur_add, 'Year of Residence:', d.year_of_residence, 'Phone Number:', d.phone_number));
      pairs.appendChild(row1('Area (HOA):', d.hoa || '', 'text'));
      pairs.appendChild(row2('Civil Status:', d.civil_status || '', 'Recipient of Other Housing:', d.recipient_of_other_housing || ''));

      // Supporting documents for HOA members only
      if (cat === 'hoa_member') {
        pairs.appendChild(row3('Block Assignment:', d.blk_num || '', 'Lot Assignment:', d.lot_num || '', 'Lot Size:', d.lot_size || ''));
        const docSection = createSupportingDocsSection(d.supporting_documents, cat);
        if (docSection) pairs.appendChild(docSection);
      }

      // Connection info for non-members
      if (cat === 'non_member') {
        const connRow = document.createElement('div');
        connRow.className = 'pair-row';
        connRow.innerHTML = `<div class="col" style="width:100%"><label class="small">How are you connected to the lot you are complaining about?</label><input type="text" value="${d.connections || ''}" readonly></div>`;
        pairs.appendChild(connRow);
      }
    }

    // Family of member parent info
    if (cat === 'family_of_member' && d.parent_info) {
      const wrapper = document.createElement('div');
      wrapper.style.marginTop = '20px';
      const sectionHeader = document.createElement('div');
      sectionHeader.className = 'section-header';
      sectionHeader.textContent = 'HOA MEMBER INFORMATION';
      wrapper.appendChild(sectionHeader);

      const memberPairs = document.createElement('div');
      memberPairs.className = 'pairs';
      const p = d.parent_info;


  memberPairs.appendChild(row1('Full Name:', normalizeName(p.full_name)));
  memberPairs.appendChild(row2('Date of Birth:', p.date_of_birth, 'Age:', p.age, 'text', 'text', true, false));
  memberPairs.appendChild(row2('Sex:', p.sex, 'Citizenship:', p.citizenship));
  memberPairs.appendChild(row2('Current Address:', p.current_address, 'Year of Residence:', p.year_of_residence || ''));
  memberPairs.appendChild(row1('Area (HOA):', p.hoa || '', 'text'));
  memberPairs.appendChild(row3('Block Assignment:', p.blk_num || '', 'Lot Assignment:', p.lot_num || '', 'Lot Size:', p.lot_size || ''));
  memberPairs.appendChild(row3('Civil Status:', p.civil_status || '', 'Recipient of Other Housing:', p.recipient_of_other_housing || '', 'Relationship:', d.relationship || ''));

      const docSection = createSupportingDocsSection(p.supporting_documents, 'family_of_member');
      if (docSection) memberPairs.appendChild(docSection);

      wrapper.appendChild(memberPairs);
      memberWrapper = wrapper;
    } else if (cat === 'family_of_member' && !d.parent_info) {
      const warn = document.createElement('div');
      warn.style.color='red'; warn.style.fontWeight='bold'; warn.style.margin='16px 0';
      warn.textContent = 'HOA MEMBER INFORMATION is missing (no parent_info in session data).';
      pairs.appendChild(warn);
    }

    container.innerHTML = '';
    container.appendChild(pairs);
    if (memberWrapper) container.appendChild(memberWrapper);

  } catch (e) {
    console.error('Error fetching complainant data:', e);
  }
});

// Q6/Q7/Q9 exclusive checkbox logic and disabled label styling
document.addEventListener('DOMContentLoaded', () => {
  function isQ7Header(el) {
    if (!el) return false;
    const t = (el.textContent || '').trim();
    if (/^7\./.test(t)) return true;
    if (/Have you reported/i.test(t)) return true;
    const strong = el.querySelector && el.querySelector('strong');
    if (strong && /^\s*7\./.test((strong.textContent || '').trim())) return true;
    return false;
  }

  function collectCheckboxesBetween(startEl, stopCond) {
    const boxes = [];
    let el = startEl.nextElementSibling;
    while (el) {
      if (stopCond(el)) break;
      if (el.querySelector) {
        const inputs = Array.from(el.querySelectorAll('input[type="checkbox"]'));
        inputs.forEach(i => boxes.push(i));
      }
      el = el.nextElementSibling;
    }
    return boxes;
  }

  function setupExclusiveNoneForList(checkboxList) {
    if (!checkboxList || checkboxList.length === 0) return;
    // find the group's "None" checkbox by value or by label text
    const none = checkboxList.find(cb => {
      if (!cb) return false;
      const v = (cb.value || '').trim().toLowerCase();
      if (v === 'none') return true;
      const lbl = cb.closest && cb.closest('label');
      return lbl && /\bnone\b/i.test(lbl.textContent || '');
    });
    if (!none) return;
    const others = checkboxList.filter(cb => cb !== none);

    // initialize state (handles prechecked)
    if (none.checked) {
      others.forEach(cb => { cb.checked = false; cb.disabled = true; cb.closest('label')?.classList.add('disabled'); });
    } else {
      others.forEach(cb => { cb.disabled = false; cb.closest('label')?.classList.remove('disabled'); });
    }

    // When None toggles
    none.addEventListener('change', () => {
      if (none.checked) {
        others.forEach(cb => { cb.checked = false; cb.disabled = true; cb.closest('label')?.classList.add('disabled'); });
      } else {
        others.forEach(cb => { cb.disabled = false; cb.closest('label')?.classList.remove('disabled'); });
      }
    });

    // When any other is checked, ensure None is unchecked (and enabled)
    others.forEach(cb => {
      cb.addEventListener('change', () => {
        if (cb.checked) {
          none.checked = false;
          none.disabled = false;
          none.closest('label')?.classList.remove('disabled');
        }
      });
    });
  }

  // --- Q6: collect checkboxes between Q6 header and Q7 header ---
  // Helper to find Q6 start (the <p> with Q6 label)
  function findQ6Start() {
    const ps = Array.from(document.querySelectorAll('p'));
    return ps.find(p => /6\./.test(p.textContent || ''));
  }
  const q6Start = findQ6Start();
  const q6Checkboxes = q6Start ? collectCheckboxesBetween(q6Start, isQ7Header) : [];
  setupExclusiveNoneForList(q6Checkboxes);

  // --- Q7: by name attribute ---
  const form = document.getElementById('BoundaryDisputeForm') || document;
  const q7Checkboxes = Array.from(form.querySelectorAll('input[name="boundary_reported_to[]"][type="checkbox"]'));
  setupExclusiveNoneForList(q7Checkboxes);

  // --- small CSS hint for disabled labels (visual cue) ---
  const style = document.createElement('style');
  style.textContent = `
    label.disabled { opacity: 0.6; }
    label.disabled input { cursor: not-allowed; }
  `;
  document.head.appendChild(style);
});

// Q9 exclusive logic (Not applicable disables others)
document.addEventListener("DOMContentLoaded", () => {
  const q9Checkboxes = document.querySelectorAll('input[name="site_result[]"]');
  if (q9Checkboxes.length === 0) return;

  const notApplicable = Array.from(q9Checkboxes).find(
    cb => (cb.value || "").toLowerCase().includes("not applicable")
  );
  const others = Array.from(q9Checkboxes).filter(cb => cb !== notApplicable);

  if (!notApplicable) return;

  // Initial state check
  if (notApplicable.checked) {
    others.forEach(cb => {
      cb.checked = false;
      cb.disabled = true;
      cb.closest("label")?.classList.add("disabled");
    });
  }

  // When Not Applicable is toggled
  notApplicable.addEventListener("change", () => {
    if (notApplicable.checked) {
      others.forEach(cb => {
        cb.checked = false;
        cb.disabled = true;
        cb.closest("label")?.classList.add("disabled");
      });
    } else {
      others.forEach(cb => {
        cb.disabled = false;
        cb.closest("label")?.classList.remove("disabled");
      });
    }
  });

  // If others are checked, uncheck Not Applicable
  others.forEach(cb => {
    cb.addEventListener("change", () => {
      if (cb.checked) {
        notApplicable.checked = false;
        notApplicable.disabled = false;
        notApplicable.closest("label")?.classList.remove("disabled");
      }
    });
  });
});

// Q12 dynamic row logic for persons involved
document.addEventListener('DOMContentLoaded', function() {
  // --- Persons Involved (q12) ---
  const pairsContainer = document.getElementById('pairsContainer');
  const addPairBtn = document.getElementById('addPairBtn');
  if (pairsContainer && addPairBtn) {
    function getNextIndex() {
      // Find the highest index currently in use
      const rows = pairsContainer.querySelectorAll('.pair-row');
      let maxIdx = -1;
      rows.forEach(row => {
        const input = row.querySelector('input[name^="q12["]');
        if (input) {
          const match = input.name.match(/^q12\[(\d+)\]/);
          if (match) {
            const idx = parseInt(match[1], 10);
            if (idx > maxIdx) maxIdx = idx;
          }
        }
      });
      return maxIdx + 1;
    }

    function createPairRow(idx) {
      const row = document.createElement('div');
      row.className = 'pair-row';
      row.style.display = 'flex';
      row.style.gap = '12px';
      row.style.alignItems = 'center';
      row.style.marginBottom = '10px';
      row.innerHTML = `
        <div style="flex: 1;">
          <label for="personName_${idx}">Name of Person</label>
          <input type="text" id="personName_${idx}" name="q12[${idx}][name]" placeholder="Enter name" class="form-control" required />
        </div>
        <div style="width: 140px;">
          <label for="blockNo_${idx}">Block No.</label>
          <input type="text" id="blockNo_${idx}" name="q12[${idx}][block]" placeholder="Block No." class="form-control" required />
        </div>
        <div style="width: 140px;">
          <label for="lotNo_${idx}">Lot No.</label>
          <input type="text" id="lotNo_${idx}" name="q12[${idx}][lot]" placeholder="Lot No." class="form-control" required />
        </div>
        <button type="button" class="btn remove small" style="margin-top: 24px; color: #999;">Remove</button>
      `;
      // Attach remove handler
      row.querySelector('.remove').addEventListener('click', function() {
        // Only remove if more than one row remains
        if (pairsContainer.querySelectorAll('.pair-row').length > 1) {
          row.remove();
        } else {
          showErrorPop('At least one entry is required.');
        }
      });
      return row;
    }

    // Attach remove handler to initial row
    const initialRow = pairsContainer.querySelector('.pair-row');
    if (initialRow) {
      const removeBtn = initialRow.querySelector('.remove');
      if (removeBtn) {
        removeBtn.addEventListener('click', function() {
          if (pairsContainer.querySelectorAll('.pair-row').length > 1) {
            initialRow.remove();
          } else {
            showErrorPop('At least one entry is required.');
          }
        });
      }
    }

    addPairBtn.addEventListener('click', function() {
      const idx = getNextIndex();
      const newRow = createPairRow(idx);
      pairsContainer.appendChild(newRow);
    });
  }

  // --- Relationship dynamic add ---
  const relationshipContainer = document.getElementById('relationshipContainer');
  const addRelationshipBtn = document.getElementById('addRelationshipBtn');
  if (relationshipContainer && addRelationshipBtn) {
    addRelationshipBtn.addEventListener('click', function() {
      const relDiv = document.createElement('div');
      relDiv.className = 'relationship-input';
      relDiv.style.display = 'flex';
      relDiv.style.gap = '8px';
      relDiv.style.alignItems = 'center';
      relDiv.style.marginBottom = '8px';
      relDiv.innerHTML = `
        <input type="text" name="boundary_relationship" placeholder="Specify relationship (neighbor, relative, etc.)" style="flex: 1; margin-left: 15px;">
        <button type="button" class="btn remove small" style="color: #999;">Remove</button>
      `;
      relDiv.querySelector('.remove').addEventListener('click', function() {
        relDiv.remove();
      });
      relationshipContainer.appendChild(relDiv);
    });
  }
});
</script>

<script>
// (old inline popup removed) unified modal functions above are used instead

// AJAX submit for boundary dispute form, redirect to dashboard on success
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('BoundaryDisputeForm') || document.querySelector('form');
  if (!form) return;
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) submitBtn.disabled = true;

    // Active-complaint check at submit time
    try {
      const activeRes = await fetch('/complainant/has-active-complaint', { credentials: 'same-origin' });
      if (activeRes && activeRes.ok) {
        const activeJson = await activeRes.json();
        if (activeJson && activeJson.has_active) {
          showErrorPop('You have an active complaint that is not yet resolved. Please wait until it is completed before filing a new one.');
          if (submitBtn) submitBtn.disabled = false;
          return; // abort submission
        }
      }
    } catch (err) {
      // Couldn't verify active status; re-enable and continue
      if (submitBtn) submitBtn.disabled = false;
      console.warn('Could not verify active complaint status:', err);
      if (submitBtn) submitBtn.disabled = true;
    }

    const formData = new FormData(form);
    try {
      const res = await fetch('/complainant/boundary_dispute/submit_boundary_dispute', {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      let data;
      try { data = await res.json(); } catch { data = {}; }
      if (data.success) {
        window.location.href = '/complainant/home/dashboard.html';
      } else {
        if (data.field === 'q12' && data.message) {
          showErrorPop(data.message);
        } else if (data.q12_errors) {
          showErrorPop(Array.isArray(data.q12_errors) ? data.q12_errors.join('\n') : data.q12_errors);
        } else {
          alert(data.message || 'Submission failed.');
        }
        if (submitBtn) submitBtn.disabled = false;
      }
    } catch (err) {
      showErrorPop('Submission failed. Please try again.');
      if (submitBtn) submitBtn.disabled = false;
    }
  });
});
</script>

<script>
// Show/hide non-member block/lot section (static, no dynamic rows)
document.addEventListener('DOMContentLoaded', function() {
  fetch('/complainant/boundary_dispute/get_boundary_session_data').then(r => r.json()).then(d => {
    if (d && d.category === 'non_member') {
      document.getElementById('nonMemberBlockLotSection').style.display = '';
    }
  });
});
</script>

</body>
</html>