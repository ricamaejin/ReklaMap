<!DOCTYPE html>
<html lang="en">
<head>
  <style>
    /* Grey out autofilled (read-only) complainant detail fields */
    #complainantDetails .pairs input[readonly] {
      color: #555 !important; /* grey text */
      background: #f1f3f5 !important; /* subtle grey background */
    }
    #complainantDetails .pairs input[readonly]::placeholder { color: #888; }
    label.disabled {
      opacity: 1;
      color: #555 !important;
      cursor: not-allowed;
    }
    label.disabled input {
      cursor: not-allowed;
    }
  </style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/complainants.css">

  <style>
    /* Visually gray out disabled checkboxes and their labels */
    .checkbox-disabled {
      color: #9c9c9c !important;
      cursor: not-allowed !important;
    }
    input[type="checkbox"]:disabled {
      background: #eee !important;
      cursor: not-allowed !important;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <a href="/complainant/home/dashboard.html" class="nav-item">Home</a>
      <a href="/complainant/complaints/submitted_complaints.html" class="nav-item active">Complaints</a>
    </nav>
  </aside>
  

  <!-- Main Form -->
  <div class="main">
    <div class="form-container">
      <h1 style="text-decoration: underline;">COMPLAINT FORM <br> UNAUTHORIZED OCCUPATION</h1>
      <div class="instructions">
        <p><strong>INSTRUCTION</strong></p>
        <ul>
          <li>Complete the application form properly and legibly.</li>
          <li>For checkbox items (☑), you may select more than one option if applicable.</li>
          <li>For radio button items (◉), please select only one option.</li>
          <li>If a field or question does not apply to you or you do not know the answer, write “N/A” (Not Applicable).</li>
          <li>Ensure all required fields are filled before submitting the form.</li>
        </ul>
      </div>

      <div class="section-header">COMPLAINANT'S DETAILS:</div>
      <div id="complainantDetails"></div>

      <!-- Section 1 -->
      <div class="section-header">LOT DETAILS AND CLAIM:</div>

      <p style="font-weight: bold;">1. What is your legal connection to this property?</p>
      <label><input type="radio" name="legal_connection" value="beneficiary"> I am an awarded beneficiary.</label>
      <label><input type="radio" name="legal_connection" value="heir"> I am an heir/successor-in-interest of the deceased registered owner.</label>
      <label><input type="radio" name="legal_connection" value="purchaser"> I am the purchaser/buyer with a signed Deed of Sale or Contract to Sell.</label>
      <label><input type="radio" name="legal_connection" value="lessee"> I am a lessee/tenant with a valid and current lease agreement.</label>
      <label><input type="radio" name="legal_connection" value="hoa_officer"> I am a public Officer reporting on a common area</label>
      <label><input type="radio" name="legal_connection" value="representative" style="margin-bottom: 12px;"> I am an authorized representative representative of the owner/beneficiary</label>

      <p style="font-weight: bold;">2. Who is currently occupying the lot?</p>
      <div id="involvedPersonsContainer">
        <div class="person-input">
          <input type="text" class="involved_person_name" name="involved_person_name[]" placeholder="Enter name">
        </div>
      </div>
      <button type="button" class="btn add small" id="addPersonBtn" style="margin-left: 15px; margin-bottom: 12px;">+ Add another person</button>

      <p style="font-weight: bold;">3.  When did you first notice the unauthorized occupation?</p>
      <input style="width: 20%; padding: 8px;  margin-left: 15px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;" type="date">

      <p style="font-weight: bold;">4. What activities are being done on the property? <i style="font-size: 14px; font-weight: normal; color: grey;">(Check all that apply)</i></p>
      <label><input type="checkbox" name="activities" value="living"> Living/residing on the lot</label>
      <label><input type="checkbox" name="activities" value="built_structure"> Built a structure (house, shack, etc.)</label>
      <label><input type="checkbox" name="activities" value="fenced"> Fenced or enclosed the area</label>
      <label><input type="checkbox" name="activities" value="storing"> Storing personal belongings</label>
      <label><input type="checkbox" name="activities" value="utilities"> Connected utilities (water, electricity)</label>          
      <label><input type="checkbox" style="margin-bottom: 12px;"> Renting it out to someone else</label>

      <p style="font-weight: bold;">5. Have they claimed legal rights over the lot?</p>
      <label><input type="radio" name="occupant_claim" value="docs" id="occupant_claim_docs"> Yes, they presented documents</label>
      <div id="reasonDetails" style="display: none; margin-left: 22px;">
        <p style="font-weight: bold; margin-left: 15px;">Which documents do they have? <i style="font-size: 14px; font-weight: normal; color: grey;">(Check all that apply)</i></p>
        <label><input type="checkbox" name="occupant_documents[]" value="title" style="margin-left: 33px;"> Title</label>
        <label><input type="checkbox" name="occupant_documents[]" value="contract_to_sell" style="margin-left: 33px;"> Contract to Sell</label>
        <label><input type="checkbox" name="occupant_documents[]" value="certificate_full_payment" style="margin-left: 33px;"> Certificate of Full Payment</label>
        <label><input type="checkbox" name="occupant_documents[]" value="qualification_stub" style="margin-left: 33px;"> Pre-qualification Stub</label>
        <label><input type="checkbox" name="occupant_documents[]" value="contract_agreement" style="margin-left: 33px;"> Contract/Agreement</label>
        <label><input type="checkbox" name="occupant_documents[]" value="deed_of_sale" style="margin-left: 33px;"> Deed of Sale</label>
      </div>
      <label><input type="radio" name="occupant_claim" value="verbal"> Yes, a verbal claim only (no documents).</label>
      <label><input type="radio" name="occupant_claim" value="none"> No, they haven't made any claim.</label>
      <label><input type="radio" name="occupant_claim" value="unknown"> I don't know / I haven't asked.</label>

      <p style="font-weight: bold;">6. Have you tried to resolve this directly with the occupant?</p>
      <label><input type="radio" name="approach" value="yes" id="approachYes"> Yes, I have spoken with them</label>
      <div id="approachYesDetails" style="display: none; margin-left: 22px;">
        <p style="font-weight: bold; margin-left: 15px;">What was their response?</p>
        <label><input type="radio" name="approachDetails" style="margin-left: 33px;"> They admitted they have no documents</label>
        <label><input type="radio" name="approachDetails" style="margin-left: 33px;"> They refused to leave the lot</label>
        <label><input type="radio" name="approachDetails" style="margin-left: 33px;"> They claim they are the real owner</label>
        <label><input type="radio" name="approachDetails" style="margin-left: 33px;"> They ignored me</label>
        <label><input type="radio" name="approachDetails" style="margin-left: 33px;"> They became hostile or aggressive</label>
      </div>

      <label><input type="radio" name="approach" value="no" id="approachNo"> No</label>
      <div id="approachNoDetails" style="display: none; margin-left: 22px;">
        <p style="font-weight: bold; margin-left: 15px;">Why not?</p>
        <label><input type="radio" name="approachNoDetails" style="margin-left: 33px;"> I was advised not to confront them</label>
        <label><input type="radio" name="approachNoDetails" style="margin-left: 33px;"> I do not know them personally</label>
        <label><input type="radio" name="approachNoDetails" style="margin-left: 33px;"> I am not currently living in the area</label>
      </div>

      <label><strong>7. Have you reported this boundary issue to any office or authority?</strong> <i style="font-size: 14px; font-weight: normal; color: grey;">(Check all that apply)</i></label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="Barangay"> Barangay</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="HOA"> HOA</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="NGC"> NGC</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="NGC"> USAD - PHASELAD</label>
      <label><input type="checkbox" name="boundary_reported_to[]" value="none"> None</label>

      <p style="font-weight: bold;">8. What was the result of that report?</p>
      <label><input type="radio" name="result"> The occupant was formally asked to leave</label>
      <label><input type="radio" name="result"> I was asked to provide more documents</label>
      <label><input type="radio" name="result"> Still under investigation</label>
      <label><input type="radio" name="result"> The issue is still pending or unresolved.</label>

        // --- Autofill Q1: How are you connected to the lot (for non-members, checkboxes) ---
        if (cat === 'non_member' && d.connections) {
          // d.connections may be an array or object (array preferred)
          let checkedValues = Array.isArray(d.connections) ? d.connections : [];
          if (!Array.isArray(checkedValues) && typeof d.connections === 'object') {
            checkedValues = Object.keys(d.connections).filter(k => d.connections[k]);
          }
          // For each value, check the corresponding checkbox
          checkedValues.forEach(val => {
            const selector = `input[name="legal_connection"][value="${val}"]`;
            const el = document.querySelector(selector);
            if (el) {
              el.checked = true;
            }
          });
        } else if (cat !== 'non_member' && d.legal_connection) {
          // For members/family_of_member, autofill the radio
          const selector = `input[name="legal_connection"][value="${d.legal_connection}"]`;
          const el = document.querySelector(selector);
          if (el) {
            el.checked = true;
          }
        }
      <label><input type="radio" name="result"> No action was taken by the authority.</label>
      <label><input type="radio" name="result" style="margin-bottom: 12px;"> I was told I have no valid claim</label>

      <!-- Section 2 -->
      <p class="section-label" style="color: black;">Please describe what happened briefly, including how you found out about the issue.</p>
      <textarea></textarea>

      <!-- Section 3 -->
      <div class="section-header">COMPLAINANT’S CONSENT AND DECLARATION</div>
      <div class="consent">
        By submitting this complaint form, I hereby consent to the collection and processing of my personal information as necessary to address the issues raised regarding the lot in question. I confirm that the information provided is accurate and complete to the best of my knowledge. I understand that any false or incomplete information may affect the handling of my complaint, and I acknowledge that my personal details will be processed in compliance with the Privacy Act and other applicable laws.
      </div>

      <div class="signature">
        <input type="file" id="signatureInput" accept="image/*" style="display:none;" />
        <button type="button" class="upload-btn" onclick="document.getElementById('signatureInput').click()">Upload Signature</button>
        <span id="signatureFileName" style="margin-left:10px;  font-style:italic;"></span>
      </div>
    </div>
  </div>


<script>
function toggleSection(radioId, detailsId) {
  const radio = document.getElementById(radioId);
  const details = document.getElementById(detailsId);

  if (!radio || !details) return;

  radio.addEventListener("change", function () {
    if (radio.checked) {
      details.style.display = "block";
    }
  });

  const siblings = document.querySelectorAll(`input[name="${radio.name}"]`);
  siblings.forEach(r => {
    r.addEventListener("change", function () {
      if (!radio.checked) {
        details.style.display = "none";

        const textInputs = details.querySelectorAll("input[type=text], input[type=date]");
        textInputs.forEach(input => input.value = "");
        const radios = details.querySelectorAll("input[type=radio]");
        radios.forEach(radio => radio.checked = false);
        const checkboxes = details.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
      }
    });
  });
}

// For Q6 yes/no sections
toggleSection("approachYes", "approachYesDetails");
toggleSection("approachNo", "approachNoDetails");

// Q1: Show "Other (Please specify)" input only when "Other" is selected
function setupOtherInlineRadio(radioSelector, inputSelector) {
  const radio = document.querySelector(radioSelector);
  const input = document.querySelector(inputSelector);
  if (!radio || !input) return;

  const group = document.querySelectorAll(`input[name="${radio.name}"]`);

  function update() {
    if (radio.checked) {
      input.style.display = "inline-block";
      input.disabled = false;
      input.focus();
    } else {
      input.style.display = "none";
      input.disabled = true;
      input.value = "";
    }
  }

  group.forEach(r => r.addEventListener("change", update));
  update();
}
setupOtherInlineRadio("#legal_connection_other", "#legal_connection_other_text");

// Q2: Add/remove involved persons
(function setupInvolvedPersons() {
  const container = document.getElementById("involvedPersonsContainer");
  const addBtn = document.getElementById("addPersonBtn");
  if (!container || !addBtn) return;

  function createPersonRow(withRemove = true) {
    const row = document.createElement("div");
    row.className = "person-input";
    row.style.display = "flex";
    row.style.gap = "8px";
    row.style.alignItems = "center";

    const input = document.createElement("input");
    input.type = "text";
    input.className = "involved_person_name";
    input.name = "involved_person_name[]";
    input.placeholder = "Enter name";
    input.style.width = "84%";

    row.appendChild(input);

    if (withRemove) {
      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      // make remove look same as add
      removeBtn.className = "btn add small remove-person";
      removeBtn.textContent = "Remove";
      row.appendChild(removeBtn);
    }

    return row;
  }

  // Ensure only rows after the first have remove buttons
  function normalizeRows() {
    const rows = container.querySelectorAll(".person-input");
    rows.forEach((row, idx) => {
      const removeBtn = row.querySelector(".remove-person");
      if (idx === 0 && removeBtn) {
        removeBtn.remove();
      } else if (idx > 0 && !removeBtn) {
        const btn = document.createElement("button");
        btn.type = "button";
        // make remove look same as add
        btn.className = "btn add small remove-person";
        btn.textContent = "Remove";
        row.appendChild(btn);
      }
    });
  }

  addBtn.addEventListener("click", () => {
    container.appendChild(createPersonRow(true));
    normalizeRows();
  });

  container.addEventListener("click", (e) => {
    if (e.target && e.target.classList.contains("remove-person")) {
      const row = e.target.closest(".person-input");
      if (row) row.remove();
      normalizeRows();
    }
  });

  // Normalize initial state
  normalizeRows();
})();

// Q5: Show document checklist only when "Yes, they presented documents" is selected
function toggleDetailsByRadioValue(groupName, targetValue, detailsId) {
  const radios = document.querySelectorAll(`input[name="${groupName}"]`);
  const details = document.getElementById(detailsId);
  if (!radios.length || !details) return;

  function clearFields() {
    details.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    details.querySelectorAll('input[type="text"], input[type="date"], input[type="number"], textarea').forEach(el => el.value = "");
    details.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
  }

  function update() {
    const selected = Array.from(radios).find(r => r.checked)?.value;
    if (selected === targetValue) {
      details.style.display = "block";
    } else {
      details.style.display = "none";
      clearFields();
    }
  }

  radios.forEach(r => r.addEventListener("change", update));
  update();
}
toggleDetailsByRadioValue("occupant_claim", "docs", "reasonDetails");
// fix No. 9: show previous complaint reference only when "Yes" is selected
toggleDetailsByRadioValue("previous_complaint", "yes", "prevComplaintDetails");
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Target all checkboxes in Q7
  const checkboxes = document.querySelectorAll('input[name="boundary_reported_to[]"]');
  if (!checkboxes.length) return;

  const noneCheckbox = Array.from(checkboxes).find(cb => cb.value.toLowerCase() === 'none');
  const otherCheckboxes = Array.from(checkboxes).filter(cb => cb !== noneCheckbox);

  if (!noneCheckbox) return;

  // Helper to get the label for a checkbox
  function getLabelForCheckbox(cb) {
    // Try to find the parent label
    if (cb.parentElement && cb.parentElement.tagName.toLowerCase() === 'label') {
      return cb.parentElement;
    }
    // Try to find label[for]
    const id = cb.id;
    if (id) {
      return document.querySelector(`label[for="${id}"]`);
    }
    return null;
  }

  // Handle 'None' behavior
  noneCheckbox.addEventListener('change', () => {
    if (noneCheckbox.checked) {
      otherCheckboxes.forEach(cb => {
        cb.checked = false;
        cb.disabled = true;
        const label = getLabelForCheckbox(cb);
        if (label) label.classList.add('checkbox-disabled');
      });
    } else {
      otherCheckboxes.forEach(cb => {
        cb.disabled = false;
        const label = getLabelForCheckbox(cb);
        if (label) label.classList.remove('checkbox-disabled');
      });
    }
  });

  // Handle others (uncheck 'None' if any other is checked)
  otherCheckboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      if (cb.checked) {
        noneCheckbox.checked = false;
        noneCheckbox.disabled = false;
        // Remove disabled style from all labels
        otherCheckboxes.forEach(other => {
          const label = getLabelForCheckbox(other);
          if (label) label.classList.remove('checkbox-disabled');
        });
      }
    });
  });

  // On load, ensure correct state
  if (noneCheckbox.checked) {
    otherCheckboxes.forEach(cb => {
      cb.disabled = true;
      const label = getLabelForCheckbox(cb);
      if (label) label.classList.add('checkbox-disabled');
    });
  }
});
</script>

<script>
// --- Complainant Details Section: Dynamic, session-driven (copied from pathway_dispute.html) ---
document.addEventListener('DOMContentLoaded', async () => {
  const container = document.getElementById('complainantDetails');
  if (!container) return;

  // --- Helper functions ---
  function row1(label, value, type='text') {
    const r = document.createElement('div');
    r.className = 'pair-row';
    r.innerHTML = `<div class="col"><label class="small">${label}</label><input type="${type}" value="${value || ''}" readonly></div>`;
    return r;
  }
  function row2(l1, v1, l2, v2, t1='text', t2='text') {
    const r = document.createElement('div');
    r.className = 'pair-row';
    r.innerHTML = `
      <div class="col"><label class="small">${l1}</label><input type="${t1}" value="${v1 || ''}" readonly></div>
      <div class="col"><label class="small">${l2}</label><input type="${t2}" value="${v2 || ''}" readonly></div>`;
    return r;
  }
  function row3(l1, v1, l2, v2, l3, v3) {
    const r = document.createElement('div');
    r.className = 'pair-row';
    r.innerHTML = `
      <div class="col"><label class="small">${l1}</label><input type="text" value="${v1 || ''}" readonly></div>
      <div class="col"><label class="small">${l2}</label><input type="text" value="${v2 || ''}" readonly></div>
      <div class="col"><label class="small">${l3}</label><input type="text" value="${v3 || ''}" readonly></div>`;
    return r;
  }
  function normalizeName(name) {
    if (!name || typeof name !== 'string') return name || '';
    return name.replace(/\b([A-Z])\.*\b/g, '$1.');
  }
  function createSupportingDocsSection(docs, category) {
    if (!docs || (!Array.isArray(docs) && typeof docs !== 'object')) return null;
    const docDiv = document.createElement('div');
    docDiv.style.margin = '8px 0 16px 0';
    const labelText = category === 'family_of_member' 
      ? 'What Supporting Documents does your Family Member have?' 
      : 'What Supporting Documents do you have?';
    docDiv.innerHTML = `<label style="font-weight:600; display:block; margin-bottom:2px;">${labelText}</label>`;
    const docList = [
      {key: 'title', label: 'Title'},
      {key: 'contract_to_sell', label: 'Contract to Sell'},
      {key: 'certificate_of_full_payment', label: 'Certificate of Full Payment'},
      {key: 'pre_qualification_stub', label: 'Pre-qualification Stub'},
      {key: 'contract_agreement', label: 'Contract/Agreement'},
      {key: 'deed_of_sale', label: 'Deed of Sale'}
    ];
    let selected = {};
    if (Array.isArray(docs)) docs.forEach(k => selected[k]=true);
    else if (typeof docs === 'object') selected = docs;
    let group = `<div class='checkbox-group' style="display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:6px 16px;">`;
    docList.forEach(doc => {
      const checked = selected[doc.key] ? 'checked' : '';
      group += `<label style="white-space:nowrap;"><input type="checkbox" disabled ${checked}> ${doc.label}</label>`;
    });
    group += '</div>';
    docDiv.innerHTML += group;
    return docDiv;
  }

  // --- Fetch complainant session data ---
  try {
    const res = await fetch('/complainant/unauthorized_occupation/get_unauthorized_occupation_session_data', { credentials: 'same-origin' });
    const contentType = res.headers.get('content-type') || '';
    if (!contentType.includes('application/json')) return;
    const d = await res.json();
    if (!d || d.error) return;
    const pairs = document.createElement('div');
    pairs.className = 'pairs';
    const cat = d.category;
    // Basic info
    pairs.appendChild(row1('Full Name:', normalizeName(d.full_name)));
    let memberWrapper = null;
    if (cat === 'family_of_member') {
      // Format complainant date_of_birth as 'Month Day, Year' if possible
      let dob = d.date_of_birth;
      if (dob && typeof dob === 'string' && dob.match(/\d{4}-\d{2}-\d{2}/)) {
        const dt = new Date(dob);
        dob = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      } else if (dob && typeof dob === 'string' && dob.match(/\w{3},/)) {
        // Try to parse RFC date string
        const dt = new Date(dob);
        if (!isNaN(dt)) dob = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      }
      pairs.appendChild(row2('Date of Birth:', dob, 'Age:', d.age));
      pairs.appendChild(row2('Sex:', d.sex, 'Citizenship:', d.citizenship));
      pairs.appendChild(row3('Current Address:', d.cur_add, 'Year of Residence:', d.year_of_residence, 'Phone Number:', d.phone_number));
    } else {
      // Format complainant date_of_birth as 'Month Day, Year' if possible
      let dob = d.date_of_birth;
      if (dob && typeof dob === 'string' && dob.match(/\d{4}-\d{2}-\d{2}/)) {
        const dt = new Date(dob);
        dob = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      } else if (dob && typeof dob === 'string' && dob.match(/\w{3},/)) {
        // Try to parse RFC date string
        const dt = new Date(dob);
        if (!isNaN(dt)) dob = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      }
      pairs.appendChild(row2('Date of Birth:', dob, 'Age:', d.age));
      pairs.appendChild(row2('Sex:', d.sex, 'Citizenship:', d.citizenship));
      pairs.appendChild(row3('Current Address:', d.cur_add, 'Year of Residence:', d.year_of_residence, 'Phone Number:', d.phone_number));
      pairs.appendChild(row1('Area (HOA):', d.hoa || '', 'text'));
      if (cat === 'hoa_member') {
        pairs.appendChild(row3('Block Assignment:', d.blk_num || '', 'Lot Assignment:', d.lot_num || '', 'Lot Size:', d.lot_size || ''));
      }
      pairs.appendChild(row2('Civil Status:', d.civil_status || '', 'Recipient of Other Housing:', d.recipient_of_other_housing || ''));
      // Show supporting documents for HOA members only (not non_member)
      if (cat === 'hoa_member') {
        const docSection = createSupportingDocsSection(d.supporting_documents, cat);
        if (docSection) pairs.appendChild(docSection);
      }
    }
    if (cat === 'family_of_member' && d.parent_info) {
      const wrapper = document.createElement('div');
      wrapper.style.marginTop = '20px';
      const sectionHeader = document.createElement('div');
      sectionHeader.className = 'section-header';
      sectionHeader.textContent = 'HOA MEMBER INFORMATION';
      wrapper.appendChild(sectionHeader);
      const memberPairs = document.createElement('div');
      memberPairs.className = 'pairs';
      const p = d.parent_info;
      memberPairs.appendChild(row1('Full Name:', normalizeName(p.full_name)));
      // Format parent date_of_birth as 'Month Day, Year' if possible
      let pdob = p.date_of_birth;
      if (pdob && typeof pdob === 'string' && pdob.match(/\d{4}-\d{2}-\d{2}/)) {
        const dt = new Date(pdob);
        pdob = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      } else if (pdob && typeof pdob === 'string' && pdob.match(/\w{3},/)) {
        // Try to parse RFC date string
        const dt = new Date(pdob);
        if (!isNaN(dt)) pdob = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      }
      memberPairs.appendChild(row2('Date of Birth:', pdob, 'Age:', p.age));
      memberPairs.appendChild(row2('Sex:', p.sex, 'Citizenship:', p.citizenship));
      memberPairs.appendChild(row2('Current Address:', p.current_address, 'Year of Residence:', p.year_of_residence || ''));
      memberPairs.appendChild(row1('Area (HOA):', p.hoa || '', 'text'));
      memberPairs.appendChild(row3('Block Assignment:', p.blk_num || '', 'Lot Assignment:', p.lot_num || '', 'Lot Size:', p.lot_size || ''));
      memberPairs.appendChild(row3('Civil Status:', p.civil_status || '', 'Recipient of Other Housing:', p.recipient_of_other_housing || '', 'Relationship:', d.relationship || ''));
      // Show supporting documents for family_of_member only at the end of HOA MEMBER INFORMATION
      const docSection = createSupportingDocsSection(p.supporting_documents, 'family_of_member');
      if (docSection) memberPairs.appendChild(docSection);
      wrapper.appendChild(memberPairs);
      memberWrapper = wrapper;
    } else if (cat === 'family_of_member' && !d.parent_info) {
      const warn = document.createElement('div');
      warn.style.color='red'; warn.style.fontWeight='bold'; warn.style.margin='16px 0';
      warn.textContent = 'HOA MEMBER INFORMATION is missing (no parent_info in session data).';
      pairs.appendChild(warn);
    }
    container.innerHTML = '';
    container.appendChild(pairs);
    if (memberWrapper) container.appendChild(memberWrapper);

    // --- Autofill Q1: How are you connected to the lot (for non-members, checkboxes) ---
    if (cat === 'non_member' && d.connections) {
      // d.connections may be an array or object (array preferred)
      let checkedValues = Array.isArray(d.connections) ? d.connections : [];
      if (!Array.isArray(checkedValues) && typeof d.connections === 'object') {
        checkedValues = Object.keys(d.connections).filter(k => d.connections[k]);
      }
      // For each value, check the corresponding checkbox
      checkedValues.forEach(val => {
        const selector = `input[name="legal_connection"][value="${val}"]`;
        const el = document.querySelector(selector);
        if (el) {
          el.checked = true;
        }
      });
    } else if (cat !== 'non_member' && d.legal_connection) {
      // For members/family_of_member, autofill the radio
      const selector = `input[name="legal_connection"][value="${d.legal_connection}"]`;
      const el = document.querySelector(selector);
      if (el) {
        el.checked = true;
      }
    }
  } catch (e) {
    console.error('Error fetching complainant data:', e);
  }
});
</script>


</body>
</html>