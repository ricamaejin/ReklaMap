{# Choose the response mapping: prefer unauthorized_occupation.responses, fallback to answers #}
{% set resp = unauthorized_occupation.responses if unauthorized_occupation and unauthorized_occupation.responses else answers %}

{# --- Block/Lot Section for Non-members --- #}
{% if registration and registration.category == 'non_member' %}
    {% set block_lots = [] %}
    {% set candidate = None %}

    {# 1) Try field on unauthorized_occupation #}
    {% if unauthorized_occupation and unauthorized_occupation.block_lot %}
        {% set candidate = unauthorized_occupation.block_lot %}
    {% elif unauthorized_occupation and unauthorized_occupation.responses and unauthorized_occupation.responses.block_lot %}
        {% set candidate = unauthorized_occupation.responses.block_lot %}
    {% elif resp and resp.block_lot %}
        {% set candidate = resp.block_lot %}
    {% elif resp and (resp.block or resp.lot) %}
        {% set candidate = {'block': (resp.block if resp.block else ''), 'lot': (resp.lot if resp.lot else '')} %}
    {% elif registration %}
        {% set candidate = {'block': (registration.block_no if registration.block_no else ''), 'lot': (registration.lot_no if registration.lot_no else '')} %}
    {% endif %}

    {% if candidate is string %}
        {% set s = candidate.strip() %}
        {% if s.startswith('[') %}
            {% set block_lots = s | from_json %}
        {% elif s.startswith('{') %}
            {% set parsed = s | from_json %}
            {% if parsed is mapping %}
                {% set block_lots = [parsed] %}
            {% endif %}
        {% elif ',' in s %}
            {% set parts = s.split(',') %}
            {% set block_lots = [{'block': parts[0].strip(), 'lot': (parts[1].strip() if parts|length > 1 else '')}] %}
        {% endif %}
    {% elif candidate is mapping %}
        {% set block_lots = [candidate] %}
    {% elif candidate is iterable and candidate|length > 0 %}
        {% set block_lots = candidate %}
    {% endif %}

    <div id="nonMemberBlockLotSection">
        {% if block_lots and block_lots|length > 0 %}
            <p>What is the specific block and lot involved in the dispute?</p>
            <div class="pairs" id="pairsContainer" aria-live="polite">
                {% for pair in block_lots %}
                    {% set block = pair.block if pair is mapping else '' %}
                    {% set lot = pair.lot if pair is mapping else '' %}
                    {% if block or lot %}
                        <div class="pair-row">
                            <div class="col">
                                <label class="small">Block No.</label>
                                <input type="text" value="{{ block }}" readonly placeholder="Block No.">
                            </div>
                            <div class="col">
                                <label class="small">Lot No.</label>
                                <input type="text" value="{{ lot }}" readonly placeholder="Lot No.">
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% else %}
            <div class="readonly-value" style="margin-bottom: 12px;">No Block/Lot information provided.</div>
        {% endif %}
    </div>
{% endif %}


{# --- Render all questions dynamically --- #}
{% for field in form_structure %}

    {# ============================================================
       QUESTION 5 + Q5a (Supporting Documents)
       ============================================================ #}
    {% if field.name == 'q5' %}
        <div class="question-block" style="margin-bottom: 20px;">
            <p>{{ field.label }}</p>

            {% set selected = resp[field.name] if resp and field.name in resp else None %}
            {% set selected_lower = (selected|string)|trim|lower %}

            {% for value, label in field.options %}
                {% set val_lower = (value|string)|trim|lower %}
                {% set lbl_lower = (label|string)|trim|lower %}
                {% set checked = (selected_lower == val_lower or selected_lower == lbl_lower) %}

                <div style="margin-bottom: 6px;">
                    <label style="display: block; margin-left: 8px;">
                        <input type="radio" value="{{ value }}" {% if checked %}checked{% endif %} disabled>
                        {{ label }}
                    </label>

                    {# --- Show Q5a only under "Yes, they presented documents" --- #}
                    {% if ('yes' in lbl_lower and 'presented' in lbl_lower) and checked %}
                        {% set sub = form_structure | selectattr('name', 'equalto', 'q5a') | first %}
                        {% if sub %}
                            <div style="margin-left: 40px; margin-top: 10px;">
                                <p>{{ sub.label }}</p>

                                {% set selected_docs = resp[sub.name] if resp and sub.name in resp else [] %}
                                {% set selected_docs_lower = [] %}

                                {% if selected_docs is string %}
                                    {% if selected_docs.strip().startswith('[') and selected_docs.strip().endswith(']') %}
                                        {% set selected_docs_lower = (selected_docs|from_json) | map('lower') | list %}
                                    {% elif ',' in selected_docs %}
                                        {% set selected_docs_lower = selected_docs|replace(' ', '')|split(',') | map('lower') | list %}
                                    {% elif selected_docs %}
                                        {% set selected_docs_lower = [selected_docs|string|lower] %}
                                    {% endif %}
                                {% elif selected_docs is iterable and selected_docs is not mapping %}
                                    {% set selected_docs_lower = selected_docs | map('lower') | list %}
                                {% elif selected_docs is not none %}
                                    {% set selected_docs_lower = [selected_docs|string|lower] %}
                                {% endif %}

                                {% for val2, label2 in sub.options %}
                                    {% set val2_lower = (val2|string)|trim|lower %}
                                    <label style="display: block; margin-left: 8px;">
                                        <input type="checkbox" value="{{ val2 }}" {% if val2_lower in selected_docs_lower %}checked{% endif %} disabled>
                                        {{ label2 }}
                                    </label>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>

    {# ============================================================
       QUESTION 6
       ============================================================ #}
    {% elif field.name == 'q6' %}
        <div class="question-block" style="margin-bottom:18px;">
            <p>{{ field.label }}</p>
            {% set selected = resp[field.name] if resp and field.name in resp else None %}
            {% set selected_norm = (selected|string)|lower %}

            {% for value, label in field.options %}
                <div style="margin-bottom:4px;">
                    <label style="display:block; margin-left:8px;">
                        <input type="radio" value="{{ value }}" {% if selected_norm == value|lower %}checked{% endif %} disabled>
                        {{ label }}
                    </label>

                    {% if value|lower == 'yes' and selected_norm == 'yes' %}
                        {% set sub = form_structure | selectattr('name', 'equalto', 'q6a') | first %}
                        {% if sub %}
                            <div style="margin-left:47px;">
                                <p>{{ sub.label }}</p>
                                {% set sub_selected = resp[sub.name] if resp and sub.name in resp else '' %}
                                {% for value2, label2 in sub.options %}
                                    <label style="display:block; margin-left:8px;">
                                        <input type="radio" value="{{ value2 }}" {% if (sub_selected|string)|lower == value2|lower %}checked{% endif %} disabled>
                                        {{ label2 }}
                                    </label>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% elif value|lower == 'no' and selected_norm == 'no' %}
                        {% set sub = form_structure | selectattr('name', 'equalto', 'q6a_no') | first %}
                        {% if sub %}
                            <div style="margin-left:32px;">
                                <p>{{ sub.label }}</p>
                                {% set sub_selected = resp[sub.name] if resp and sub.name in resp else [] %}
                                {% set sub_selected_list = [] %}

                                {% if sub_selected is string %}
                                    {% for item in sub_selected.replace('[','').replace(']','').replace('"','').split(',') %}
                                        {% set item_clean = item.strip() %}
                                        {% if item_clean %}{% set _ = sub_selected_list.append(item_clean|lower) %}{% endif %}
                                    {% endfor %}
                                {% elif sub_selected is iterable %}
                                    {% for item in sub_selected %}
                                        {% set _ = sub_selected_list.append(item|lower) %}
                                    {% endfor %}
                                {% endif %}

                                {% for value2, label2 in sub.options %}
                                    {% set vnorm2 = value2 | lower %}
                                    <label style="display:block; margin-left:8px;">
                                        <input type="checkbox" value="{{ value2 }}" {% if vnorm2 in sub_selected_list %}checked{% endif %} disabled>
                                        {{ label2 }}
                                    </label>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>

    {# ============================================================
       ALL OTHER QUESTIONS
       ============================================================ #}
    {% elif field.type != 'file' and field.name not in ['q6a', 'q6a_no', 'q5a'] %}
        <div class="question-block" style="margin-bottom:18px;">
            <p>{{ field.label }}</p>
            {% set selected = resp[field.name] if resp and field.name in resp else None %}
            {% if field.type == 'radio' %}
                {% set selected_norm = (selected|string)|lower %}
                {% for value, label in field.options %}
                    <label style="display:block; margin-left:8px;">
                        <input type="radio" value="{{ value }}" {% if selected_norm == value|lower %}checked{% endif %} disabled>
                        {{ label }}
                    </label>
                {% endfor %}
            {% elif field.type == 'checkbox' %}
                {% set raw = selected if selected else [] %}
                {% set selected_norm = raw | map('lower') | list %}
                {% for value, label in field.options %}
                    {% set vnorm = value | lower %}
                    <label style="display:block; margin-left:8px;">
                        <input type="checkbox" value="{{ value }}" {% if vnorm in selected_norm %}checked{% endif %} disabled>
                        {{ label }}
                    </label>
                {% endfor %}
            {% elif field.type == 'date' %}
                <input type="date" value="{{ selected or '' }}" readonly style="width:95%; padding:8px; margin-left:15px; margin-bottom:12px; border:1px solid #ccc; border-radius:4px;">
            {% elif field.type == 'multiple_text' %}
                {% if selected %}
                    {% for val in selected %}
                        <input type="text" value="{{ val }}" readonly style="display:block; width:95%; margin:6px 0 6px 15px; padding:8px; border:1px solid #ccc; border-radius:4px;">
                    {% endfor %}
                {% else %}
                    <input type="text" value="" readonly style="display:block; width:95%; margin:6px 0 6px 15px; padding:8px; border:1px solid #ccc; border-radius:4px;">
                {% endif %}
            {% elif field.type == 'textarea' %}
                <textarea readonly style="margin-left: 15px !important; width: 95%; min-height:80px; margin:8px 0; padding:8px; border:1px solid #ccc; border-radius:4px;">{{ selected or '' }}</textarea>
            {% endif %}
        </div>
    {% endif %}
{% endfor %}
