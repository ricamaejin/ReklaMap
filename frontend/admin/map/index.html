<!-- connect to db: areas (search: areas, block?, lot?, ben?) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <a href="/admin/map/index.html" class="nav-item active">Map</a>
      <a href="/admin/complaints/all.html" class="nav-item">Complaints</a>
      <a href="/admin/database/beneficiaries.html" class="nav-item">Database</a>
    </nav>
  </aside>

  <!-- User Dropdown -->
  <div class="user-dropdown">
    Logged in as: <span class="username" id="admin-name"></span>
    <button class="dropdown-toggle">‚ñº</button>
    <div class="dropdown-menu">
      <a href="/portal/index.html">Logout</a>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content">
    <header class="main-header">
      <h1>National Government Center Areas</h1>
      <p>
        RA 9207, passed in 2003, authorized the disposition of 422 hectares in the <br />
        NGC, granting land ownership to 5,678 residents of Barangay Holy Spirit <br />
        and other nearby communities.
      </p>
    </header>

    <!-- Search -->
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Search area, block, lot, or name..." />
      <button id="search-btn">Search</button>
      <div id="search-results" class="search-results" style="display: none;"></div>
    </div>

    <!-- Map container -->
    <div class="map-section">
      <div id="map-container"></div>
    </div>

    <!-- Tooltip for hover -->
    <div id="tooltip" class="tooltip"></div>
  </main>

  <script>
    // Load admin name dynamically
    async function loadAdminName() {
      try {
        const response = await fetch('/admin/current-user');
        if (response.ok) {
          const data = await response.json();
          document.getElementById('admin-name').textContent = data.name || 'Unknown Admin';
        } else {
          document.getElementById('admin-name').textContent = 'Unknown Admin';
        }
      } catch (error) {
        console.error('Error loading admin name:', error);
        document.getElementById('admin-name').textContent = 'Unknown Admin';
      }
    }

    // Cache for area data to prevent repeated API calls
    const areaDataCache = new Map();
    
    // Function to fetch area data from database with caching
    async function fetchAreaData(areaCode) {
      if (areaDataCache.has(areaCode)) {
        return areaDataCache.get(areaCode);
      }
      
      try {
        const response = await fetch(`/admin/areas/stats/${encodeURIComponent(areaCode)}`);
        if (response.ok) {
          const data = await response.json();
          areaDataCache.set(areaCode, data);
          return data;
        }
        return null;
      } catch (error) {
        console.error('Error fetching area data:', error);
        return null;
      }
    }

      // Load the SVG map
      fetch('/admin/map/svg/hoa_map.svg') // adjust path if needed
    function initMap() {
      fetch('/admin/map/svg/hoa_map.svg')
        .then(res => res.text())
        .then(svg => {
          const container = document.getElementById('map-container');
          container.innerHTML = svg;

          const tooltip = document.getElementById('tooltip');
          const svgEl = container.querySelector('svg');

          // Loop through all group areas
          container.querySelectorAll('g').forEach(area => {
            const areaName = area.getAttribute('name')?.toLowerCase();

            if (areaName && areaData[areaName]) {
              const { name, beneficiaries, complaints, resolved } = areaData[areaName];
              area.dataset.name = name;
              area.dataset.beneficiaries = beneficiaries;
              area.dataset.complaints = complaints;
              area.dataset.resolved = resolved;
            }

            // Tooltip on hover with database data and debouncing to fix glitching
            let tooltipTimeout;
            let currentAreaData = null;
            
            area.addEventListener('mouseenter', async e => {
              const areaCode = area.id || area.getAttribute('data-name') || area.getAttribute('name') || 'unknown';
              
              // Fetch real data from database
              currentAreaData = await fetchAreaData(areaCode);
              
              // Use area_name from database, fallback to SVG attribute
              const areaName = currentAreaData ? currentAreaData.area_name : (area.getAttribute('name') || area.id || 'Unknown Area');
              const beneficiaries = currentAreaData ? currentAreaData.beneficiaries : 'N/A';
              const complaints = currentAreaData ? currentAreaData.complaints : 'N/A';
              
              tooltip.innerHTML = `
                <div class="tooltip-content">
                  <div class="area-name">
                    <span class="area-text">${areaName}</span>
                  </div>
                  <div class="data-line">
                    <span class="data-icon">üë•</span>
                    <span class="data-label">Beneficiaries</span>
                    <span class="data-value">${beneficiaries}</span>
                  </div>
                  <div class="data-line">
                    <span class="data-icon">üìã</span>
                    <span class="data-label">Complaints</span>
                    <span class="data-value">${complaints}</span>
                  </div>
                  <div class="data-line">
                    <span class="data-icon">‚úÖ</span>
                    <span class="data-label">Resolved</span>
                    <span class="data-value">N/A</span>
                  </div>
                </div>
              `;
              tooltip.style.display = 'block';
            });
            
            area.addEventListener('mousemove', e => {
              if (tooltip.style.display === 'block') {
                tooltip.style.left = e.pageX + 15 + 'px';
                tooltip.style.top = e.pageY + 15 + 'px';
              }
            });

            // Hide tooltip when leaving
            area.addEventListener('mouseleave', () => {
              tooltip.style.display = 'none';
            });

            // Click navigation
            area.addEventListener('click', () => {
              const areaCode = area.id || area.getAttribute('data-name') || area.getAttribute('name') || "unknown";
              // Navigate to Flask route /admin/map/<area_code> for dynamic loading
              window.location.href = `/admin/map/${encodeURIComponent(areaCode.toLowerCase())}`;
            });
          });

          // Zoom effect on hover with mouse-follow 
          container.querySelectorAll('g').forEach(area => {
            let zoomTimeout;

            area.addEventListener('mouseenter', (e) => {
              zoomTimeout = setTimeout(() => {
                const rect = svgEl.getBoundingClientRect();
                const offsetX = e.clientX - rect.left; 
                const offsetY = e.clientY - rect.top;

                const percentX = (offsetX / rect.width) * 100;
                const percentY = (offsetY / rect.height) * 100;

                svgEl.style.transition = "transform 0.8s ease-in-out";
                svgEl.style.transformOrigin = `${percentX}% ${percentY}%`;
                svgEl.style.transform = "scale(1.5)";
              }, 200);
            });

            area.addEventListener('mousemove', (e) => {
              // update origin as the mouse moves while zoomed in
              if (svgEl.style.transform === "scale(1.5)") {
                const rect = svgEl.getBoundingClientRect();
                const offsetX = e.clientX - rect.left; 
                const offsetY = e.clientY - rect.top;

                const percentX = (offsetX / rect.width) * 100;
                const percentY = (offsetY / rect.height) * 100;

                svgEl.style.transformOrigin = `${percentX}% ${percentY}%`;
              }
            });

            area.addEventListener('mouseleave', () => {
              clearTimeout(zoomTimeout);
              svgEl.style.transform = "scale(1)";
            });
          });
        })
      .catch(err => console.error("Error loading SVG:", err));
    }

    // Function to initialize dropdown
    function initDropdown() {
      const dropdown = document.querySelector(".user-dropdown");
      const toggle = dropdown.querySelector(".dropdown-toggle");

      toggle.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.toggle("active");
      });

      document.addEventListener("click", () => {
        dropdown.classList.remove("active");
      });
    }

    // Search functionality
    async function searchDatabase(query) {
      try {
        const response = await fetch(`/admin/search?q=${encodeURIComponent(query)}`);
        if (response.ok) {
          return await response.json();
        }
        return [];
      } catch (error) {
        console.error('Error searching database:', error);
        return [];
      }
    }

    function initSearch() {
      const searchInput = document.getElementById('search-input');
      const searchBtn = document.getElementById('search-btn');
      const searchResults = document.getElementById('search-results');
      let searchTimeout;

      async function performSearch() {
        const query = searchInput.value.trim();
        if (query.length < 2) {
          searchResults.style.display = 'none';
          return;
        }

        const results = await searchDatabase(query);
        displaySearchResults(results, query);
      }

      function displaySearchResults(results, query) {
        if (results.length === 0) {
          searchResults.innerHTML = '<div class="search-result-item no-results">No results found</div>';
          searchResults.style.display = 'block';
          return;
        }

        const resultsHtml = results.map(result => {
          let displayText = '';
          let navigateUrl = '';
          
          if (result.type === 'area') {
            displayText = `üìç ${result.area_name} (Area)`;
            navigateUrl = `/admin/map/${result.area_code}`;
          } else if (result.type === 'beneficiary') {
            displayText = `üë§ ${result.name} - ${result.area_name}, Block ${result.block_no}, Lot ${result.lot_no}`;
            navigateUrl = `/admin/map/${result.area_code}?highlight=block-${result.block_no}-lot-${result.lot_no}`;
          } else if (result.type === 'block') {
            displayText = `üèòÔ∏è ${result.area_name} - Block ${result.block_no}`;
            navigateUrl = `/admin/map/${result.area_code}?highlight=block-${result.block_no}`;
          }
          
          return `<div class="search-result-item" onclick="navigateToResult('${navigateUrl}')">${displayText}</div>`;
        }).join('');

        searchResults.innerHTML = resultsHtml;
        searchResults.style.display = 'block';
      }

      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
      });

      searchBtn.addEventListener('click', performSearch);

      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          performSearch();
        }
      });

      // Hide results when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-bar')) {
          searchResults.style.display = 'none';
        }
      });
    }

    // Navigate to search result
    function navigateToResult(url) {
      window.location.href = url;
    }

    // Run everything on DOM load
    document.addEventListener("DOMContentLoaded", () => {
      loadAdminName();
      initMap();
      initDropdown();
      initSearch();
    });
  </script>

  <style>
    /* Enhanced tooltip styling with icons and uniform appearance */
    .tooltip {
      position: fixed;
      width: 220px;
      min-height: 140px;
      max-height: 180px;
      padding: 12px 14px;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.98));
      color: #1e293b;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.4;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(203, 213, 225, 0.8);
      pointer-events: none;
      z-index: 1000;
      backdrop-filter: blur(12px);
      transform: translateY(-5px);
      opacity: 0.95;
      overflow: hidden;
    }

    .tooltip-content {
      display: block;
    }

    .tooltip .area-name {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 8px;
      color: rgb(15, 39, 97);
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 6px;
      min-height: 32px;
    }

    .tooltip .area-text {
      flex: 1;
      word-wrap: break-word;
      line-height: 1.3;
      max-height: 52px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      text-align: center;
    }

    .tooltip .data-line {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      margin: 4px 0;
      padding: 2px 0;
    }

    .tooltip .data-line:last-child {
      margin-bottom: 0;
    }

    .tooltip .data-icon {
      font-size: 12px;
      width: 16px;
      text-align: center;
    }

    .tooltip .data-label {
      color: #293647;
      font-weight: 500;
      flex: 1;
    }

    .tooltip .data-value {
      color: #0f172a;
      font-weight: 700;
      min-width: 40px;
      text-align: right;
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
    }

    /* Search functionality styles */
    .search-bar {
      position: relative;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 4px;
    }

    .search-result-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
      font-size: 14px;
      line-height: 1.4;
    }

    .search-result-item:hover {
      background-color: #f8f9fa;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-item.no-results {
      color: #666;
      text-align: center;
      font-style: italic;
      cursor: default;
    }

    .search-result-item.no-results:hover {
      background-color: transparent;
    }

    #search-input {
      width: 100%;
      padding: 10px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }

    #search-input:focus {
      outline: none;
      border-color: #3b82f6;
    }
  </style>
</body>
</html>
