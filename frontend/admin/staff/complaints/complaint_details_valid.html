<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" 
  integrity="sha512-t7Few9xlddEmgd3oKZQahkNI4dS6l80+eGEzFQiqtyVYdvcSG2D3Iub77R20BdotfRPA9caaRkg1tyaJiPmO0g==" 
  crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/complainants.css">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <!-- Navigation will be populated by navigation.js -->
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header"><h1>Complaint</h1></header>

    <div class="complaint-layout" style="margin-top: 30px;">
      <div class="complaint-form">Complaint form data will load here...</div>

      <!-- Right Panel -->
      <div class="right-panel">
        <div class="map-card">Map / Asset details here...</div>
        <button class="action-btn" onclick="openComplaint()">Assessment</button>

        <div class="timeline">
          <div class="timeline-entry">
            <h4>6/19/2025 - Send Invitation 
              <button class="file-btn" data-pdf="sample.pdf"></button> 
              <span>Josie Rosal</span>
            </h4>
            <p>An invitation has been sent...</p>
          </div>
          <div class="timeline-entry">
            <h4>6/13/2025 - Assessment <span>Josie Rosal</span></h4>
            <p>Upon inspection, the staff verified the complaintâ€™s validity...</p>
          </div>
        </div>
        <button class="resolved-btn" onclick="resolveTask()">Resolved Task</button>
      </div>
    </div>

    <!-- ACTION MODAL -->
    <div class="modal-overlay" id="modal">
      <div class="modal">
        <div class="modal-header">
          <h2>Action</h2>
          <div id="datetime"><div id="date"></div><div id="time"></div></div>
        </div>
        <hr>

        <label for="type">Type of Action Performed:</label>
        <div class="type-action-row">
          <select id="type" name="actionType" aria-label="Type of Action">
              <option value="" disabled selected hidden>Select Action</option>
              <option value="Inspection">Inspection</option>
              <option value="Send Invitation">Send Invitation</option>
              <option value="Mediation">Mediation</option>
              <option value="Other">Other</option>
          </select>
          <input type="text" id="actionOther" name="actionOther" placeholder="Specify" style="display:none;" />
        </div>

        <label>Description:</label>
        <textarea style="width: 98%;"></textarea>

        <label>File:</label>
        <div class="file-upload"><button onclick="openFiles()">Upload</button></div>

        <label>Attached Files:</label>
        <div id="attachedFilesContainer" class="attach-btn"></div>

        <div class="modal-footer">
          <button class="btn-cancel" onclick="closeComplaint()">Cancel</button>
          <button class="btn-save">Save</button> 
        </div>
      </div>
    </div>

    <!-- FILES MODAL -->
    <div id="filesModal" class="files-modal-overlay" style="display:none;">
      <div class="files-modal">
        <div class="files-header">
          <h2>Files</h2><div id="filesDateTime"></div>
        </div>
        <hr>

        <div class="file-tabs">
          <span class="tab active" data-tab="downloadable">Downloadable</span>
          <span class="tab" data-tab="uploaded">Upload File</span>
        </div>

        <div class="file-list downloadable-list"></div>

        <div class="file-list uploaded-list" style="display:none;">
          <div class="file-row">
            <span>Upload new file:</span>
            <input type="file" id="userFileInput" accept=".pdf,.jpeg,.jpg,.png" />
          </div>
          <div id="userFilesContainer"></div>
        </div>

        <div class="files-footer"><button class="close-btn" onclick="closeFiles()">Close</button></div>
      </div>
    </div>
  </main>

  <script>
  (function () {
    const modal = document.getElementById('modal'); 
    const dateEl = document.getElementById('datetime');
    const select = document.getElementById('type');
    const actionOther = document.getElementById('actionOther');
    let interval = null;

    // Update date & time inside Action modal
    function updateComplaintDateTime() {
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-US', {
        weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'
      });
      const timeStr = now.toLocaleTimeString('en-US', {
        hour: '2-digit', minute: '2-digit', hour12: true
      });
      dateEl.innerHTML = `${dateStr}<br>${timeStr}`;
    }

    // Open Action modal directly
    function openComplaint() {
      modal.style.display = 'flex';
      updateComplaintDateTime();
      if (!interval) interval = setInterval(updateComplaintDateTime, 1000);
      select.value = "";
      actionOther.style.display = "none";
    }

    function closeComplaint() {
      modal.style.display = 'none';
      if (interval) { clearInterval(interval); interval = null; }
    }

    select.addEventListener("change", () => {
      actionOther.style.display = (select.value === "Other") ? "inline-block" : "none";
    });

    modal.addEventListener('click', e => { if (e.target === modal) closeComplaint(); });

    window.openComplaint = openComplaint;
    window.closeComplaint = closeComplaint;
    window.updateComplaintDateTime = updateComplaintDateTime;
  })();

  /* Timeline: Open PDF */
  document.querySelectorAll('.file-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const pdfUrl = btn.getAttribute('data-pdf');
      if (pdfUrl) window.open(pdfUrl, '_blank');
      else alert("No PDF linked yet.");
    });
  });

  /* Files Modal */
  function openFiles() {
    const modal = document.getElementById("filesModal");
    modal.style.display = "flex";
    updateFilesDateTime();
  }
  function closeFiles() {
    document.getElementById("filesModal").style.display = "none";
  }
  function updateFilesDateTime() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', {
      weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'
    });
    const timeStr = now.toLocaleTimeString('en-US', {
      hour: '2-digit', minute: '2-digit', hour12: true
    });
    document.getElementById("filesDateTime").innerHTML = `${dateStr}<br>${timeStr}`;
  }
  document.getElementById("filesModal").addEventListener("click", e => {
    if (e.target.id === "filesModal") closeFiles();
  });

  /* Switch tabs */
  document.querySelectorAll('.file-tabs .tab').forEach(tab => {
    tab.addEventListener('click', function () {
      document.querySelectorAll('.file-tabs .tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      const target = this.getAttribute('data-tab');
      document.querySelector('.uploaded-list').style.display = target === "uploaded" ? "block" : "none";
      document.querySelector('.downloadable-list').style.display = target === "downloadable" ? "block" : "none";
    });
  });

  /* User file uploads */
  document.getElementById("userFileInput").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      const fileRow = document.createElement("div");
      fileRow.className = "file-row";

      fileRow.innerHTML = `
        <span class="file-name">${file.name}</span>
        <div class="file-actions">
          <a href="${url}" download="${file.name}" class="download-btn">Download â¬‡</a>
          <button class="attach-btn">Attach ðŸ“Ž</button>
        </div>
      `;

      fileRow.querySelector(".attach-btn").addEventListener("click", () => {
        attachFileToAction(file.name, url);
      });

      document.querySelector(".downloadable-list").appendChild(fileRow);
      document.querySelector('.file-tabs .tab[data-tab="downloadable"]').click();
    }
  });

  function attachFileToAction(fileName, fileUrl) {
    const container = document.getElementById("attachedFilesContainer");
    if (!container) return;
    const alreadyAttached = [...container.querySelectorAll(".attached-file")]
      .some(f => f.textContent === fileName);
    if (alreadyAttached) return;

    const fileTag = document.createElement("div");
    fileTag.className = "attached-file";
    fileTag.textContent = fileName;
    fileTag.dataset.url = fileUrl;
    container.appendChild(fileTag);
  }

  document.querySelector(".btn-save").addEventListener("click", () => {
    const actionType = document.getElementById("type").value;
    const desc = document.querySelector("textarea").value;
    const attachedFiles = [...document.querySelectorAll("#attachedFilesContainer .attached-file")]
      .map(f => ({ name: f.textContent, url: f.dataset.url }));
    console.log({ actionType, desc, attachedFiles });
    // TODO: Send action data to backend - staff can only perform one action matching their assignment
  });

  // Resolved Task function - directly creates "Task Completed" entry
  function resolveTask() {
    // TODO: Send "Task Completed" action to backend without opening modal
    const complaintId = getComplaintIdFromURL(); // Get from URL or page context
    
    const taskCompletedData = {
      complaint_id: complaintId,
      type_of_action: "Task Completed",
      assigned_to: null, // Staff name will be set by backend based on session
      description: "Task has been completed by assigned staff member",
      action_datetime: new Date().toISOString()
    };
    
    console.log("Creating Task Completed entry:", taskCompletedData);
    
    // TODO: Replace with actual backend call
    // fetch('/staff/complaints/resolve-task', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify(taskCompletedData)
    // }).then(response => {
    //   if (response.ok) {
    //     alert('Task marked as completed!');
    //     window.location.reload(); // Refresh to show updated timeline
    //   }
    // });
    
    alert('Task Completed entry would be created (TODO: Backend integration)');
  }

  function getComplaintIdFromURL() {
    // TODO: Extract complaint ID from URL or page context
    return 1; // Placeholder
  }

  // TODO: Add logic to restrict action types based on staff assignment
  // When page loads, fetch the latest assignment for this staff member
  // and populate/restrict the action type dropdown accordingly
  
  </script>
</body>
</html>
