<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" 
  integrity="sha512-t7Few9xlddEmgd3oKZQahkNI4dS6l80+eGEzFQiqtyVYdvcSG2D3Iub77R20BdotfRPA9caaRkg1tyaJiPmO0g==" 
  crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/complainants.css">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <a href="/staff/complaints/assigned" class="nav-item active">Complaints</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header">
      <div class="header-content">
        <div class="header-left">
          <button class="back-arrow" onclick="goBack()" title="Back to Complaints">‚Üê</button>
          <h1>Complaint</h1>
        </div>
      </div>
    </header>

    <div class="complaint-layout" style="margin-top: 30px;">
      <div class="complaint-form">Complaint form data will load here...</div>

      <!-- Right Panel -->
      <div class="right-panel">
        <div class="map-card">Map / Asset details here...</div>

        <!-- Dynamic Timeline Component for Staff -->
        <div class="timeline" id="complaintTimeline">
          <div class="timeline-loading" id="timelineLoading" style="text-align: center; padding: 20px; color: #666;">
            Loading timeline...
          </div>
        </div>
        <button class="update-btn" onclick="openComplaint()">Update Status</button>
      </div>
    </div>

    <!-- MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <!-- HEADER -->
    <div class="modal-top">
      <div class="left-content">
        <strong>Assigned To: Maybelen Jamorawon</strong>
        <h2 class="modal-title">Inspection</h2>
      </div>
      <div id="datetime">
        <div id="date">21/10/2025</div>
        <div id="time">9:00 AM</div>
      </div>
    </div>

    <div class="modal-body">
      <!-- TODO Backend: connect to admin's instructions -->
      <div class="form-group">
        <label>Individuals to be informed:</label>
        <div class="stacked-inputs">
          <input type="text" value="Ofelia Aranzado" readonly />
          <input type="text" value="Danilo Palmero Sr." readonly />
          <input type="text" value="Elpidia Gilbuela" readonly />
          <input type="text" value="Racelyn Degala" readonly />
        </div>
      </div>
      <hr>

      <div class="form-group">
        <label>Date:</label>
        <input type="text" value="21/10/2025" class="short" readonly />
      </div>

      <div class="form-group">
        <label>Time:</label>
        <input type="text" value="9:00 AM" class="short" readonly />
      </div>

      <div class="form-group">
        <label>Venue</label>
        <input type="text" value="2nd Floor USAD-PHASELAD Office, Main Brgy. Holy Spirit" class="short" readonly />
      </div>

      <div class="form-group">
        <label>Agenda</label>
        <input type="text" value="Reblocking" class="short" readonly />
      </div>

      <hr>

      <div class="form-group">
        <label id="long">Attach the Notice of Meeting:</label>
        <div class="file-upload">
          <input type="file" id="inspectionFile" accept=".pdf,.jpg,.jpeg" multiple hidden />
          <button type="button" onclick="document.getElementById('inspectionFile').click()" style="align-items: flex-start;">Upload</button>
        </div>
      </div>

      <div class="form-group">
        <label id="short">Attached Files:</label>
        <div id="inspectionFilesList" class="attached-files"></div>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeComplaint()">Cancel</button>
      <button class="btn-save" onclick="resolveTask()">Update</button>
    </div>
  </div>
</div>
  </main>

  <script>
(function () {
  const modal = document.getElementById('modal');
  const dateEl = document.getElementById('datetime');
  const fileInput = document.getElementById("inspectionFile");
  const previewSection = document.getElementById("inspectionFilesPreview");
  const filesList = document.getElementById("inspectionFilesList");
  let interval = null;

  // Update date & time inside Action modal
  function updateComplaintDateTime() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', {
      weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'
    });
    const timeStr = now.toLocaleTimeString('en-US', {
      hour: '2-digit', minute: '2-digit', hour12: true
    });
    dateEl.innerHTML = `${dateStr}<br>${timeStr}`;
  }

  // Open Action modal directly
  function openComplaint() {
    modal.style.display = 'flex';
    updateComplaintDateTime();
    if (!interval) interval = setInterval(updateComplaintDateTime, 1000);

    // Commented out because these elements don't exist in your HTML
    // select.value = "";
    // actionOther.style.display = "none";
  }

  function closeComplaint() {
    modal.style.display = 'none';
    if (interval) {
      clearInterval(interval);
      interval = null;
    }
  }

  modal.addEventListener('click', e => {
    if (e.target === modal) closeComplaint();
  });

  window.openComplaint = openComplaint;
  window.closeComplaint = closeComplaint;
  window.updateComplaintDateTime = updateComplaintDateTime;

  // File upload preview
if (fileInput) {
  fileInput.addEventListener("change", function () {
    filesList.innerHTML = "";
    const files = Array.from(this.files);

    if (files.length > 0) {
      filesList.style.display = "block"; // show list only if files uploaded
      files.forEach(file => {
        const fileRow = document.createElement("div");
        fileRow.className = "file-item";
        fileRow.textContent = file.name;
        filesList.appendChild(fileRow);
      });
    } else {
      filesList.style.display = "none"; // hide if no files
    }
  });
}
})();

/* Files Modal */
function openFiles() {
  const modal = document.getElementById("filesModal");
  modal.style.display = "flex";
  updateFilesDateTime();
}

function closeFiles() {
  document.getElementById("filesModal").style.display = "none";
}

function updateFilesDateTime() {
  const now = new Date();
  const dateStr = now.toLocaleDateString('en-US', {
    weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'
  });
  const timeStr = now.toLocaleTimeString('en-US', {
    hour: '2-digit', minute: '2-digit', hour12: true
  });
  document.getElementById("filesDateTime").innerHTML = `${dateStr}<br>${timeStr}`;
}

document.getElementById("filesModal").addEventListener("click", e => {
  if (e.target.id === "filesModal") closeFiles();
});

/* Switch tabs */
document.querySelectorAll('.file-tabs .tab').forEach(tab => {
  tab.addEventListener('click', function () {
    document.querySelectorAll('.file-tabs .tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');

    const target = this.getAttribute('data-tab');
    document.querySelector('.uploaded-list').style.display = target === "uploaded" ? "block" : "none";
    document.querySelector('.downloadable-list').style.display = target === "downloadable" ? "block" : "none";
  });
});

/* Save Button - you don‚Äôt have .btn-save in HTML, so I commented this out
const saveBtn = document.querySelector(".btn-save");
if (saveBtn) {
  saveBtn.addEventListener("click", () => {
    const findings = document.getElementById("findings").value.trim();
    const files = Array.from(document.getElementById("inspectionFile").files);
    if (!findings) {
      alert("Inspection Findings are required.");
      return;
    }
    if (files.length === 0) {
      alert("Please attach at least one supporting document.");
      return;
    }

    const payload = {
      assigned_to: "Alberto Nonato Jr.", // Placeholder
      deadline: "29/10/2025",
      lot: "Alley 2 Sta. Catalina, Block 1, Lot 2",
      scope: "Affected lot/s, Measurement of lot/s",
      findings,
      files: files.map(f => f.name)
    };
    console.log("Submitting inspection data:", payload);
    closeComplaint();
  });
}
*/

// Resolved Task function
async function resolveTask() {
  const findings = document.getElementById("findings").value.trim();
  const files = Array.from(document.getElementById("inspectionFile").files);

  // Validation checks
  if (!findings && files.length === 0) {
    alert("Please input inspection findings and attach the supporting documents/evidence first.");
    return;
  }
  if (!findings) {
    alert("Please input inspection findings first.");
    return;
  }
  if (files.length === 0) {
    alert("Please attach the supporting documents or evidence of the inspection first.");
    return;
  }

  // If all validations pass ‚Üí proceed
  const complaintId = getComplaintIdFromURL();
  
  try {
    const response = await fetch('/admin/complaints/api/action', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        complaint_id: complaintId,
        action_type: 'Task Completed',
        description: findings,
        files: files.map(f => f.name)
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('Task completed successfully!');
      
      // Update resolved counter
      updateResolvedCounter();
      
      // Redirect to resolved view
      window.location.href = '/staff/complaints/resolved';
    } else {
      alert('Error completing task: ' + (result.error || result.message));
    }
    
  } catch (error) {
    console.error('Error completing task:', error);
    alert('Error completing task. Please try again.');
  } finally {
    // Close modal after submission
    closeComplaint();
  }
}

function getComplaintIdFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('id') || '1';
}

// Back button functionality
function goBack() {
  const urlParams = new URLSearchParams(window.location.search);
  const referrer = urlParams.get('referrer');
  
  if (referrer) {
    window.location.href = `/staff/complaints/${referrer}`;
  } else {
    window.location.href = '/staff/complaints/assigned';
  }
}

// Update resolved counter function
function updateResolvedCounter() {
  // Call parent window to refresh stats if available
  if (window.opener && !window.opener.closed) {
    try {
      window.opener.loadStats();
    } catch (e) {
      console.log('Could not update parent stats:', e);
    }
  }
  
  // Also try to update local counter if element exists
  const resolvedElement = document.getElementById('resolved-count');
  if (resolvedElement) {
    const currentCount = parseInt(resolvedElement.textContent) || 0;
    resolvedElement.textContent = currentCount + 1;
  }
}

// Make functions globally available
window.goBack = goBack;
window.updateResolvedCounter = updateResolvedCounter;

// =====================================
// DYNAMIC TIMELINE SYSTEM FOR STAFF
// =====================================

// Timeline management
let timelineData = [];
let currentRole = 'staff'; // Staff role for this page

// Load timeline data from API
async function loadTimelineData() {
  try {
    const complaintId = getComplaintIdFromURL();
    if (!complaintId) {
      console.error('No complaint ID found');
      return [];
    }
    
    console.log(`Loading timeline for complaint ${complaintId} with role ${currentRole}`);
    
    const response = await fetch(`/admin/complaints/api/timeline/${complaintId}?role=staff`, {
      credentials: 'same-origin'
    });
    
    console.log(`Timeline API response status: ${response.status}`);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error(`Timeline API error: ${response.status} - ${errorText.substring(0, 200)}`);
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('Timeline data received:', data);
    return data.timeline || [];
  } catch (error) {
    console.error('Error loading timeline data:', error);
    return [];
  }
}

// Format date for timeline display
function formatTimelineDate(dateString) {
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      month: 'numeric',
      day: 'numeric',
      year: 'numeric'
    });
  } catch (error) {
    return dateString;
  }
}

// Truncate description to one line with ellipsis
function truncateDescription(text, maxLength = 80) {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + '...';
}

// Generate default messages for actions without descriptions
function getDefaultMessage(actionType, assignedTo) {
  const messages = {
    'Inspection': `Inspection assigned and completed`,
    'Invitation': `Invitation sent to involved parties`,
    'Task Completed': `Task completed and passed back to admin`
  };
  return messages[actionType] || `${actionType} action completed`;
}

// Render timeline entries for staff
function renderTimeline(entries) {
  const timelineContainer = document.getElementById('complaintTimeline');
  const loadingElement = document.getElementById('timelineLoading');
  
  if (loadingElement) {
    loadingElement.style.display = 'none';
  }
  
  if (!entries || entries.length === 0) {
    timelineContainer.innerHTML = '<div class="timeline-empty" style="text-align: center; padding: 20px; color: #888;">No timeline entries found</div>';
    return;
  }
  
  // Sort entries by date (most recent first)
  entries.sort((a, b) => new Date(b.action_datetime) - new Date(a.action_datetime));
  
  // Generate HTML for timeline entries (staff view: actions performed + current status + task completion)
  const timelineHTML = entries.map(entry => {
    const date = formatTimelineDate(entry.action_datetime);
    const description = entry.description ? 
      truncateDescription(entry.description) : 
      getDefaultMessage(entry.type_of_action, entry.assigned_to);
    
    const fileButton = entry.has_file ? 
      `<button class="file-btn" data-pdf="${entry.file_path || '#'}" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">üìÑ File</button>` : 
      '';
    
    const assignedTo = entry.assigned_to ? `<span style="color: #666; font-size: 12px;">(${entry.assigned_to})</span>` : '';
    
    // Highlight task completion entries
    const isTaskCompletion = entry.type_of_action.includes('Task Completed') || entry.type_of_action.includes('Task completed');
    const entryStyle = isTaskCompletion ? 'border-left: 3px solid #ff9800; background-color: #fff3e0;' : 'border-left: 3px solid #2196F3; background-color: #f5f5f5;';
    
    return `
      <div class="timeline-entry" style="margin-bottom: 15px; padding: 10px; ${entryStyle}">
        <div class="timeline-date" style="font-size: 12px; color: #666; margin-bottom: 5px;">${date}</div>
        <div class="timeline-content">
          <h4 style="margin: 0 0 5px 0; color: #333; font-size: 14px;">${entry.type_of_action} ${assignedTo}</h4>
          <p style="margin: 0 0 10px 0; font-size: 13px; color: #555;">${description}</p>
          ${fileButton}
        </div>
      </div>
    `;
  }).join('');
  
  timelineContainer.innerHTML = timelineHTML;
  
  // Re-attach file button event listeners
  attachFileButtonListeners();
}

// Re-attach event listeners to file buttons
function attachFileButtonListeners() {
  document.querySelectorAll('.file-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const pdfUrl = btn.getAttribute('data-pdf');
      if (pdfUrl && pdfUrl !== '#') {
        window.open(pdfUrl, '_blank');
      } else {
        alert('No file available for this entry.');
      }
    });
  });
}

// Refresh timeline data
async function refreshTimeline() {
  try {
    const loadingElement = document.getElementById('timelineLoading');
    if (loadingElement) {
      loadingElement.style.display = 'block';
    }
    
    const entries = await loadTimelineData();
    timelineData = entries;
    renderTimeline(entries);
  } catch (error) {
    console.error('Error refreshing timeline:', error);
    const timelineContainer = document.getElementById('complaintTimeline');
    timelineContainer.innerHTML = '<div class="timeline-error" style="text-align: center; padding: 20px; color: #d32f2f;">Error loading timeline. Please refresh the page.</div>';
  }
}

// Initialize timeline on page load
document.addEventListener('DOMContentLoaded', function() {
  refreshTimeline();
});

// Make timeline functions globally available
window.refreshTimeline = refreshTimeline;
</script>

</body>
</html>
