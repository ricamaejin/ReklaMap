{# --- complaint_details_boundary.html --- #}
{# Marker to signal Boundary complaint context to JS dispatcher #}
<div id="__boundary_form_marker" style="display:none;" aria-hidden="true"></div>
{# --- Dynamic Boundary Dispute Preview Partial --- #}

{% if registration and registration.category == 'non_member' %}
  {% set block_lots = [] %}
  {% if complaint and complaint.boundary_dispute %}
    {% if complaint.boundary_dispute.block_lot is string %}
      {% if complaint.boundary_dispute.block_lot.strip().startswith('[') %}
        {% set block_lots = complaint.boundary_dispute.block_lot | from_json %}
      {% endif %}
    {% elif complaint.boundary_dispute.block_lot is iterable and complaint.boundary_dispute.block_lot|length > 0 %}
      {% set block_lots = complaint.boundary_dispute.block_lot %}
    {% endif %}
  {% endif %}

  {% if block_lots and block_lots|length > 0 %}
    <div id="nonMemberBlockLotSection">
      <p>Please indicate your Block and Lot number.</p>
      <div class="pairs" id="pairsContainer" aria-live="polite">
        {% for pair in block_lots %}
          {% set block = pair.block if pair.block is defined else pair['block'] if pair['block'] is defined else '' %}
          {% set lot = pair.lot if pair.lot is defined else pair['lot'] if pair['lot'] is defined else '' %}
          {% if block or lot %}
          <div class="pair-row">
            <div class="col">
              <label class="small">Block No.</label>
              <input type="text" value="{{ block }}" readonly placeholder="Block No.">
            </div>
            <div class="col">
              <label class="small">Lot No.</label>
              <input type="text" value="{{ lot }}" readonly placeholder="Lot No.">
            </div>
          </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% else %}
    <div class="readonly-value" style="margin-bottom: 12px;">No Block/Lot information provided.</div>
  {% endif %}
{% endif %}

{% for field in form_structure %}
  {# --- Radio (excluding q14, q15) --- #}
  {% if field.type == 'radio' and field.name not in ['q14', 'q15'] %}
    <p>{{ field.label|safe }}</p>
    <div class="radio-group">
      {% set selected = (answers[field.name]|string|trim|lower) if field.name in answers else '' %}
      {% for val, label in field.options %}
        {% set normalized_val = val|string|trim|lower %}
        {% set normalized_label = label|string|trim|lower %}
        {% set checked = (selected == normalized_val or selected == normalized_label) %}
        <label class="option">
          <input type="radio" name="{{ field.name }}" value="{{ val }}" disabled {% if checked %}checked{% endif %}>
          {{ label }}
        </label>

        {% if field.conditional is defined and field.conditional.trigger_value is defined and field.conditional.additional_fields is defined %}
          {% set trigger = field.conditional.trigger_value|string|trim|lower %}
          {% if (normalized_val == trigger or normalized_label == trigger) and selected == trigger %}
            <div style="margin-left: 38px;">
              {% for subfield in field.conditional.additional_fields %}
                {% if subfield.type == 'date' %}
                  <p>{{ subfield.label }}</p>
                  <input type="date" value="{{ answers[subfield.name] }}" style="width: 20%;" disabled>
                {% elif subfield.type == 'text' %}
                  <p>{{ subfield.label }}</p>
                  <input type="text" value="{{ answers[subfield.name] }}" disabled>
                {% elif subfield.type == 'checkbox' %}
                  <p>{{ subfield.label|safe }}</p>
                  {% set raw_val = answers.get(subfield.name, []) %}
                  {% set selected_sub = [] %}
                  {% if raw_val is string %}
                    {% if raw_val.strip().startswith('[') and raw_val.strip().endswith(']') %}
                      {% set selected_sub = raw_val|from_json %}
                    {% elif ',' in raw_val %}
                      {% set selected_sub = raw_val|replace(' ', '')|split(',') %}
                    {% elif raw_val %}
                      {% set selected_sub = [raw_val] %}
                    {% endif %}
                  {% elif raw_val is iterable and raw_val is not mapping %}
                    {% set selected_sub = raw_val %}
                  {% elif raw_val is not none %}
                    {% set selected_sub = [raw_val] %}
                  {% endif %}

                  <div class="checkbox-group">
                    {% for val2, label2 in subfield.options %}
                      {% set normalized_val2 = val2|string|trim|lower %}
                      {% set checked_ns = namespace(value=false) %}
                      {% for sel in selected_sub %}
                        {% if sel|string|trim|lower == normalized_val2 %}
                          {% set checked_ns.value = true %}
                        {% endif %}
                      {% endfor %}
                      <label class="option">
                        <input type="checkbox" name="{{ subfield.name }}" value="{{ val2 }}" disabled {% if checked_ns.value %}checked{% endif %}>
                        {{ label2 }}
                      </label>
                    {% endfor %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  {# --- Checkbox fields --- #}
  {% if field.type == 'checkbox' %}
    <p>{{ field.label|safe }}</p>
    {% set raw_val = answers.get(field.name, []) %}
    {% set selected = [] %}
    {% if raw_val is string %}
      {% if raw_val.strip().startswith('[') and raw_val.strip().endswith(']') %}
        {% set selected = raw_val|from_json %}
      {% elif ',' in raw_val %}
        {% set selected = raw_val|replace(' ', '')|split(',') %}
      {% elif raw_val %}
        {% set selected = [raw_val] %}
      {% endif %}
    {% elif raw_val is iterable and raw_val is not mapping %}
      {% set selected = raw_val %}
    {% elif raw_val is not none %}
      {% set selected = [raw_val] %}
    {% endif %}

    <div class="checkbox-group">
      {% for val, label in field.options %}
        {% set normalized_val = val|string|trim|lower %}
        {% set checked_ns = namespace(value=false) %}
        {% for sel in selected %}
          {% if sel|string|trim|lower == normalized_val %}
            {% set checked_ns.value = true %}
          {% endif %}
        {% endfor %}
        <label class="option">
          <input type="checkbox" name="{{ field.name }}" value="{{ val }}" disabled {% if checked_ns.value %}checked{% endif %}>
          {{ label }}
        </label>
      {% endfor %}
    </div>
  {% endif %}

  {# --- After Q11: Persons Involved Details --- #}
  {% if field.name == 'q11' %}
    <div class="section-header">PERSONS INVOLVED DETAILS</div>
    {% for pfield in form_structure if pfield.name in ['q12','q13','q14','q15'] %}
      {% if pfield.name == 'q12' %}
        <p>1. Who are the persons and specific block and lot numbers involved in the boundary dispute?</p>
        {% set raw_q12 = answers.get(pfield.name, []) %}
        {% if raw_q12 %}
          {% set parsed = raw_q12 if raw_q12 is iterable else raw_q12|from_json %}
          {% for row in parsed %}
            <div class="pair-row" style="display:flex;gap:12px;margin-bottom:6px;">
              <input type="text" value="{{ row['name'] or '' }}" readonly placeholder="Name of Person">
              <input type="text" value="{{ row['block'] or '' }}" readonly placeholder="Block No.">
              <input type="text" value="{{ row['lot'] or '' }}" readonly placeholder="Lot No.">
            </div>
          {% endfor %}
        {% else %}
          <div class="readonly-value">N/A</div>
        {% endif %}
      {% elif pfield.name == 'q13' %}
        <p>2. Relationship with the person involved</p>
        {% set rel = answers.get(pfield.name, []) %}
        {% if rel %}
          {% set rels = rel if rel is iterable else rel|from_json %}
          {% for item in rels %}
            <input type="text" value="{{ item }}" readonly style="margin-bottom:4px;">
          {% endfor %}
        {% else %}
          <div class="readonly-value">N/A</div>
        {% endif %}
      {% elif pfield.name == 'q14' %}
        <p>3. Do they reside on or near the disputed boundary?</p>
        <div class="radio-group">
          {% set selected = (answers[pfield.name]|string|trim|lower) if pfield.name in answers else '' %}
          {% for val, label in pfield.options %}
            {% set normalized_val = val|string|trim|lower %}
            {% set checked = (selected == normalized_val) %}
            <label class="option">
              <input type="radio" name="{{ pfield.name }}" value="{{ val }}" disabled {% if checked %}checked{% endif %}>
              {{ label }}
            </label>
          {% endfor %}
        </div>
      {% elif pfield.name == 'q15' %}
        <p>4. Do they claim to have legal or assignment documents?</p>
        {% set selected = (answers[pfield.name]|string|trim|lower) if pfield.name in answers else '' %}
        <div class="radio-group">
          {# --- YES Option --- #}
          {% for val, label in pfield.options if label|lower == 'yes' %}
            {% set normalized_val = val|string|trim|lower %}
            {% set checked = (selected == normalized_val) %}
            <label class="option">
              <input type="radio" name="{{ pfield.name }}" value="{{ val }}" disabled {% if checked %}checked{% endif %}>
              {{ label }}
            </label>

            {% if checked and pfield.conditional is defined %}
              <div style="margin-left:38px;margin-top:6px;">
                {% for subfield in pfield.conditional.additional_fields %}
                  <p>{{ subfield.label }}</p>
                  {% set raw_val = answers.get(subfield.name, []) %}
                  {% set selected_sub = raw_val if raw_val is iterable else [raw_val] %}
                  <div class="checkbox-group">
                    {% for val2, label2 in subfield.options %}
                      {% set checked_ns = namespace(value=false) %}
                      {% for sel in selected_sub %}
                        {% if sel|string|trim|lower == val2|string|trim|lower %}
                          {% set checked_ns.value = true %}
                        {% endif %}
                      {% endfor %}
                      <label class="option">
                        <input type="checkbox" name="{{ subfield.name }}" value="{{ val2 }}" disabled {% if checked_ns.value %}checked{% endif %}>
                        {{ label2 }}
                      </label>
                    {% endfor %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          {% endfor %}

          {# --- NO Option (always shown after YES) --- #}
          {% for val, label in pfield.options if label|lower == 'no' %}
            {% set normalized_val = val|string|trim|lower %}
            {% set checked = (selected == normalized_val) %}
            <label class="option">
              <input type="radio" name="{{ pfield.name }}" value="{{ val }}" disabled {% if checked %}checked{% endif %}>
              {{ label }}
            </label>
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}

{# --- Final description --- #}
<p class="section-label" style="color:black;font-weight:normal;">
  Please describe what happened briefly, including how you found out about the issue.
</p>
<textarea readonly>{{ answers.get('description', '') }}</textarea>
