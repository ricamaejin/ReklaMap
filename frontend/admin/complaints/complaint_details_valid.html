<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/complainants.css">
  <style>
    .accept-invitation-btn {
      background: #28a745 !important;
      color: white !important;
      border: none !important;
      padding: 5px 10px !important;
      border-radius: 3px !important;
      cursor: pointer !important;
      margin-left: 10px !important;
      font-size: 12px !important;
    }
    .accept-invitation-btn:hover {
      background: #218838 !important;
    }
    .modal-body p {
      margin: 10px 0;
    }
    .modal-actions {
      margin-top: 20px;
      text-align: center;
    }
    .timeline-entry[data-status="accepted-invitation"] {
      border-left: 4px solid #28a745;
      background-color: #f8fff9;
    }
    .timeline-entry[data-status="send-invitation"] {
      border-left: 4px solid #ffc107;
      background-color: #fffbf0;
    }
    .timeline-clickable:hover {
      background-color: #f8f9fa !important;
      border-left-color: #007bff !important;
      transform: translateX(2px);
      transition: all 0.2s ease;
    }
    .timeline-clickable {
      transition: all 0.2s ease;
    }
    
    .unresolved-btn {
      background: #ffc107 !important;
      color: #212529 !important;
      border: none !important;
      border-radius: 6px !important;
      padding: 12px 20px !important;
      font-weight: bold !important;
      cursor: pointer !important;
    }
    
    .unresolved-btn:hover {
      background: #e0a800 !important;
    }

    .resolved-btn:hover{
      background-color: #007bff;
    }
    
    .button-container .resolved-btn {
      margin-top: 0 !important;
    }
    
    /* Make all action modal labels white */
    .modal-overlay label,
    #modal label,
    #assignModal label,
    #recommendModal label,
    #acceptInvitationModal label {
      color: white !important;
    }
    
    /* Ensure red asterisks remain visible on white labels */
    .modal-overlay label span[style*="color:red"],
    #modal label span[style*="color:red"],
    #assignModal label span[style*="color:red"],
    #recommendModal label span[style*="color:red"],
    #acceptInvitationModal label span[style*="color:red"] {
      color: #ff6b6b !important;
    }
    
    /* Read-only styles for final complaint states */
    /* Hide only Resolve/Unresolve buttons */
    .readonly-mode .resolved-btn,
    .readonly-mode .unresolve-btn,
    .readonly-mode .modal-buttons .resolved-btn,
    .readonly-mode .modal-buttons .unresolve-btn,
    .readonly-mode button[onclick*="showResolveModal"],
    .readonly-mode button[onclick*="showUnresolvedModal"] {
      display: none !important;
    }
    
    /* Disable other action buttons but keep them visible */
    .readonly-mode button:not(.back-arrow):not(.resolved-btn):not(.unresolve-btn):not(.file-btn) {
      opacity: 0.5 !important;
      pointer-events: none !important;
      cursor: not-allowed !important;
    }
    
    .readonly-mode .timeline .file-btn {
      display: inline-block !important; /* Keep file buttons visible and functional */
      opacity: 1 !important;
      pointer-events: auto !important;
    }
    
    .readonly-mode .timeline-entry {
      pointer-events: none;
    }
    
    .readonly-mode-banner {
      background: linear-gradient(135deg, #f39c12, #e74c3c);
      color: white;
      padding: 15px;
      margin-bottom: 5px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .readonly-mode-banner.resolved {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
    }
    
    .readonly-mode-banner.unresolved {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }
    
    .readonly-mode-banner.out-of-jurisdiction {
      background: linear-gradient(135deg, #f39c12, #d68910);
    }
  </style>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <a href="/admin/dashboard" class="nav-item">Map</a>
      <a href="/admin/complaints/all.html" class="nav-item active">Complaints</a>
      <a href="/admin/database/beneficiaries.html" class="nav-item">Beneficiaries</a>
      <a href="/admin/database/policies.html" class="nav-item">Policies</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header">
      <div class="header-content">
        <div class="header-left">
          <button class="back-arrow" onclick="goBack()" title="Back to Complaints">←</button>
          <h1>Complaint</h1>
        </div>
      </div>
    </header>

    <div class="complaint-layout" style="margin-top: 30px;">
      <!-- Complaint Form (will be populated dynamically) -->
      <div class="complaint-form" id="complaintFormContainer">Loading complaint form...</div>


      <!-- Right Panel -->
      <div class="right-panel">
        <div class="map-card" id="mapCard">
          <div id="mapLoading" style="text-align: center; padding: 20px; color: #666;">Loading map...</div>
          <div id="mapContent" style="display: none;">
            <h4 id="areaTitle">Area Map</h4>
            <div id="svgContainer" style="width: 100%; height: 300px; overflow: hidden; border: 2px solid #ddd; border-radius: 8px; position: relative;"></div>
          </div>
          <div id="mapError" style="display: none; text-align: center; padding: 20px; color: #999;">
            <p>Map not available</p>
          </div>
        </div>
        <button class="action-btn" onclick="openComplaint()">Action</button>

         <!-- Dynamic Timeline Component -->
        <div class="timeline" id="complaintTimeline">
          <div class="timeline-loading" id="timelineLoading" style="text-align: center; padding: 20px; color: #666;">
            Loading timeline...
          </div>
        </div>
        <div class="button-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
          <button class="resolved-btn" onclick="showResolveModal()" style="flex: 1 1 45%;">Resolved</button>
          <button class="unresolved-btn" onclick="showUnresolvedModal()" style="flex: 1 1 45%;">Unresolved</button>
        </div>

      </div>
    </div>

    <!-- RECOMMENDED ACTION MODAL -->
    <div class="modal-overlay" id="recommendModal" style="display:none;">
      <div class="modal">
        <div class="modal-header">
          <h2>Recommended Action</h2>
        </div>
        <hr>

        <!-- Recommendation Description -->
        <!-- TODO BACKEND: Replace static description from backend -->
        <textarea style="width: 100%; height: 200px; text-align: justify; padding: 20px 30px; box-sizing: border-box;">Based on system analysis, we recommend the following action: 
  
  - Assign an Inspection to the assigned personnel (Alberto Nonato Jr.). The inspection should cover safety, affected lots, and measurement of lots.
  
  - Notify all relevant parties about the inspection details and ensure their availability.
        </textarea>

        <div class="modal-footer">
          <button class="btn-save" onclick="proceedToAssign()">Assign</button>
          <button class="btn-save" onclick="proceedToAction()">Proceed</button>
        </div>
      </div>
    </div>

    <!-- ACTION MODAL -->
    <div class="modal-overlay" id="modal" style="display:none;">
      <div class="modal" style="display:flex; flex-direction:column; max-height:80vh;">
        <div class="modal-header">
          <h2>Action</h2>
          <div id="actionDatetime"><div id="actionDate"></div><div id="actionTime"></div></div>
        </div>
        <hr>

        <div class="modal-body" style="flex:1; overflow-y:auto; overflow-x:hidden; padding-right:10px; padding-left:0;">
          <label for="actionType">Type of Action:</label>
          <div class="type-action-row">
            <select id="actionType" name="actionType" aria-label="Type of Action">
              <option value="" disabled selected hidden>Select Action</option>
              <option value="Assessment">Assessment</option>
              <option value="Mediation">Mediation</option>
              <option value="Out of Jurisdiction" style="color: red;">Out of Jurisdiction</option>
            </select>
          </div>

          <!-- FIELDS FOR ASSESSMENT -->
          <div class="action-fields" id="actionAssessmentFields" style="display:none; width:100%;">
            <label style="display:block; margin-bottom:6px; font-weight:bold;">Assessment Details:<span style="color:red;">*</span></label>
            <textarea 
              id="assessmentNotes" 
              required 
              style="width:95%; margin:0 auto; display:block; height:120px; box-sizing:border-box; resize:vertical; padding:8px; border:1px solid #ccc; border-radius:6px; font-size:14px;"
            ></textarea>
          </div>

          <!-- FIELDS FOR MEDIATION -->
          <div class="action-fields" id="actionMediationFields" style="display:none;">
            <!-- Assigned Personnel -->
            <div class="form-group">
            <label>Assigned Personnel:</label>
              <input id="medAssignedPersonnel" type="text" name="medAssignedPersonnel" value="Josie Rosal" readonly class="readonly-input">
            </div>
            <!-- Parties Involved  -->
            <div class="form-group">
              <label>Parties Involved:</label>
              <div id="medPartiesInvolved"></div>
            </div>
            <hr>
            <!-- Agenda -->
            <div class="form-group">
            <label>Agenda:<span style="color:red;">*</span></label>
            <input type="text" name="agenda" placeholder="Agenda">
            </div>
            <!-- Advisors/Witnesses -->
            <div class="form-group">
              <label>Advisors / Witnesses:<span style="color:red;">*</span></label>
              <div id="witnessContainer">
                <div class="witness-row">
                  <input type="text" name="witness[]" placeholder="Enter name" style="background-color: #ffffff;" required>
                </div>
              </div>
            </div>
            <div class="form-group">
              <button class="form-group-button" type="button" onclick="addWitness()">+ Add Witness</button>
            </div>
            <!-- Summary -->
            <div class="form-group">
            <label>Summary:<span style="color:red;">*</span></label>
            <textarea name="summary" placeholder="Enter mediation summary" required></textarea>
            </div>
            <!-- File uploads -->
            <div class="form-group" style="display:flex; align-items:flex-start; gap:10px;">
              <label style="flex:0 0 150px; font-weight:bold; margin-top:6px;">
                Upload Files:<span style="color:red;">*</span>
              </label>

              <div id="fileUploadContainer" style="flex:1; display:flex; flex-direction:column; gap:0px;">
                <!-- First file upload row -->
                <div class="fileUp-row">
                  <div class="fileUp-top">
                    <input type="text" name="fileDescription[]" placeholder="File type (e.g. Proof, Document)" required >
                  </div>
                  <div class="fileUp-bottom">
                    <input type="file" name="mediationFiles[]" id="fileInput1" style="display:none;"
                      onchange="var f=this.files.length?this.files[0].name:'';var s=document.getElementById('fileName1');s.textContent=f;s.title=f;">
                    <button type="button" class="file-upload-btn" onclick="document.getElementById('fileInput1').click()">Upload</button>
                    <span class="file-name" id="fileName1"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <button class="form-group-button" type="button" onclick="addFileUpload()">+ Add Another File</button>
            </div>
          </div>
            <!-- Out of Jurisdiction -->
            <div class="action-fields" id="actionOutOfJurisdictionFields" style="display:none; width:100%;">
              <label style="display:block; font-weight:bold; margin-bottom:6px;">Under the Scope of:<span style="color:red;">*</span></label>
              <div 
                class="checkbox-group-compact" 
                style="display:block; margin-left:15px; margin-top:10px;"
              >
                <label class="checkbox-item-compact" style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                  <input type="radio" name="outOfJurisdiction" value="Barangay" style="width:18px; height:18px; cursor:pointer;"> Barangay
                </label>
                <label class="checkbox-item-compact" style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                  <input type="radio" name="outOfJurisdiction" value="NGC" style="width:18px; height:18px; cursor:pointer;"> NGC
                </label>
                <label class="checkbox-item-compact" style="display:flex; align-items:center; gap:6px;">
                  <input type="radio" id="outOthersRadio" name="outOfJurisdiction" value="Others" style="width:18px; height:18px; cursor:pointer;"> Others
                </label>
                <input 
                  type="text" 
                  id="outOthersInput" 
                  placeholder="Please specify" 
                  style="display:none; margin-top:5px; margin-left:25px; width:93%; padding:4px 8px; border:1px solid #ccc; border-radius:4px; font-size:14px;"
                />
              </div>
            <label style="display:block; margin-bottom:6px; font-weight:bold;">Out of Jurisdiction Remarks:<span style="color:red;">*</span></label>
                <textarea 
                  id="outOfJurisdictionNotes" 
                  required 
                  style="width:95%; margin:0 auto; display:block; height:120px; box-sizing:border-box; resize:vertical; padding:8px; border:1px solid #ccc; border-radius:6px; font-size:14px;"
                ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-cancel" onclick="(function(){ closeComplaint(); recommendModal.style.display='flex'; })()">Cancel</button>
            <button id="modalSaveBtn" class="btn-save" onclick="saveAction()">Save</button>
          </div>
      </div>
    </div>
</div>
    <!-- ASSIGN MODAL -->
    <div class="modal-overlay" id="assignModal" style="display:none;"> 
      <div class="modal" style="display:flex; flex-direction:column; max-height:80vh;">
        <div class="modal-header">
          <h2>Assign</h2>
          <div id="assignDatetime"><div id="assignDate"></div><div id="assignTime"></div></div>
        </div>
        <hr>

        <!-- Scrollable body for assign modal -->
        <div class="modal-body" style="flex:1; overflow-y:auto; overflow-x:hidden; padding-right:10px; padding-left:0;">
          <label for="assignType">Type of Assignment:</label>
          <div class="type-action-row">
            <select id="assignType" name="assignType" aria-label="Type of Assignment">
              <option value="" disabled selected hidden>Select Assignment</option>
              <option value="Inspection">Inspection</option>
              <option value="Invitation">Invitation</option>
            </select>
          </div>

          <!-- FIELDS FOR INSPECTION -->
          <div class="action-fields" id="assignInspectionFields" style="display:none;">
            <!-- Assigned Personnel -->
            <div class="form-group">
              <label>Assigned Personnel:</label>
              <input id="assignedPersonnel" type="text" readonly class="readonly-input">
            </div>
            <!-- Location of Inspection -->
            <div class="form-group">
              <label>Location of Inspection:</label>
              <input id="inspectionLocation" type="text" value="Alley 2 HOA" readonly class="readonly-input">
            </div>            
            <hr>
            <!-- Deadline -->
            <div class="form-group">
              <label>Deadline:<span style="color:red;">*</span></label>
              <input id="inspectionDeadline" type="date" required style="margin-left: 30x;">
            </div>
            <!-- Scope of Inspection (compact) -->
            <div class="form-group">
              <label>Scope of Inspection:<span style="color:red;">*</span></label>
                <div class="checkbox-group-compact">
                  <label class="checkbox-item-compact"><input type="checkbox" name="scope[]" value="safety"> Safety</label>
                  <label class="checkbox-item-compact"><input type="checkbox" name="scope[]" value="affected_lots"> Affected lot/s</label>
                  <label class="checkbox-item-compact"><input type="checkbox" name="scope[]" value="measurement"> Measurement of lot/s</label>
                  <label class="checkbox-item-compact"><input type="checkbox" name="scope[]" value="relation_owner"> Relation to the lot owner (if non-HOA)</label>
                  <label class="checkbox-item-compact"><input type="checkbox" id="othersCheckbox"> Others</label>
                  <input type="text" id="othersInput" name="scope[]" placeholder="Please specify" style="display:none; margin-top:5px; margin-left: 25px;" />
                </div>
            </div>
          </div>

         <!-- FIELDS FOR INVITATION -->
          <div class="action-fields" id="assignInvitationFields" style="display:none;">
           
            <!-- To -->
            <div class="form-group">
              <label for="invTo">To:</label>
              <div id="invTo"></div>
            </div>

             <!-- Location -->
            <div class="form-group">
              <label for="invLocation">Location:</label>
              <input id="invLocation" type="text" name="location" value="Autofilled Location" readonly class="readonly-input">
            </div>
            
            <!-- Agenda -->
            <div class="form-group">
              <label for="invAgenda">Agenda:</label>
              <input type="text" id="invAgenda" name="agenda" readonly class="readonly-input">
            </div>
            <!-- Recipients Address (autofilled) -->
            <div class="form-group">
              <label for="invRecipientsAddress">Recipients Address:</label>
              <input id="invRecipientsAddress" type="text" name="recipients_address" readonly class="readonly-input">
            </div>
            <hr>

            <!-- Date of Meeting -->
            <div class="form-group">
              <label for="invDate">Date of Meeting:<span style="color:red;">*</span></label>
              <input id="invDate" type="date" name="meeting_date" required>
            </div>
            
            <!-- Time of Meeting -->
            <div class="form-group">
              <label for="invTime">Time of Meeting: <span style="color:red;">*</span></label>
              <input id="invTime" type="time" name="meeting_time" required>
            </div>

            <!-- Assigned Personnel -->
            <div class="form-group">
              <label for="invAssignedPersonnel">Assigned Personnel:<span style="color:red;">*</span></label>
            <select id="invAssignedPersonnel" name="assigned_personnel" required>
              <option value="" disabled selected hidden>Select Personnel</option>
              <option value="Maybelen Jamorawon">Maybelen Jamorawon</option>
              <option value="Agnes Bartolome">Agnes Bartolome</option>
            </select>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-cancel" onclick="(function(){ closeComplaint(); recommendModal.style.display='flex'; })()">Cancel</button>
          <button id="assignSaveBtn" class="btn-save" onclick="saveAction()">Save</button> 
        </div>
      </div>
    </div>

    <!-- ACCEPTED INVITATION MODAL -->
    <div class="modal-overlay" id="acceptInvitationModal" style="display:none;">
      <div class="warning-modal">
        <div class="warning-header">
          ⚠️ WARNING MESSAGE
        </div>
        <div class="warning-body">
          <div class="warning-text">
            <p style="align-items: center !important;">Are you sure both parties have accepted the invitation?</p>
            <p style="align-items: center !important;"><strong>This will update the timeline status to "Accepted Invitation".</strong></p>
          </div>
        </div>
        <div class="warning-footer">
          <button onclick="confirmAcceptedInvitation()" style="background: #28a745; color: white; margin-right: 10px;">Yes, Both Parties Accepted</button>
          <button onclick="closeAcceptInvitationModal()" style="background: #6c757d; color: white;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- FILES MODAL -->
    <div id="filesModal" class="files-modal-overlay" style="display:none;">
      <div class="files-modal">
        <div class="files-header">
          <h2>Files</h2><div id="filesDateTime"></div>
        </div>
        <hr>

        <div class="file-tabs">
          <span class="tab active" data-tab="downloadable">Downloadable</span>
          <span class="tab" data-tab="uploaded">Upload File</span>
        </div>

        <div class="file-list downloadable-list"></div>

        <div class="file-list uploaded-list" style="display:none;">
          <div class="file-row">
            <span>Upload new file:</span>
            <!-- TODO BACKEND: Handle file uploads from userFileInput and store in server -->
            <input type="file" id="userFileInput" accept=".pdf,.jpeg,.jpg,.png" />
          </div>
          <div id="userFilesContainer"></div>
        </div>

        <div class="files-footer"><button class="close-btn" onclick="closeFiles()">Close</button></div>
      </div>
    </div>

    <!-- RESOLVE CONFIRMATION MODAL -->
    <div class="modal-overlay" id="resolveModal" style="display:none;">
      <div class="warning-modal">
        <div class="warning-header">
          ⚠️ WARNING MESSAGE
        </div>
        <div class="warning-body">
          <div class="warning-text">
            <p style="align-items: center !important;">Are you sure to mark this complaint as Resolved?</p>
          </div>
        </div>
        <div class="warning-footer">
          <button onclick="resolveComplaint()" style="background: #dc3545; color: white; margin-right: 10px;">Yes, Mark as Resolved</button>
          <button onclick="closeResolveModal()" style="background: #6c757d; color: white;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- UNRESOLVE CONFIRMATION MODAL -->
    <div class="modal-overlay" id="unresolveModal" style="display:none;">
      <div class="warning-modal">
        <div class="warning-header">
          ⚠️ WARNING MESSAGE
        </div>
        <div class="warning-body">
          <div class="warning-text">
            <p style="align-items: center !important;">Are you sure to mark this complaint as Unresolved?</p>
            <p style="color: #6c757d; font-size: 0.9em; margin-top: 10px;">This will change the complaint status and may affect reporting and tracking.</p>
          </div>
        </div>
        <div class="warning-footer">
          <button onclick="unresolveComplaint()" style="background: #ffc107; color: #212529; margin-right: 10px;">Yes, Mark as Unresolved</button>
          <button onclick="closeUnresolveModal()" style="background: #6c757d; color: white;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Custom Alert Modal -->
    <div class="modal-overlay" id="alertModal" style="display: none;">
      <div class="warning-modal">
        <div class="warning-header">
          ⚠️ WARNING MESSAGE
        </div>
        <div class="warning-body">
          <div class="warning-text">
            <p id="alertMessage" style="align-items: center !important;"></p>
          </div>
        </div>
        <div class="warning-footer">
          <button onclick="closeCustomAlert()">OK</button>
        </div>
      </div>
    </div>

    <!-- TIMELINE PREVIEW MODAL -->
    <div class="modal-overlay" id="timelinePreviewModal" style="display:none;">
      <div class="modal" style="display:flex; flex-direction:column; max-height:80vh;">
        <div class="modal-top">
          <h2 id="previewModalTitle">Action Details</h2>
          <span class="close" onclick="closeTimelinePreview()" style="cursor: pointer;">&times;</span>
        </div>
        <div class="modal-body" id="previewModalBody" style="overflow-y: auto; flex: 1;">
          <!-- Dynamic content will be loaded here -->
        </div>
        <div class="modal-footer" style="margin-top: auto; padding: 15px; border-top: 1px solid #ddd;">
          <div id="previewModalActions">
            <button type="button" onclick="closeTimelinePreview()" class="btn-secondary">Close</button>
            <button type="button" id="editPreviewAction" onclick="editTimelineEntry()" class="btn-primary" style="display: none;">Edit</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
  (function () {
    const modal = document.getElementById('modal');               // Action modal
    const assignModal = document.getElementById('assignModal');   // Assign modal
    const recommendModal = document.getElementById("recommendModal"); // Recommended modal

    let interval = null;

    // Read complaint ID from URL so saveAction can use it
    const urlParams = new URLSearchParams(window.location.search);
    const currentComplaintId = urlParams.get("id");
    console.log("currentComplaintId (from URL) =", currentComplaintId);
    let autofillCache = null;

    function tryParseJSONString(s) {
      if (!s || typeof s !== 'string') return s;
      try {
        let str = s;
        if ((str.startsWith('"') && str.endsWith('"')) || (str.startsWith("'") && str.endsWith("'"))) {
          str = str.slice(1, -1).replace(/\\"/g, '"').replace(/\\'/g, "'");
        }
        if (str.trim().startsWith('{') || str.trim().startsWith('[')) return JSON.parse(str);
      } catch (e) {}
      return s;
    }

    function loadAutofill() {
      if (!currentComplaintId) return Promise.resolve({});
      if (autofillCache) return Promise.resolve(autofillCache);
      return fetch(`/admin/complaints/api/action_autofill/${currentComplaintId}`, { credentials: 'same-origin' })
        .then(r => {
          if (!r.ok) {
            console.warn('Autofill fetch responded with', r.status);
            return {};
          }
          return r.json();
        })
        .then(data => { autofillCache = data || {}; return autofillCache; })
        .catch(err => { console.error('Error fetching autofill data:', err); return {}; });
    }

    function applyAutofillToAssign(data) {
      // Invitation fields
      const invToEl = document.getElementById("invTo");
      const invAgendaEl = document.getElementById("invAgenda");
      const invLocationEl = document.getElementById("invLocation");
      const invDateEl = document.getElementById("invDate");
      const invTimeEl = document.getElementById("invTime");
      if (invToEl) {
        invToEl.innerHTML = ""; // clear any existing fields
        const names = (data.to || "")
          .split(",")
          .map(s => s.trim())
          .filter(Boolean);

        names.forEach(name => {
          const input = document.createElement("input");
          input.type = "text";
          input.name = "to[]"; // match your form naming
          input.value = name;
          input.readOnly = true;
          input.classList.add("party-input"); // reuse same styling
          invToEl.appendChild(input);
        });
      }

      if (invAgendaEl) invAgendaEl.value = data.agenda || '';
      if (invLocationEl) invLocationEl.value = data.location || '2nd FLR. USAD-PHASELAD OFFICE, BAYANIHAN BUILDING BARANGAY MAIN';
      const invRecipientsAddressEl = document.getElementById('invRecipientsAddress');
      if (invRecipientsAddressEl) {
        const addr = data.address || data.inspection_location_pretty || data.location || '';
        invRecipientsAddressEl.value = addr;
      }

      // Inspection fields
      const assignedPersonnelEl = document.getElementById('assignedPersonnel');
      const inspectionLocationEl = document.getElementById('inspectionLocation');
      if (data.inspection_assigned_personnel && assignedPersonnelEl) assignedPersonnelEl.value = data.inspection_assigned_personnel; else if (assignedPersonnelEl) assignedPersonnelEl.value = '';

          let inspectionLoc = '';
          if (data.inspection_location_raw) {
            const parsed = tryParseJSONString(data.inspection_location_raw);
            if (Array.isArray(parsed) && parsed.length && parsed[0].block) inspectionLoc = `Block ${parsed[0].block}, Lot ${parsed[0].lot}`;
            else if (typeof parsed === 'object' && parsed.block) inspectionLoc = `Block ${parsed.block}, Lot ${parsed.lot}`;
            else if (typeof parsed === 'string') inspectionLoc = parsed;
          } else if (data.inspection_location) {
            const parsed = tryParseJSONString(data.inspection_location);
            if (Array.isArray(parsed) && parsed.length && parsed[0].block) inspectionLoc = `Block ${parsed[0].block}, Lot ${parsed[0].lot}`;
            else if (typeof parsed === 'object' && parsed.block) inspectionLoc = `Block ${parsed.block}, Lot ${parsed.lot}`;
            else if (typeof parsed === 'string') inspectionLoc = parsed;
          }
          if (!inspectionLoc && (data.block_no || data.lot_no)) inspectionLoc = `${data.address || ''}${data.address ? ', ' : ''}Block ${data.block_no || ''}, Lot ${data.lot_no || ''}`.trim();
      if (inspectionLocationEl) inspectionLocationEl.value = data.inspection_location_pretty || inspectionLoc || '';
        }

        function applyAutofillToAction(data) {
          // Mediation: only autofill the fields requested: agenda, assigned personnel, and parties involved
            const agendaInput = document.querySelector("input[name='agenda']");
            if (agendaInput && data.agenda) agendaInput.value = data.agenda;

            const medAssignedEl = document.getElementById('medAssignedPersonnel');
            if (medAssignedEl) medAssignedEl.value = data.med_assigned_personnel || medAssignedEl.value || 'Josie Rosal';

            const medPartiesEl = document.getElementById('medPartiesInvolved');
            if (medPartiesEl) {
              medPartiesEl.innerHTML = ''; // clear any existing fields
              const inviteNames = (data.to || '')
                .split(',')
                .map(s => s.trim())
                .filter(Boolean);

              inviteNames.forEach(name => {
                const input = document.createElement('input');
                input.type = 'text';
                input.name = 'parties_involved[]';
                input.value = name;
                input.readOnly = true;
                input.classList.add('party-input');
                medPartiesEl.appendChild(input);
            });
          }
        }

    // Update date & time inside whichever modal is open - uses frontend current time
    function updateComplaintDateTime(targetId) {
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-US', {
        weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'
      });
      const timeStr = now.toLocaleTimeString('en-US', {
        hour: '2-digit', minute: '2-digit', hour12: true
      });

      document.getElementById(targetId).innerHTML = `${dateStr}<br>${timeStr}`;
    }

    // Step 1: Open Recommended modal first
    async function openComplaint() {
      recommendModal.style.display = "flex";
    }

    // Close Recommended modal
    function closeRecommend() {
      recommendModal.style.display = "none";
    }

    // Step 2 (a): From Recommended → proceed to Action modal
    function proceedToAction() {
      recommendModal.style.display = "none";
      modal.style.display = 'flex';
      updateComplaintDateTime("actionDatetime");
      if (!interval) interval = setInterval(() => updateComplaintDateTime("actionDatetime"), 1000);
      document.getElementById("actionType").value = "";
      document.querySelectorAll("#modal .action-fields").forEach(div => div.style.display = "none");
      // Load autofill only when Action modal is opened
      loadAutofill().then(data => {
        try { applyAutofillToAction(data); } catch (e) { console.warn('applyAutofillToAction failed', e); }
      });
    }

    // Step 2 (b): From Recommended → proceed to Assign modal
    function proceedToAssign() {
      recommendModal.style.display = "none";
      assignModal.style.display = 'flex';
      updateComplaintDateTime("assignDatetime");
      if (!interval) interval = setInterval(() => updateComplaintDateTime("assignDatetime"), 1000);
      document.getElementById("assignType").value = "";
      document.querySelectorAll("#assignModal .action-fields").forEach(div => div.style.display = "none");

      loadAutofill().then(data => { //assign modal load
        try { applyAutofillToAssign(data); } catch (e) { console.warn('applyAutofillToAssign failed', e); }

       
        const invSelect = document.getElementById('invAssignedPersonnel');
        if (invSelect) {
          // No network call — keep the select static and only preselect when autofill exactly matches an existing option.
          if (data.invitation_assigned_personnel) {
            const match = Array.from(invSelect.options).find(o => o.value === data.invitation_assigned_personnel);
            if (match) invSelect.value = data.invitation_assigned_personnel;
            // If no exact match, intentionally do nothing and keep the placeholder.
          }
        }
      });
    }

    // Close whichever modal is open
    function closeComplaint() {
      modal.style.display = 'none';
      assignModal.style.display = 'none';
      try {
        document.querySelectorAll('#modal input[type=text], #modal textarea').forEach(i => { if (!i.readOnly) i.value = ''; });
        document.querySelectorAll('#assignModal input[type=text], #assignModal textarea').forEach(i => { if (!i.readOnly) i.value = ''; });
        document.querySelectorAll('#modal input[type=date], #modal input[type=time], #assignModal input[type=date], #assignModal input[type=time]').forEach(i => i.value = '');
        document.querySelectorAll('#modal select, #assignModal select').forEach(sel => {
          try {
            const placeholder = sel.querySelector('option[disabled]');
            if (placeholder) {
              sel.value = '';
              sel.selectedIndex = 0;
            } else {
              sel.selectedIndex = -1;
            }
          } catch (e) {}
        });
        document.querySelectorAll('#modal input[type=checkbox], #assignModal input[type=checkbox]').forEach(cb => cb.checked = false);
        document.querySelectorAll('#modal input[type=radio], #assignModal input[type=radio]').forEach(r => r.checked = false);
        document.querySelectorAll('#modal input[type=file], #assignModal input[type=file]').forEach(f => { try { f.value = null; } catch(e){} });
        const witnessContainer = document.getElementById('witnessContainer');
        if (witnessContainer) {
          witnessContainer.innerHTML = `<div class="witness-row"><input type="text" name="witness[]" placeholder="Enter name"></div>`;
        }
        const fileUploadContainer = document.getElementById('fileUploadContainer');
        if (fileUploadContainer) {
          fileUploadContainer.innerHTML = `
            <div class="fileUp-row">
              <div class="fileUp-top">
                <input type="text" name="fileDescription[]" placeholder="File type (e.g. Proof, Document)" required>
                <button type="button" class="remove-btn-wit" onclick="this.closest('.fileUp-row').remove()">
                  <span class="material-icons">close</span>
                </button>
              </div>
              <div class="fileUp-bottom">
                <input type="file" name="mediationFiles[]" id="fileInput1" style="display:none;"
                  onchange="var f=this.files.length?this.files[0].name:'';var s=document.getElementById('fileName1');s.textContent=f;s.title=f;">
                <button type="button" class="file-upload-btn" onclick="document.getElementById('fileInput1').click()">Upload</button>
                <span class="file-name" id="fileName1"></span>
              </div>
            </div>
          `;
        }
        const attachedFilesContainer = document.getElementById('attachedFilesContainer');
        if (attachedFilesContainer) attachedFilesContainer.innerHTML = '';
        // Reset “Out of Jurisdiction” extras
        const outOthersInput = document.getElementById('outOthersInput');
        if (outOthersInput) outOthersInput.value = '';
        const outNotes = document.getElementById('outOfJurisdictionNotes');
        if (outNotes) outNotes.value = '';

        // Hide action-specific panels
        document.querySelectorAll('#modal .action-fields').forEach(div => div.style.display = 'none');
        document.querySelectorAll('#assignModal .action-fields').forEach(div => div.style.display = 'none');
      } catch (e) {}
      if (interval) { clearInterval(interval); interval = null; }
    }

    // Action modal dropdown
    document.getElementById("actionType").addEventListener("change", function () {
      document.getElementById("actionAssessmentFields").style.display = "none";
      document.getElementById("actionMediationFields").style.display = "none";
      document.getElementById("actionOutOfJurisdictionFields").style.display = "none";

      if (this.value === "Assessment") {
        document.getElementById("actionAssessmentFields").style.display = "block";
      } else if (this.value === "Mediation") {
        document.getElementById("actionMediationFields").style.display = "block";
      } else if (this.value === "Out of Jurisdiction") {
        document.getElementById("actionOutOfJurisdictionFields").style.display = "block";
      }
    });


    // Assign modal dropdown
    document.getElementById("assignType").addEventListener("change", function () {
      document.getElementById("assignInspectionFields").style.display = "none";
      document.getElementById("assignInvitationFields").style.display = "none";

      if (this.value === "Inspection") {
        document.getElementById("assignInspectionFields").style.display = "block";
      } else if (this.value === "Invitation") {
        document.getElementById("assignInvitationFields").style.display = "block";
        try {
          const invSelect = document.getElementById('invAssignedPersonnel');
          if (invSelect) {
            invSelect.style.position = 'relative';
            invSelect.style.zIndex = 10001;
          }
          // also bring the date/time inputs to front just in case
          const invDate = document.getElementById('invDate');
          const invTime = document.getElementById('invTime');
          if (invDate) { invDate.style.position = 'relative'; invDate.style.zIndex = 10001; }
          if (invTime) { invTime.style.position = 'relative'; invTime.style.zIndex = 10001; }
        } catch (e) {}
      }
    });

     // Add new witness row
    function addWitness() {
    const container = document.getElementById("witnessContainer");
    const div = document.createElement("div");
    div.classList.add("witness-row"); 
    div.innerHTML = `
      <input type="text" name="witness[]" placeholder="Enter witness/advisor name" required>
      <button type="button" class="remove-btn-wit" onclick="this.parentElement.remove()">
        <span class="material-icons">close</span>
      </button>
    `;

    container.appendChild(div);
    }

    // Add new file row
    let fileCount = 1;
    function addFileUpload() {
      fileCount++;
      const container = document.getElementById("fileUploadContainer");
      const fileInputId = "fileInput" + fileCount;
      const fileNameId = "fileName" + fileCount;

      const div = document.createElement("div");
      div.className = "fileUp-row";
      div.innerHTML = `
        <div class="fileUp-top">
          <input type="text" name="fileDescription[]" placeholder="File type (e.g. Proof, Document)" required>
          <button type="button" class="remove-btn-wit" onclick="this.closest('.fileUp-row').remove()">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="fileUp-bottom">
          <input type="file" name="mediationFiles[]" id="${fileInputId}" style="display:none;"
            onchange="var f=this.files.length?this.files[0].name:'';var s=document.getElementById('${fileNameId}');s.textContent=f;s.title=f;">
          <button type="button" class="file-upload-btn" onclick="document.getElementById('${fileInputId}').click()">Upload</button>
          <span class="file-name" id="${fileNameId}"></span>
        </div>
      `;
      container.appendChild(div);
    }



    document.addEventListener("DOMContentLoaded", () => {
    // Existing toggle logic for "others" checkboxes
    const togglePairs = [
      { checkbox: 'othersCheckbox', input: 'othersInput' },
    ];

    togglePairs.forEach(pair => {
      const cb = document.getElementById(pair.checkbox);
      const input = document.getElementById(pair.input);
      if (cb && input) {
        cb.addEventListener('change', function () {
          if (this.checked) {
            input.style.display = 'inline-block';
            input.required = true;
          } else {
            input.style.display = 'none';
            input.required = false;
            input.value = '';
          }
        });
      }
    });

    // New logic for Out of Jurisdiction radio buttons
    const outOthersRadio = document.getElementById('outOthersRadio');
    const outOthersInput = document.getElementById('outOthersInput');
    const outRadios = document.querySelectorAll('input[name="outOfJurisdiction"]');

    outRadios.forEach(radio => {
      radio.addEventListener('change', function () {
        if (outOthersRadio.checked) {
          outOthersInput.style.display = 'inline-block';
          outOthersInput.required = true;
        } else {
          outOthersInput.style.display = 'none';
          outOthersInput.required = false;
          outOthersInput.value = '';
        }
      });
    });
  });


    function saveAction() {
      const complaintId = (typeof currentComplaintId !== 'undefined') ? currentComplaintId : null;
      console.log('currentComplaintId =', complaintId);

      // Detect action type by checking which modal is currently open, then read its selector
      const assignModalEl = document.getElementById('assignModal');
      const actionModalEl = document.getElementById('modal');
      const assignType = document.querySelector("#assignType")?.value;
      const actionTypeSelect = document.querySelector("#actionType")?.value;
      let actionType = null;
      if (actionModalEl && actionModalEl.style.display === 'flex') {
        actionType = actionTypeSelect;
      } else if (assignModalEl && assignModalEl.style.display === 'flex') {
        actionType = assignType;
      } else {
        actionType = assignType || actionTypeSelect;
      }

      //require field
      const missing = [];
      if (actionType === 'Invitation') {
        const invSelect = document.getElementById('invAssignedPersonnel');
        const invDate = document.getElementById('invDate');
        const invTime = document.getElementById('invTime');
        if (invSelect && !invSelect.value) missing.push('Assigned Personnel');
        if (invDate && !invDate.value) missing.push('Meeting Date');
        if (invTime && !invTime.value) missing.push('Meeting Time');
      } else if (actionType === 'Inspection') {
        const assigned = document.getElementById('assignedPersonnel');
        const loc = document.getElementById('inspectionLocation');
        const deadline = document.getElementById('inspectionDeadline');
        const scopeCheckboxes = document.querySelectorAll("input[name='scope[]']");
        const othersCheckbox = document.getElementById('othersCheckbox');
        const othersInput = document.getElementById('othersInput');

        if (assigned && !assigned.value) missing.push('Inspector');
        if (loc && !loc.value) missing.push('Inspection Location');
        if (deadline && !deadline.value) missing.push('Deadline');

        // check if any regular checkbox is checked
        const anyChecked = Array.from(scopeCheckboxes).some(cb => cb.checked);

        // check if “Others” is filled properly
        const othersFilled = othersCheckbox?.checked && othersInput?.value.trim();

        if (!anyChecked && !othersFilled) {
          missing.push('Scope (at least one option)');
        }
      } else if (actionType === 'Mediation') {
        const agenda = document.querySelector("input[name='agenda']");
        const summary = document.querySelector("textarea[name='summary']");
        if (agenda && !agenda.value) missing.push('Agenda');
        if (summary && !summary.value) missing.push('Summary');
        const witnesses = Array.from(document.querySelectorAll("input[name='witness[]']")).map(i => i.value.trim()).filter(Boolean);
        if (witnesses.length === 0) missing.push('At least one Witness/Advisor');
        const uploads = Array.from(document.querySelectorAll("input[name='mediationFiles[]']")).map((f, idx) => ({ file: f.files && f.files.length ? f.files[0].name : '', desc: (document.querySelectorAll("input[name='fileDescription[]']")[idx] || {}).value || '' }));
        const validUploads = uploads.filter(u => u.file && u.desc.trim());
        if (validUploads.length === 0) missing.push('At least one uploaded file with description');
      } else if (actionType === 'Assessment') {
        const notes = document.getElementById('assessmentNotes');
        if (notes && !notes.value) missing.push('Assessment Notes');
      } else if (actionType === 'Out of Jurisdiction') {
        const notes = document.getElementById('outOfJurisdictionNotes');
        const outOthersRadio = document.getElementById('outOthersRadio');
        const outOthersInput = document.getElementById('outOthersInput');
        const jurisdictionRadios = document.querySelectorAll("input[name='outOfJurisdiction']");

        const anySelected = Array.from(jurisdictionRadios).some(r => r.checked);
        const othersFilled = outOthersRadio?.checked && outOthersInput?.value.trim();

        if (!anySelected) missing.push('Out of Jurisdiction (select one option)');
        if (outOthersRadio?.checked && !othersFilled) missing.push('Please specify "Others" under Out of Jurisdiction');
        if (notes && !notes.value.trim()) missing.push('Out of Jurisdiction Notes');
      }
      if (missing.length) {
        showCustomAlert('Please fill required fields before saving: ' + missing.join(', '));
        return;
      }

      // Figure out assignedTo
      let assignedTo = "";
      if (actionType === "Inspection") {
          assignedTo = document.querySelector("#assignedPersonnel")?.value || "Unknown";
      } else if (actionType === "Invitation") {
          const invSelectEl = document.querySelector("#invAssignedPersonnel");
          if (invSelectEl) {
            const sel = invSelectEl.options[invSelectEl.selectedIndex];
            assignedTo = (sel && sel.id) ? sel.id : (invSelectEl.value || "Unknown");
          } else {
            assignedTo = "Unknown";
          }
      } else if (actionType === "Mediation") {
        // For mediation, assigned person is taken from the mediation assigned personnel field
        assignedTo = document.querySelector('#medAssignedPersonnel')?.value || 'Josie Rosal';
      } else if (actionType === "Assessment") {
        assignedTo = 'Josie Rosal';
      }

      let details = {};
      let description = "";

      if (actionType === "Mediation") {
        // Helper function to collect parties involved values from medPartiesInvolved div OR get from autofill cache
        const collectPartiesInvolved = () => {
          // First try to get from the autofill cache (which comes from invitation "to" field)
          if (autofillCache && autofillCache.to) {
            console.log('[MEDIATION] Getting parties from autofill cache "to" field:', autofillCache.to);
            const partiesFromTo = autofillCache.to
              .split(',')
              .map(s => s.trim())
              .filter(Boolean);
            if (partiesFromTo.length > 0) {
              console.log('[MEDIATION] Using parties from invitation "to":', partiesFromTo);
              return partiesFromTo;
            }
          }
          
          // Fallback to collecting from the medPartiesInvolved div inputs
          const medPartiesEl = document.getElementById('medPartiesInvolved');
          if (!medPartiesEl) {
            console.log('[MEDIATION] No medPartiesInvolved element found');
            return [];
          }
          
          const inputs = medPartiesEl.querySelectorAll('input[name="parties_involved[]"]');
          const partiesFromInputs = Array.from(inputs).map(input => input.value.trim()).filter(Boolean);
          console.log('[MEDIATION] Collected parties from inputs:', partiesFromInputs);
          return partiesFromInputs;
        };

        details = {
          advisors: Array.from(document.querySelectorAll("input[name='witness[]']")).map(w => w.value),
          agenda: document.querySelector("input[name='agenda']")?.value || "",
          summary: document.querySelector("textarea[name='summary']")?.value || "",
          assigned_personnel: document.querySelector('#medAssignedPersonnel')?.value || 'Josie Rosal',
          parties_involved: Array.from(document.querySelectorAll('#medPartiesInvolved input'))
            .map(i => (i.value || '').trim())
            .filter(Boolean),
          files: Array.from(document.querySelectorAll("input[name='mediationFiles[]']")).map((fileInput, idx) => {
            return {
              filename: fileInput.value.split("\\").pop(),
              type: document.querySelectorAll("input[name='fileDescription[]']")[idx]?.value || ""
            }
          })
        };
        description = details.summary;  // use summary as description
        
        console.log('[MEDIATION] Final parties_involved in details:', details.parties_involved);
      } 
      else if (actionType === "Assessment") {
        details = {
          notes: document.querySelector("#assessmentNotes")?.value || ""
        };
        description = details.notes; // use notes as description
      } 
      else if (actionType === "Out of Jurisdiction") {
        const selectedRadio = document.querySelector('input[name="outOfJurisdiction"]:checked');
        const othersInput = document.getElementById('outOthersInput');
        const notes = document.querySelector("#outOfJurisdictionNotes")?.value || "";

        const jurisdictionValue = selectedRadio
          ? (selectedRadio.value === 'Others' ? othersInput?.value.trim() || 'Others' : selectedRadio.value)
          : '';

        details = {
          jurisdiction: jurisdictionValue,
          notes: notes
        };
        description = `${jurisdictionValue} - ${notes}`;
      }
      else if (actionType === "Inspection") {
        const othersValue = document.querySelector("#othersCheckbox")?.checked 
          ? document.querySelector("#othersInput")?.value.trim() 
          : "";

        const scopes = Array.from(document.querySelectorAll("input[name='scope[]']:checked")).map(cb => cb.value);
        if (othersValue) scopes.push(othersValue);

        details = {
          deadline: document.querySelector("#inspectionDeadline")?.value || "",
          inspector: document.querySelector("#assignedPersonnel")?.value || "",
          location: document.querySelector("#inspectionLocation")?.value || "",
          scope: scopes
        };

        description = "Inspection scheduled";
      }
      else if (actionType === "Invitation") {
        // Collect all "to[]" inputs inside #invTo
        const toInputs = document.querySelectorAll("#invTo input[name='to[]']");
        const toList = Array.from(toInputs)
          .map(i => i.value.trim())
          .filter(Boolean);

        details = {
          to: toList.join(", "), // join into a comma-separated string
          recipients_address: document.querySelector('#invRecipientsAddress')?.value || '',
          meeting_date: document.querySelector("#invDate")?.value || "",
          meeting_time: document.querySelector("#invTime")?.value || "",
          location: document.querySelector("#invLocation")?.value || "",
          agenda: document.querySelector("#invAgenda")?.value || ""
        };

        description = `Invitation scheduled for ${toList.join(", ")}`;
      }




    // Create final payload
    // Flatten details into the top-level payload so backend receives flattened keys
    const payload = Object.assign({
      complaint_id: complaintId,
      action_type: actionType,
      assigned_to: assignedTo,
      action_datetime: new Date().toISOString().slice(0,19).replace("T"," "),
      description: description
    }, details || {});

    // Remove nested `details` to avoid duplication — backend expects flattened keys
    // (example flattened keys: deadline, inspector, location, scope, to, meeting_date, meeting_time, agenda, files)
    
    console.log("payload to send:", payload);

      // Disable the save button to prevent double submissions
      const modalSaveBtn = document.getElementById('modalSaveBtn');
      const assignSaveBtn = document.getElementById('assignSaveBtn');
      if (modalSaveBtn) modalSaveBtn.disabled = true;
      if (assignSaveBtn) assignSaveBtn.disabled = true;

      fetch("/admin/complaints/api/action", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(res => {
        // Re-enable buttons
        if (modalSaveBtn) modalSaveBtn.disabled = false;
        if (assignSaveBtn) assignSaveBtn.disabled = false;

        if (res.success) {
          // Close any open modals, clear fields, and stop timers
          try { closeComplaint(); } catch (e) { /* fallback */ }
          try { document.getElementById('recommendModal').style.display = 'none'; } catch (e) {}
          if (interval) { clearInterval(interval); interval = null; }
          
          // Refresh timeline to show new entry and close modal automatically
          if (typeof refreshTimeline === 'function') {
            refreshTimeline();
          }
          
          // Close the modal automatically after successful save
          closeComplaint();
        } else {
          // Only show error messages, no success messages
          console.error("Error saving action:", res.error || res.message);
        }
      })
      .catch(err => {
        if (modalSaveBtn) modalSaveBtn.disabled = false;
        if (assignSaveBtn) assignSaveBtn.disabled = false;
        console.error('Network or server error:', err);
      });
    }


    // Click outside closes modals
    modal.addEventListener('click', e => { if (e.target === modal) closeComplaint(); });
    recommendModal.addEventListener("click", e => { if (e.target === recommendModal) closeRecommend(); });
    
    // Add click outside handler for resolve modal
    const resolveModal = document.getElementById('resolveModal');
    if (resolveModal) {
      resolveModal.addEventListener('click', e => { if (e.target === resolveModal) closeResolveModal(); });
    }

    // Add click outside handler for timeline preview modal
    const timelinePreviewModal = document.getElementById('timelinePreviewModal');
    if (timelinePreviewModal) {
      timelinePreviewModal.addEventListener('click', e => { if (e.target === timelinePreviewModal) closeTimelinePreview(); });
    }

    // Expose globally so your buttons can call them
    window.openComplaint = openComplaint;
    window.closeComplaint = closeComplaint;
    window.proceedToAction = proceedToAction;
    window.proceedToAssign = proceedToAssign;
    window.closeRecommend = closeRecommend;
    window.updateComplaintDateTime = updateComplaintDateTime;
    window.addWitness = addWitness;
    window.addFileUpload = addFileUpload;
    window.saveAction = saveAction;
  })();

  // Load and inject complaint form preview (admin view)
  document.addEventListener('DOMContentLoaded', async function() {
    const params = new URLSearchParams(window.location.search);
    const complaintId = params.get('id');
    const container = document.getElementById('complaintFormContainer');
    if (!container) {
      console.warn('[Preview] Container #complaintFormContainer not found');
      return;
    }
    if (!complaintId) {
      container.textContent = 'No complaint selected.';
      console.warn('[Preview] Missing ?id= param in URL');
      return;
    }
    try {
      console.log(`[Preview] Fetching complaint form for ID ${complaintId} ...`);
      const res = await fetch(`/admin/complaints/api/complaint_form_preview/${complaintId}`, { credentials: 'same-origin' });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        console.error(`[Preview] Failed to load form: HTTP ${res.status} ${res.statusText}`, text?.slice(0,500));
        container.textContent = `Failed to load complaint form (HTTP ${res.status}).`;
        return;
      }
      const html = await res.text();
      if (!html || !html.trim()) {
        console.warn('[Preview] Empty HTML received for form preview');
        container.textContent = 'No form data available.';
        return;
      }
      container.outerHTML = html; // Replace container with rendered form block
      console.log('[Preview] Complaint form injected successfully');
    } catch (e) {
      if (container) container.textContent = 'Error loading complaint form.';
      console.error('[Preview] Exception while loading complaint form preview:', e);
    }
  });

  // =====================================
  // DYNAMIC TIMELINE SYSTEM
  // =====================================
  
  // Timeline management
  let timelineData = [];
  let currentRole = 'admin'; // Default role, will be detected from URL or API
  
  // Detect user role from URL parameters or make API call
  function detectUserRole() {
    const urlParams = new URLSearchParams(window.location.search);
    const roleParam = urlParams.get('role');
    if (roleParam) {
      currentRole = roleParam;
      return Promise.resolve(roleParam);
    }
    
    // Fallback: detect from current path or make API call
    if (window.location.pathname.includes('/admin/')) {
      currentRole = 'admin';
    } else if (window.location.pathname.includes('/staff/')) {
      currentRole = 'staff';
    } else if (window.location.pathname.includes('/complainant/')) {
      currentRole = 'complainant';
    }
    return Promise.resolve(currentRole);
  }
  


  // Load timeline data from API
  async function loadTimelineData() {
    try {
      const complaintId = new URLSearchParams(window.location.search).get('id');
      if (!complaintId) {
        console.error('No complaint ID found in URL');
        return [];
      }
      
      const role = await detectUserRole();
      console.log(`Loading timeline for complaint ${complaintId} with role ${role}`);
      
      const response = await fetch(`/admin/complaints/api/timeline/${complaintId}?role=${role}&_=${Date.now()}`, {
        credentials: 'same-origin'
      });
      
      console.log(`Timeline API response status: ${response.status}`);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Timeline API error: ${response.status} - ${errorText.substring(0, 200)}`);
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('Timeline data received:', data);
      return data.timeline || [];
    } catch (error) {
      console.error('Error loading timeline data:', error);
      return [];
    }
  }
  
  // Truncate description to one line with ellipsis
  function truncateDescription(text, maxLength = 80) {
    if (!text) return '';
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength).trim() + '...';
  }
  
  // Map action types to standardized timeline status labels - ONLY 7 ALLOWED STATUSES
  function mapActionToTimelineStatus(actionType, isCompleted = false, role = 'admin') {
    // ADMIN VIEW: Only allowed sequential flow statuses
    const statusMap = {
      'Submitted': 'Submitted a Valid Complaint',
      'Inspection': 'Inspection',
      'Inspection done': 'Inspection done',
      'Invitation': 'Send Invitation',  // Admin creates invitation task - show as assignment
      'Send Invitation': 'Send Invitation',  // Map legacy to new label
      'Sent Invitation': 'Sent Invitation',
      'Task Completed': 'Inspection done',  // Map legacy Task Completed to Inspection done
      'Resolved': 'Resolved'
    };
    return statusMap[actionType] || actionType;
  }
  
  // Generate default messages for actions without descriptions - ONLY 7 ALLOWED STATUSES
  function getDefaultMessage(actionType, assignedTo) {
    const timelineStatus = mapActionToTimelineStatus(actionType);
    const messages = {
      'Submitted a Valid Complaint': 'Complaint has been received and validated',
      'Inspection': `Site inspection assigned to ${assignedTo || 'staff'}`,
      'Inspection done': `Site inspection completed by ${assignedTo || 'staff'}`,
      'Send Invitation': `Invitation task assigned to ${assignedTo || 'staff'}`,
      'Sent Invitation': `Invitation sent to parties by ${assignedTo || 'staff'}`,
      'Task Completed': `Task completed and passed back to admin`,
      'Resolved': 'Complaint has been resolved'
    };
    return messages[timelineStatus] || `${timelineStatus} - status unknown`;
  }
  
  // Format date and time for timeline display
  function formatTimelineDate(dateString) {
    try {
      const date = new Date(dateString);
      const dateStr = date.toLocaleDateString('en-US', {
        month: 'numeric', day: 'numeric', year: 'numeric'
      });
      const timeStr = date.toLocaleTimeString('en-US', {
        hour: 'numeric', minute: '2-digit', hour12: true
      });
      return `${dateStr} | ${timeStr}`;
    } catch (error) {
      return dateString;
    }
  }
  
  // Render timeline entries based on role
  function renderTimeline(entries) {
    const timelineContainer = document.getElementById('complaintTimeline');
    const loadingElement = document.getElementById('timelineLoading');
    
    if (loadingElement) {
      loadingElement.style.display = 'none';
    }
    
    if (!entries || entries.length === 0) {
      timelineContainer.innerHTML = '<div class="timeline-empty" style="text-align: center; padding: 20px; color: #888; font-style: italic;">No actions have been taken yet on this complaint.</div>';
      return;
    }
    
    // Filter entries based on role
    let filteredEntries = filterEntriesByRole(entries, currentRole);
    
    // Sort entries by date (most recent first)
    console.log('Before sorting:', filteredEntries.map(e => `${e.type_of_action} at ${e.action_datetime}`));
    console.log('Before sorting (as Date objects):', filteredEntries.map(e => `${e.type_of_action} at ${new Date(e.action_datetime)}`));
    filteredEntries.sort((a, b) => new Date(b.action_datetime) - new Date(a.action_datetime));
    console.log('After sorting (most recent first):', filteredEntries.map(e => `${e.type_of_action} at ${e.action_datetime}`));
    console.log('After sorting (as Date objects):', filteredEntries.map(e => `${e.type_of_action} at ${new Date(e.action_datetime)}`));
    
    // Generate HTML for timeline entries with new hierarchical layout
    const timelineHTML = filteredEntries.map(entry => {
      const timelineStatus = mapActionToTimelineStatus(entry.type_of_action);
      const dateTime = formatTimelineDate(entry.action_datetime);
      const assignedTo = entry.assigned_to || '';
      const description = entry.description ? 
        truncateDescription(entry.description) : 
        getDefaultMessage(entry.type_of_action, entry.assigned_to);
      
      // File download button for files uploaded by staff/admin
      const fileButton = entry.has_file ? 
        `<button class="file-btn" data-pdf="${entry.file_path || '#'}" onclick="openTimelineFile('${entry.file_path || '#'}')" style="background: #4CAF50; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-left: 10px;">📄 File</button>` : 
        '';

      // Check for file attachments from staff uploads (specifically for "Inspection done" and "Sent Invitation")
      let fileIcon = '';
      const actionType = (entry.type_of_action || '').toLowerCase();
      
      // For "Inspection done" and "Sent Invitation" - check for attached_files from staff
      if (actionType === 'inspection done' || actionType === 'sent invitation') {
        const attachedFiles = (entry.details && entry.details.attached_files) ? entry.details.attached_files : [];
        if (attachedFiles.length > 0) {
          const fileCount = attachedFiles.length > 1 ? ` (${attachedFiles.length})` : '';
          fileIcon = `
            <span class="staff-file-icon" title="View staff uploads${fileCount}" 
                  onclick="viewStaffFiles(${JSON.stringify(attachedFiles).replace(/"/g, '&quot;')}, '${entry.type_of_action}', ${entry.history_id})"
                  style="cursor: pointer; margin-left: 8px; padding: 2px 4px; background: #007bff; color: white; border-radius: 3px; font-size: 11px; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
              📎${fileCount}
            </span>`;
        }
      }
      
      // For other action types - keep existing file preview logic
      if (!fileIcon && ['inspection', 'mediation', 'invitation', 'assessment'].some(type => actionType.includes(type))) {
        const files = getAdminFilesFromEntry(entry);
        if (files.length > 0) {
          const fileCount = files.length > 1 ? ` (${files.length})` : '';
          fileIcon = `
            <span class="file-icon" title="View attachments${fileCount}" 
                  onclick="showAdminFilePreview(${JSON.stringify(files).replace(/"/g, '&quot;')}, '${entry.type_of_action}', ${entry.history_id})"
                  style="cursor: pointer; margin-left: 8px; font-size: 12px; color: #007bff;">
              📎${fileCount}
            </span>`;
        }
      }
      
      // Add "Mark as Accepted" button for "Sent Invitation" entries (admin.account == 1 only)
      // Check if invitation has already been accepted by looking for "Accepted Invitation" entries
      const hasAcceptedInvitation = filteredEntries.some(e => e.type_of_action === 'Accepted Invitation');
      let acceptInvitationButton = '';
      
      if (timelineStatus === 'Sent Invitation') {
        if (hasAcceptedInvitation) {
          // Already accepted - show disabled gray button
          acceptInvitationButton = `<button class="accept-invitation-btn" disabled style="background: #6c757d; color: #adb5bd; border: none; padding: 3px 8px; border-radius: 3px; cursor: not-allowed; font-size: 11px; margin-left: 5px;">Already Accepted</button>`;
        } else {
          // Not accepted yet - show clickable green button
          acceptInvitationButton = `<button class="accept-invitation-btn" onclick="showAcceptInvitationModal(${entry.history_id})" style="background: #28a745; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-left: 5px;">Mark as Accepted</button>`;
        }
      }
      
      // Determine if this entry should be clickable for preview
      const isPreviewable = ['Inspection', 'Send Invitation', 'Mediation', 'Assessment'].includes(timelineStatus) && 
                           timelineStatus !== 'Accepted Invitation';
      const clickableClass = isPreviewable ? 'timeline-clickable' : '';
      const clickHandler = isPreviewable ? `onclick="showTimelinePreview('${entry.history_id}', '${entry.type_of_action}')"` : '';
      
      return `
        <div class="timeline-entry ${clickableClass}" data-status="${timelineStatus.toLowerCase().replace(/\s+/g, '-')}" ${clickHandler} style="position: relative; ${isPreviewable ? 'cursor: pointer;' : ''}">
          <div style="position: absolute; top: 5px; right: 10px;">${fileIcon}</div>
          <h4 style="font-size: 16px; margin: 0 0 5px 0; padding-right: 40px;">
            ${timelineStatus}
          </h4>
          <div style="font-size: 13px; color: #666; margin-bottom: 3px;">${dateTime}</div>
          <div style="font-size: 13px; color: #333; margin-bottom: 5px;">${assignedTo}${fileButton}${acceptInvitationButton}</div>
          <div style="font-size: 12px; color: #555; line-height: 1.4;">${description}</div>
        </div>
      `;
    }).join('');
    
    timelineContainer.innerHTML = timelineHTML;
    
    // Re-attach file button event listeners
    attachFileButtonListeners();
  }
  
  // Filter timeline entries based on user role
  function filterEntriesByRole(entries, role) {
    switch (role) {
      case 'admin':
        // Admin sees all entries, but ensure "Submitted" entry exists
        let adminEntries = [...entries];
        
        // Check if there's already a "Submitted" entry
        const hasSubmitted = adminEntries.some(entry => 
          (entry.type_of_action || '').toLowerCase().includes('submitted'));
        
        if (!hasSubmitted) {
          // Add a "Submitted" entry with complaint submission date
          // Get the earliest action date as fallback, or use a date before all existing entries
          let submissionDate = new Date().toISOString();
          
          if (adminEntries.length > 0) {
            // Find the earliest existing action date and subtract a day
            const earliestDate = adminEntries
              .map(entry => new Date(entry.action_datetime || new Date()))
              .sort((a, b) => a - b)[0];
            
            // Set submission date to 1 day before the earliest action
            const submissionTimestamp = new Date(earliestDate.getTime() - (24 * 60 * 60 * 1000));
            submissionDate = submissionTimestamp.toISOString();
          }
          
          adminEntries.push({
            history_id: 'generated-submitted',
            type_of_action: 'Submitted',
            assigned_to: '',
            description: 'Submitted a Valid Complaint',
            action_datetime: submissionDate,
            details: {},
            has_file: false,
            file_path: null,
            file_name: null,
            admin_account_type: 1,
            completed_by_staff: false
          });
        }
        
        return adminEntries;
        
      case 'staff':
        // Staff sees their assignments and completions, plus completion message
        const staffEntries = entries.filter(entry => 
          entry.assigned_to && entry.assigned_to.toLowerCase().includes('staff') ||
          entry.type_of_action === 'Task Completed'
        );
        
        // Add completion message for staff if they have completed tasks
        const hasCompletedTasks = staffEntries.some(entry => entry.type_of_action === 'Task Completed');
        if (hasCompletedTasks) {
          staffEntries.push({
            action_datetime: new Date().toISOString(),
            type_of_action: 'Status Update',
            assigned_to: 'System',
            description: 'Task completed and passed back to admin for further processing',
            has_file: false
          });
        }
        return staffEntries;
        
      case 'complainant':
        // Complainant sees only milestone completions
        const milestones = ['Inspection', 'Invitation', 'Assessment', 'Resolved'];
        return entries.filter(entry => 
          milestones.includes(entry.type_of_action) && 
          !entry.type_of_action.includes('Assign')
        );
        
      default:
        return entries;
    }
  }
  
  // Re-attach event listeners to file buttons
  function attachFileButtonListeners() {
    document.querySelectorAll('.file-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const pdfUrl = btn.getAttribute('data-pdf');
        if (pdfUrl && pdfUrl !== '#') {
          window.open(pdfUrl, '_blank');
        } else {
          showCustomAlert('No file available for this entry.');
        }
      });
    });
  }
  
  // Open timeline file
  function openTimelineFile(filePath) {
    if (filePath && filePath !== '#') {
      window.open(filePath, '_blank');
    } else {
      showCustomAlert('No file available for this entry.');
    }
  }
  
  // Refresh timeline data
  async function refreshTimeline() {
    try {
      const loadingElement = document.getElementById('timelineLoading');
      if (loadingElement) {
        loadingElement.style.display = 'block';
      }
      
      const entries = await loadTimelineData();
      timelineData = entries;
      renderTimeline(entries);
    } catch (error) {
      console.error('Error refreshing timeline:', error);
      const timelineContainer = document.getElementById('complaintTimeline');
      timelineContainer.innerHTML = '<div class="timeline-error" style="text-align: center; padding: 20px; color: #d32f2f;">Error loading timeline. Please refresh the page.</div>';
    }
  }
  
  // Check if complaint is resolved and apply readonly state
  function checkResolvedState() {
    const urlParams = new URLSearchParams(window.location.search);
    const referrer = urlParams.get('referrer');
    
    // If coming from resolved.html, disable all interactive elements
    if (referrer === 'resolved.html') {
      applyResolvedReadonlyState();
    }
  }
  
  // Apply readonly state for resolved complaints
  function applyResolvedReadonlyState() {
    // Hide the "Resolved" button since complaint is already resolved
    const resolveBtn = document.querySelector('button[onclick="showResolveModal()"]');
    if (resolveBtn) {
      resolveBtn.style.display = 'none';
    }
    
    // Disable all action buttons (openComplaint, etc.)
    const actionButtons = document.querySelectorAll('button[onclick*="openComplaint"], button[onclick*="proceedTo"]');
    actionButtons.forEach(btn => {
      btn.disabled = true;
      btn.style.backgroundColor = '#6c757d';
      btn.style.color = '#adb5bd';
      btn.style.cursor = 'not-allowed';
      btn.title = 'This complaint has been resolved and is read-only';
    });
    
    // Add visual indicator to header
    const header = document.querySelector('.header h1');
    if (header) {
      header.innerHTML += ' <span style="color: #6c757d; font-size: 0.8em;">(Resolved)</span>';
    }
    
    // Disable modal functionality
    window.openComplaint = function() {
      showCustomAlert('This complaint has been resolved and cannot be modified.');
    };
  }

  // Initialize timeline on page load
  document.addEventListener('DOMContentLoaded', function() {
    checkResolvedState();
    refreshTimeline();
    loadComplaintMap();
  });

  // Load complaint details and display area map
  async function loadComplaintMap() {
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const complaintId = urlParams.get('id');
      
      if (!complaintId) {
        showMapError();
        return;
      }

      const response = await fetch(`/admin/complaints/api/complaint_details/${complaintId}`);
      const data = await response.json();
      
      if (data.success && data.complaint) {
        displayAreaMap(data.complaint);
        
        // Check if complaint is in final state and apply read-only mode
        checkAndApplyReadOnlyMode(data.complaint);
      } else {
        console.error('Failed to load complaint details:', data.message);
        showMapError();
      }
    } catch (error) {
      console.error('Error loading complaint map:', error);
      showMapError();
    }
  }

  // Display the area SVG map
  async function displayAreaMap(complaint) {
    const mapLoading = document.getElementById('mapLoading');
    const mapContent = document.getElementById('mapContent');
    const mapError = document.getElementById('mapError');
    const areaTitle = document.getElementById('areaTitle');
    const svgContainer = document.getElementById('svgContainer');

    if (mapLoading) mapLoading.style.display = 'none';

    if (!complaint.area_code) {
      showMapError();
      return;
    }

    try {
      // Load SVG file based on area_code
      const svgPath = `/admin/map/svg/${complaint.area_code.toLowerCase()}.svg`;
      const svgResponse = await fetch(svgPath);
      
      if (svgResponse.ok) {
        const svgContent = await svgResponse.text();
        
        // Update area title
        if (areaTitle) {
          areaTitle.textContent = `${complaint.area_name || complaint.area_code} Map`;
        }
        
        // Display SVG
        if (svgContainer) {
          svgContainer.innerHTML = svgContent;
          
          // Style the SVG to fit container
          const svgElement = svgContainer.querySelector('svg');
          if (svgElement) {
            svgElement.style.width = '100%';
            svgElement.style.height = '100%';
            svgElement.style.maxHeight = '300px';
            svgElement.style.objectFit = 'contain';
          }
          
          // Make SVG container clickable - redirect to map.html for this area
          svgContainer.style.cursor = 'pointer';
          svgContainer.style.transition = 'all 0.2s ease';
          
          // Add clickable indicator
          const clickIndicator = document.createElement('div');
          clickIndicator.style.cssText = `
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 18, 65, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 10;
          `;
          clickIndicator.textContent = 'Click to view details';
          svgContainer.appendChild(clickIndicator);
          
          // Add hover effects
          svgContainer.addEventListener('mouseenter', function() {
            svgContainer.style.transform = 'scale(1.02)';
            svgContainer.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            svgContainer.style.borderColor = '#007bff';
            clickIndicator.style.opacity = '1';
            svgContainer.title = `Click to view detailed map of ${complaint.area_name || complaint.area_code}`;
          });
          
          svgContainer.addEventListener('mouseleave', function() {
            svgContainer.style.transform = 'scale(1)';
            svgContainer.style.boxShadow = 'none';
            svgContainer.style.borderColor = '#ddd';
            clickIndicator.style.opacity = '0';
          });
          
          // Add click handler to navigate to map.html
          svgContainer.addEventListener('click', function() {
            const areaCode = complaint.area_code.toLowerCase();
            window.location.href = `/admin/map/${areaCode}`;
          });
        }
        
        if (mapContent) mapContent.style.display = 'block';
      } else {
        console.error(`SVG file not found: ${svgPath}`);
        showMapError();
      }
    } catch (error) {
      console.error('Error loading SVG:', error);
      showMapError();
    }
  }

  // Show map error state
  function showMapError() {
    const mapLoading = document.getElementById('mapLoading');
    const mapContent = document.getElementById('mapContent');
    const mapError = document.getElementById('mapError');
    
    if (mapLoading) mapLoading.style.display = 'none';
    if (mapContent) mapContent.style.display = 'none';
    if (mapError) mapError.style.display = 'block';
  }
  
  // Check complaint stage and apply read-only mode for final states
  function checkAndApplyReadOnlyMode(complaint) {
    const finalStates = ['Resolved', 'Unresolved', 'Out of Jurisdiction'];
    const complaintStage = complaint.complaint_stage;
    
    if (!finalStates.includes(complaintStage)) {
      return; // Not a final state, keep normal functionality
    }
    
    // Apply read-only mode
    document.body.classList.add('readonly-mode');
    
    // Create and insert banner
    const banner = document.createElement('div');
    banner.className = `readonly-mode-banner ${complaintStage.toLowerCase().replace(' ', '-')}`;
    
    let bannerText = '';
    switch (complaintStage) {
      case 'Resolved':
        bannerText = '✅ This complaint has been resolved by admin. No further actions are available.';
        break;
      case 'Unresolved':
        bannerText = '❌ This complaint has been marked as unresolved by admin. No further actions are available.';
        break;
      case 'Out of Jurisdiction':
        bannerText = '⚠️ This complaint has been marked as out of jurisdiction. No further actions are available.';
        break;
    }
    
    banner.innerHTML = bannerText;
    
    // Insert banner at the top of main content
    const mainContent = document.querySelector('.main-content');
    const header = mainContent.querySelector('.header');
    if (header && header.nextElementSibling) {
      header.parentNode.insertBefore(banner, header.nextElementSibling);
    } else {
      mainContent.insertBefore(banner, mainContent.firstChild);
    }
    
    // Hide only Resolve/Unresolve buttons
    const buttonsToHide = [
      '.resolved-btn',
      '.unresolve-btn',
      'button[onclick*="showResolveModal"]',
      'button[onclick*="showUnresolvedModal"]'
    ];
    
    buttonsToHide.forEach(selector => {
      document.querySelectorAll(selector).forEach(btn => {
        btn.style.display = 'none';
      });
    });
    
    // Disable other action buttons but keep them visible
    const buttonsToDisable = [
      'button[onclick*="showAssignModal"]',
      'button[onclick*="acceptInvitationModal"]',
      '.modal-buttons button:not(.cancel-btn):not(.resolved-btn):not(.unresolve-btn)'
    ];
    
    buttonsToDisable.forEach(selector => {
      document.querySelectorAll(selector).forEach(btn => {
        btn.style.opacity = '0.5';
        btn.style.pointerEvents = 'none';
        btn.style.cursor = 'not-allowed';
        btn.disabled = true;
      });
    });
    
    // Disable timeline interactions except file viewing
    document.querySelectorAll('.timeline-entry').forEach(entry => {
      entry.style.pointerEvents = 'none';
      entry.style.opacity = '0.8';
      
      // Re-enable file buttons
      entry.querySelectorAll('.file-btn').forEach(fileBtn => {
        fileBtn.style.pointerEvents = 'auto';
        fileBtn.style.opacity = '1';
      });
    });
  }
  
  // Accepted Invitation Modal Functions
  let currentInvitationHistoryId = null;
  
  function showAcceptInvitationModal(historyId) {
    currentInvitationHistoryId = historyId;
    document.getElementById('acceptInvitationModal').style.display = 'flex';
  }
  
  function closeAcceptInvitationModal() {
    document.getElementById('acceptInvitationModal').style.display = 'none';
    currentInvitationHistoryId = null;
  }
  
  async function confirmAcceptedInvitation() {
    if (!currentInvitationHistoryId) return;
    
    try {
      // Get current admin name from session
      const adminResponse = await fetch('/admin/current-user');
      const adminData = await adminResponse.json();
      const adminName = adminData.name || 'Admin';
      
      const complaintId = new URLSearchParams(window.location.search).get('id');
      const response = await fetch('/admin/complaints/api/action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          complaint_id: complaintId,
          action_type: 'Accepted Invitation',
          assigned_to: adminName,
          description: 'Both parties have accepted the invitation',
          original_invitation_id: currentInvitationHistoryId
        })
      });
      
      if (response.ok) {
        closeAcceptInvitationModal();
        refreshTimeline();
      } else {
        console.error('Failed to confirm accepted invitation');
      }
    } catch (error) {
      console.error('Error confirming accepted invitation:', error);
    }
  }

  // Make functions globally available
  window.refreshTimeline = refreshTimeline;
  window.openTimelineFile = openTimelineFile;
  window.showAcceptInvitationModal = showAcceptInvitationModal;
  window.closeAcceptInvitationModal = closeAcceptInvitationModal;
  window.confirmAcceptedInvitation = confirmAcceptedInvitation;
  window.showResolveModal = showResolveModal;
  window.closeResolveModal = closeResolveModal;
  window.resolveComplaint = resolveComplaint;
  window.showUnresolvedModal = showUnresolvedModal;
  window.closeUnresolveModal = closeUnresolveModal;
  window.unresolveComplaint = unresolveComplaint;

  /* Timeline: Open PDF */
  document.querySelectorAll('.file-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const pdfUrl = btn.getAttribute('data-pdf'); // replace with actual file paths
      if (pdfUrl) window.open(pdfUrl, '_blank');
      else showCustomAlert("No PDF linked yet.");
    });
  });

  /* Files Modal */
  function openFiles() {
    const modal = document.getElementById("filesModal");
    modal.style.display = "flex";
    updateFilesDateTime();
  }
  function closeFiles() {
    document.getElementById("filesModal").style.display = "none";
  }
  function updateFilesDateTime() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', {
      weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'
    });
    const timeStr = now.toLocaleTimeString('en-US', {
      hour: '2-digit', minute: '2-digit', hour12: true
    });
    document.getElementById("filesDateTime").innerHTML = `${dateStr}<br>${timeStr}`;
  }
  document.getElementById("filesModal").addEventListener("click", e => {
    if (e.target.id === "filesModal") closeFiles();
  });

  /* Switch tabs */
  document.querySelectorAll('.file-tabs .tab').forEach(tab => {
    tab.addEventListener('click', function () {
      document.querySelectorAll('.file-tabs .tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      const target = this.getAttribute('data-tab');
      document.querySelector('.uploaded-list').style.display = target === "uploaded" ? "block" : "none";
      document.querySelector('.downloadable-list').style.display = target === "downloadable" ? "block" : "none";
    });
  });

  /* User file uploads */
  document.getElementById("userFileInput").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);

      // Create a file row in the Downloadable list
      const fileRow = document.createElement("div");
      fileRow.className = "file-row";

      fileRow.innerHTML = `
        <span class="file-name">${file.name}</span>
        <div class="file-actions">
          <a href="${url}" download="${file.name}" class="download-btn">Download ⬇</a>
          <button class="attach-btn">Attach 📎</button>
        </div>
      `;

      // Attach button functionality
      fileRow.querySelector(".attach-btn").addEventListener("click", () => {
        attachFileToAction(file.name, url);
      });

      document.querySelector(".downloadable-list").appendChild(fileRow);

      // Auto-switch to downloadable tab
      document.querySelector('.file-tabs .tab[data-tab="downloadable"]').click();
    }
  });

  /* Attach file to Action modal */
  function attachFileToAction(fileName, fileUrl) {
    const container = document.getElementById("attachedFilesContainer");
    if (!container) return;

    // Prevent duplicates
    const alreadyAttached = [...container.querySelectorAll(".attached-file")]
      .some(f => f.textContent === fileName);
    if (alreadyAttached) return;

    const fileTag = document.createElement("div");
    fileTag.className = "attached-file";
    fileTag.textContent = fileName;

    // Store metadata so you can save later
    fileTag.dataset.url = fileUrl;

    container.appendChild(fileTag);
  }

  /* Sending actions is handled by saveAction() / saveMediationAction() above.
     Removed duplicate event listener that used incorrect selectors/endpoints. */

  // Show resolve confirmation modal
  function showResolveModal() {
    document.getElementById('resolveModal').style.display = 'flex';
  }
  
  // Close resolve confirmation modal
  function closeResolveModal() {
    document.getElementById('resolveModal').style.display = 'none';
  }
  
  // Resolve complaint function
  async function resolveComplaint() {
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const complaintId = urlParams.get('id');
      
      if (!complaintId) {
        showCustomAlert('Complaint ID not found');
        return;
      }

      const response = await fetch(`/admin/complaints/api/${complaintId}/resolve`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      });

      const data = await response.json();
      
      if (data.success) {
        // Close the modal
        closeResolveModal();
        
        // Check referrer to determine redirect destination
        const urlParams = new URLSearchParams(window.location.search);
        const referrer = urlParams.get('referrer');
        
        // Redirect to resolved.html for complaints from pending.html and ongoing.html
        if (referrer === 'pending.html' || referrer === 'ongoing.html') {
          window.location.href = '/admin/complaints/resolved.html';
        } else {
          // For other cases (all.html, etc.), redirect back to the original page
          window.location.href = referrer ? `/admin/complaints/${referrer}` : '/admin/complaints/all.html';
        }
      } else {
        showCustomAlert('Error: ' + (data.message || 'Failed to resolve complaint'));
      }
    } catch (error) {
      console.error('Error resolving complaint:', error);
      showCustomAlert('Error resolving complaint. Please try again.');
    }
  }

  // Show unresolved confirmation modal
  function showUnresolvedModal() {
    document.getElementById('unresolveModal').style.display = 'flex';
  }
  
  // Close unresolved confirmation modal
  function closeUnresolveModal() {
    document.getElementById('unresolveModal').style.display = 'none';
  }
  
  // Unresolved complaint function
  async function unresolveComplaint() {
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const complaintId = urlParams.get('id');
      
      if (!complaintId) {
        showCustomAlert('Complaint ID not found');
        return;
      }

      const response = await fetch(`/admin/complaints/api/${complaintId}/unresolve`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      });

      const data = await response.json();
      
      if (data.success) {
        // Close the modal
        closeUnresolveModal();
        
        // Check referrer to determine redirect destination
        const urlParams = new URLSearchParams(window.location.search);
        const referrer = urlParams.get('referrer');
        
        // Redirect to unresolved.html for complaints from resolved.html
        if (referrer === 'resolved.html') {
          window.location.href = '/admin/complaints/unresolved.html';
        } else {
          // For other cases, redirect back to the original page
          window.location.href = referrer ? `/admin/complaints/${referrer}` : '/admin/complaints/all.html';
        }
      } else {
        showCustomAlert('Error: ' + (data.message || 'Failed to mark complaint as unresolved'));
      }
    } catch (error) {
      console.error('Error marking complaint as unresolved:', error);
      showCustomAlert('Error marking complaint as unresolved. Please try again.');
    }
  }

  // Back arrow functionality
  function goBack() {
    const urlParams = new URLSearchParams(window.location.search);
    const referrer = urlParams.get('referrer');
    
    if (referrer) {
      window.location.href = `/admin/complaints/${referrer}`;
    } else {
      window.location.href = '/admin/complaints/all.html';
    }
  }

    // Update file name when a file is selected
  document.getElementById('fileInput1').addEventListener('change', function() {
    const fileName = this.files[0] ? this.files[0].name : '';
    document.getElementById('fileName1').textContent = fileName;
  });

  // Custom Alert Modal Functions
  function showCustomAlert(message) {
    document.getElementById('alertMessage').textContent = message;
    document.getElementById('alertModal').style.display = 'flex';
  }

  function closeCustomAlert() {
    document.getElementById('alertModal').style.display = 'none';
  }

  // =====================================
  // TIMELINE PREVIEW FUNCTIONALITY
  // =====================================
  
  let currentPreviewData = null;

  // Show timeline entry preview modal
  async function showTimelinePreview(historyId, actionType) {
    try {
      console.log(`[TIMELINE PREVIEW] Opening preview for history ID: ${historyId}, action: ${actionType}`);
      
      // Fetch the detailed timeline entry data
      const response = await fetch(`/admin/complaints/api/timeline_entry/${historyId}`, {
        credentials: 'same-origin'
      });
      
      if (!response.ok) {
        throw new Error(`Failed to fetch timeline entry: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.message || 'Failed to load timeline entry');
      }
      
      currentPreviewData = data.entry;
      
      // Populate the preview modal
      populatePreviewModal(data.entry, actionType);
      
      // Show the modal
      document.getElementById('timelinePreviewModal').style.display = 'flex';
      
    } catch (error) {
      console.error('[TIMELINE PREVIEW] Error loading timeline entry:', error);
      showCustomAlert('Error loading timeline entry details: ' + error.message);
    }
  }

  // Populate the preview modal with timeline entry data
  function populatePreviewModal(entry, actionType) {
    const modalTitle = document.getElementById('previewModalTitle');
    const modalBody = document.getElementById('previewModalBody');
    const editButton = document.getElementById('editPreviewAction');
    
    modalTitle.textContent = `${actionType} - Details`;
    
    // Parse the details JSON with enhanced debugging
    let details = {};
    try {
      if (entry.details) {
        details = typeof entry.details === 'string' ? JSON.parse(entry.details) : entry.details;
        console.log(`[PREVIEW DEBUG] ${actionType} details parsed:`, details);
        console.log(`[PREVIEW DEBUG] ${actionType} full entry:`, entry);
        
        // Additional debug for specific fields
        if (actionType.toLowerCase() === 'mediation') {
          console.log('[MEDIATION DEBUG] parties_involved:', details.parties_involved);
          console.log('[MEDIATION DEBUG] agenda:', details.agenda);
          console.log('[MEDIATION DEBUG] files:', details.files);
        } else if (actionType.toLowerCase() === 'send invitation') {
          console.log('[INVITATION DEBUG] to:', details.to);
          console.log('[INVITATION DEBUG] location:', details.location);
          console.log('[INVITATION DEBUG] agenda:', details.agenda);
          console.log('[INVITATION DEBUG] meeting_date:', details.meeting_date);
          console.log('[INVITATION DEBUG] meeting_time:', details.meeting_time);
        }
      } else {
        console.warn(`[PREVIEW DEBUG] No details found for ${actionType}`);
      }
    } catch (e) {
      console.error('Error parsing entry details:', e);
      console.log('Raw entry.details:', entry.details);
    }
    
    // Generate preview content based on action type
    let previewHTML = '';
    
    switch (actionType.toLowerCase()) {
      case 'inspection':
        previewHTML = generateInspectionPreview(details, entry);
        break;
      case 'invitation':
      case 'send invitation':
        previewHTML = generateInvitationPreview(details, entry);
        break;
      case 'mediation':
        previewHTML = generateMediationPreview(details, entry);
        break;
      case 'assessment':
        previewHTML = generateAssessmentPreview(details, entry);
        break;
      case 'out of jurisdiction':
        previewHTML = generateOutOfJurisdictionPreview(details, entry);
        break;
      default:
        previewHTML = generateGenericPreview(details, entry);
    }
    
    modalBody.innerHTML = previewHTML;
    
    // Show edit button only if this entry was created by current user role (admin)
    // For admin view, show edit button for admin-created actions
    const editableActionTypes = ['inspection', 'send invitation', 'mediation', 'assessment'];
    const actionTypeLower = actionType.toLowerCase();
    const isEditableAction = editableActionTypes.some(type => 
      actionTypeLower.includes(type) || type.includes(actionTypeLower)
    );
    
    if (currentRole === 'admin' && isEditableAction) {
      editButton.style.display = 'inline-block';
    } else {
      editButton.style.display = 'none';
    }
  }

  // Generate inspection preview HTML - matches exact original form layout
  function generateInspectionPreview(details, entry) {
    const formatDate = (dateStr) => {
      if (!dateStr) return 'Not specified';
      try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
      } catch (e) {
        return dateStr;
      }
    };

    const formatScope = (scope) => {
      if (!scope || (Array.isArray(scope) && scope.length === 0)) return 'Not specified';
      if (Array.isArray(scope)) {
        return scope.map(s => {
          switch(s) {
            case 'safety': return 'Safety';
            case 'affected_lots': return 'Affected lot/s';
            case 'measurement': return 'Measurement of lot/s';
            case 'relation_owner': return 'Relation to the lot owner (if non-HOA)';
            default: return s.charAt(0).toUpperCase() + s.slice(1).replace(/_/g, ' ');
          }
        }).join(', ');
      }
      return scope.toString();
    };

    return `
      <div style="padding: 15px;">
        <!-- Assigned Personnel -->
        <div class="form-group">
          <label><strong>Assigned Personnel:</strong></label>
          <div class="readonly-field">${entry.assigned_to || 'Not specified'}</div>
        </div>
        
        <!-- Location of Inspection -->
        <div class="form-group">
          <label><strong>Location of Inspection:</strong></label>
          <div class="readonly-field">${details.location || 'Not specified'}</div>
        </div>
        
        <hr style="margin: 10px 0;">
        
        <!-- Deadline -->
        <div class="form-group">
          <label><strong>Deadline:</strong></label>
          <div class="readonly-field">${formatDate(details.deadline)}</div>
        </div>
        
        <!-- Scope of Inspection -->
        <div class="form-group">
          <label><strong>Scope of Inspection:</strong></label>
          <div class="readonly-field">${formatScope(details.scope)}</div>
        </div>
        
        ${details.description ? `
        <div class="form-group">
          <label><strong>Additional Notes:</strong></label>
          <div class="readonly-field">${details.description}</div>
        </div>
        ` : ''}
        
        ${generateFileAttachments(details)}
      </div>
    `;
  }

  // Generate invitation preview HTML - matches exact original form layout
  function generateInvitationPreview(details, entry) {
    const formatDate = (dateStr) => {
      if (!dateStr) return 'Not specified';
      try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
      } catch (e) {
        return dateStr;
      }
    };

    const formatTime = (timeStr) => {
      if (!timeStr) return 'Not specified';
      try {
        // Handle both time-only and full datetime formats
        if (timeStr.includes('T') || timeStr.includes(' ')) {
          const date = new Date(timeStr);
          return date.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
          });
        } else {
          // Time-only format (HH:MM or HH:MM:SS)
          const [hours, minutes] = timeStr.split(':');
          const date = new Date();
          date.setHours(parseInt(hours), parseInt(minutes), 0);
          return date.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
          });
        }
      } catch (e) {
        return timeStr;
      }
    };

    // Helper function to format the "To" field
    const formatToField = () => {
      const toField = details.to || details.individuals || details.invTo;
      if (!toField) return 'Not specified';
      
      if (Array.isArray(toField)) {
        return toField.length > 0 ? toField.join(', ') : 'Not specified';
      }
      
      if (typeof toField === 'string') {
        return toField.trim() || 'Not specified';
      }
      
      return 'Not specified';
    };

    return `
      <div style="padding: 15px;">
        <!-- To -->
        <div class="form-group">
          <label><strong>To:</strong></label>
          <div class="readonly-field">${formatToField()}</div>
        </div>

        <!-- Location -->
        <div class="form-group">
          <label><strong>Location:</strong></label>
          <div class="readonly-field">${details.location || details.venue || details.invLocation || 'Not specified'}</div>
        </div>
        
        <!-- Agenda -->
        <div class="form-group">
          <label><strong>Agenda:</strong></label>
          <div class="readonly-field">${details.agenda || details.invAgenda || 'Not specified'}</div>
        </div>
        
        <hr style="margin: 10px 0;">

        <!-- Date of Meeting -->
        <div class="form-group">
          <label><strong>Date of Meeting:</strong></label>
          <div class="readonly-field">${formatDate(details.meeting_date || details.invDate)}</div>
        </div>
        
        <!-- Time of Meeting -->
        <div class="form-group">
          <label><strong>Time of Meeting:</strong></label>
          <div class="readonly-field">${formatTime(details.meeting_time || details.invTime)}</div>
        </div>

        <!-- Assigned Personnel -->
        <div class="form-group">
          <label><strong>Assigned Personnel:</strong></label>
          <div class="readonly-field">${entry.assigned_to || 'Not specified'}</div>
        </div>
        
        ${details.description ? `
        <div class="form-group">
          <label><strong>Additional Notes:</strong></label>
          <div class="readonly-field">${details.description}</div>
        </div>
        ` : ''}
        
        ${generateFileAttachments(details)}
      </div>
    `;
  }

  // Generate mediation preview HTML - matches exact original form layout
  function generateMediationPreview(details, entry) {
    // Helper function to format parties involved with multiple fallbacks
    const formatPartiesInvolved = () => {
      // Try multiple possible field names and formats
      const parties = details.parties_involved || details.partiesInvolved || details.parties;
      
      if (!parties) return 'Not specified';
      
      if (Array.isArray(parties)) {
        return parties.length > 0 ? parties.join(', ') : 'Not specified';
      }
      
      if (typeof parties === 'string') {
        // Handle newline-separated or comma-separated strings
        const cleanParties = parties.trim();
        if (cleanParties.includes('\n')) {
          return cleanParties.split('\n').map(p => p.trim()).filter(Boolean).join(', ');
        }
        return cleanParties || 'Not specified';
      }
      
      return 'Not specified';
    };

    return `
      <div style="padding: 15px;">
        <!-- Assigned Personnel -->
        <div class="form-group">
          <label><strong>Assigned Personnel:</strong></label>
          <div class="readonly-field">${entry.assigned_to || 'Not specified'}</div>
        </div>
        
        <!-- Parties Involved -->
        <div class="form-group">
          <label><strong>Parties Involved:</strong></label>
          <div class="readonly-field">${formatPartiesInvolved()}</div>
        </div>
        
        <hr style="margin: 10px 0;">
        
        <!-- Agenda -->
        <div class="form-group">
          <label><strong>Agenda:</strong></label>
          <div class="readonly-field">${details.agenda || 'Not specified'}</div>
        </div>
        
        <!-- Advisors/Witnesses -->
        <div class="form-group">
          <label><strong>Advisors / Witnesses:</strong></label>
          <div class="readonly-field">
            ${details.advisors ? (Array.isArray(details.advisors) ? details.advisors.join(', ') : details.advisors) : 
              (details.witnesses ? (Array.isArray(details.witnesses) ? details.witnesses.join(', ') : details.witnesses) : 'Not specified')}
          </div>
        </div>
        
        <!-- Summary -->
        <div class="form-group">
          <label><strong>Summary:</strong></label>
          <div class="readonly-field">${details.summary || details.description || 'No summary provided'}</div>
        </div>
        
        <!-- File uploads -->
        ${details.files && details.files.length > 0 ? `
        <div class="form-group">
          <label><strong>Uploaded Files:</strong></label>
          <div class="readonly-field">
            ${details.files.map((file, index) => `
              <div style="margin-bottom: 5px;">
                <strong>${file.type || file.description || 'File ' + (index + 1)}:</strong> ${file.filename || file.name || 'Uploaded file'}
              </div>
            `).join('')}
          </div>
        </div>
        ` : ''}
        
        ${generateFileAttachments(details)}
      </div>
    `;
  }

  // Generate assessment preview HTML - matches exact original form layout
  function generateAssessmentPreview(details, entry) {
    return `
      <div style="padding: 15px;">
        <!-- Assessment Details -->
        <div class="form-group">
          <label><strong>Assessment Details:</strong></label>
          <div class="readonly-field" style="white-space: pre-wrap; max-height: 120px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; border-radius: 6px; background-color: #f9f9f9;">
            ${details.assessment_details || details.description || details.notes || entry.description || 'No assessment details provided'}
          </div>
        </div>
        
        <div class="form-group">
          <label><strong>Assessed By:</strong></label>
          <div class="readonly-field">${entry.assigned_to || details.assessed_by || 'Admin'}</div>
        </div>
        
        <div class="form-group">
          <label><strong>Date & Time:</strong></label>
          <div class="readonly-field">${entry.action_datetime ? new Date(entry.action_datetime).toLocaleString() : 'Not specified'}</div>
        </div>
        
        ${generateFileAttachments(details)}
      </div>
    `;
  }

  // Generate out of jurisdiction preview HTML - matches exact original form layout
  function generateOutOfJurisdictionPreview(details, entry) {
    return `
      <div style="padding: 15px;">
        <!-- Under the Scope of -->
        <div class="form-group">
          <label><strong>Under the Scope of:</strong></label>
          <div class="readonly-field">${details.scope || details.outOfJurisdiction || 'Not specified'}</div>
        </div>
        
        ${details.others_specify ? `
        <div class="form-group">
          <label><strong>Others (Specified):</strong></label>
          <div class="readonly-field">${details.others_specify}</div>
        </div>
        ` : ''}
        
        <!-- Out of Jurisdiction Remarks -->
        <div class="form-group">
          <label><strong>Out of Jurisdiction Remarks:</strong></label>
          <div class="readonly-field" style="white-space: pre-wrap; max-height: 120px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; border-radius: 6px; background-color: #f9f9f9;">
            ${details.remarks || details.description || entry.description || 'No remarks provided'}
          </div>
        </div>
        
        <div class="form-group">
          <label><strong>Processed By:</strong></label>
          <div class="readonly-field">${entry.assigned_to || 'Admin'}</div>
        </div>
        
        <div class="form-group">
          <label><strong>Date & Time:</strong></label>
          <div class="readonly-field">${entry.action_datetime ? new Date(entry.action_datetime).toLocaleString() : 'Not specified'}</div>
        </div>
        
        ${generateFileAttachments(details)}
      </div>
    `;
  }

  // Generate generic preview HTML
  function generateGenericPreview(details, entry) {
    return `
      <div style="padding: 15px;">
        <div class="form-group">
          <label><strong>Action:</strong></label>
          <div class="readonly-field">${entry.type_of_action}</div>
        </div>
        
        <div class="form-group">
          <label><strong>Assigned To:</strong></label>
          <div class="readonly-field">${entry.assigned_to || 'Not specified'}</div>
        </div>
        
        <div class="form-group">
          <label><strong>Description:</strong></label>
          <div class="readonly-field">${details.description || entry.description || 'No description provided'}</div>
        </div>
        
        <div class="form-group">
          <label><strong>Date & Time:</strong></label>
          <div class="readonly-field">${entry.action_datetime ? new Date(entry.action_datetime).toLocaleString() : 'Not specified'}</div>
        </div>
        
        ${generateFileAttachments(details)}
      </div>
    `;
  }

  // Generate file attachments section
  function generateFileAttachments(details) {
    if (!details.files || !Array.isArray(details.files) || details.files.length === 0) {
      return '';
    }
    
    const filesHTML = details.files.map((file, index) => {
      if (typeof file === 'string') {
        return `
          <div style="margin: 5px 0;">
            <a href="${file}" target="_blank" style="color: #007bff; text-decoration: none;">
              📄 ${file}
            </a>
          </div>
        `;
      }
      
      // Handle file object with multiple possible field names
      const fileName = file.filename || file.name || `File ${index + 1}`;
      const fileDescription = file.type || file.description || fileName;
      const fileUrl = file.url || file.path || '#';
      
      return `
        <div style="margin: 5px 0;">
          <a href="${fileUrl}" target="_blank" style="color: #007bff; text-decoration: none;">
            📄 <strong>${fileDescription}:</strong> ${fileName}
          </a>
        </div>
      `;
    }).join('');
    
    return `
      <div class="form-group">
        <label><strong>Attached Files:</strong></label>
        <div class="readonly-field">
          ${filesHTML}
        </div>
      </div>
    `;
  }

  // Close timeline preview modal
  function closeTimelinePreview() {
    document.getElementById('timelinePreviewModal').style.display = 'none';
    // Don't clear currentPreviewData here - keep it for editing
  }

  // Edit timeline entry
  function editTimelineEntry() {
    /* EDIT FUNCTIONALITY - COMMENTED OUT FOR NOW DI KO PA ALAM IF ITULOY TO
    // TODO: Implement edit functionality that updates existing timeline entry instead of creating new one
    // Requirements:
    // 1. Should edit the existing previewed status entry, not create new one
    // 2. Should update the saved timestamp accordingly
    // 3. Should toggle edit mode for the same data in the preview modal
    // 4. Should maintain exact same format and layout as original action modal
    
    if (!currentPreviewData) {
      showCustomAlert('No timeline entry data available for editing.');
      return;
    }
    
    // Store the data in a local variable before closing
    const timelineData = currentPreviewData;
    
    // Close the preview modal
    document.getElementById('timelinePreviewModal').style.display = 'none';
    
    // Open the appropriate action modal with pre-populated data
    // This will use the existing modal system but populate it with the timeline entry data
    if (timelineData.type_of_action.toLowerCase().includes('inspection')) {
      // Open assign modal for inspection editing
      proceedToAssign();
      // Pre-populate with existing data
      setTimeout(() => populateAssignModalWithTimelineData(timelineData), 100);
    } else if (timelineData.type_of_action.toLowerCase().includes('invitation')) {
      // Open assign modal for invitation editing
      proceedToAssign();
      // Pre-populate with existing data
      setTimeout(() => populateAssignModalWithTimelineData(timelineData), 100);
    } else {
      // Open action modal for other types
      proceedToAction();
      // Pre-populate with existing data
      setTimeout(() => populateActionModalWithTimelineData(timelineData), 100);
    }
    */
    
    // Temporary: Show alert that edit functionality is being developed
    showCustomAlert('Edit functionality is being developed. Preview mode only for now.');
  }

  /* EDIT MODAL POPULATION FUNCTIONS - COMMENTED OUT FOR NOW
  // TODO: These functions will be used when edit functionality is implemented
  // They should populate the action modals with existing timeline data for editing
  
  // Populate assign modal with timeline data
  function populateAssignModalWithTimelineData(timelineData) {
    try {
      const details = typeof timelineData.details === 'string' ? JSON.parse(timelineData.details) : timelineData.details;
      
      console.log('Populating assign modal with data:', { timelineData, details });
      
      // Set assign type and trigger field visibility
      const assignTypeSelect = document.getElementById('assignType');
      if (assignTypeSelect) {
        if (timelineData.type_of_action.toLowerCase().includes('inspection')) {
          assignTypeSelect.value = 'Inspection';
        } else if (timelineData.type_of_action.toLowerCase().includes('invitation')) {
          assignTypeSelect.value = 'Invitation';
        }
        // Trigger change event to show appropriate fields
        assignTypeSelect.dispatchEvent(new Event('change'));
      }
      
      // Wait a bit for the fields to appear, then populate them
      setTimeout(() => {
        // Populate Inspection fields
        if (timelineData.type_of_action.toLowerCase().includes('inspection')) {
          const assignedPersonnel = document.getElementById('assignedPersonnel');
          const inspectionLocation = document.getElementById('inspectionLocation');
          const inspectionDeadline = document.getElementById('inspectionDeadline');
          
          if (assignedPersonnel && timelineData.assigned_to) {
            assignedPersonnel.value = timelineData.assigned_to;
          }
          
          if (inspectionLocation && details.location) {
            inspectionLocation.value = details.location;
          }
          
          if (inspectionDeadline && details.deadline) {
            inspectionDeadline.value = details.deadline;
          }
          
          // Populate scope checkboxes if they exist
          if (details.scope && Array.isArray(details.scope)) {
            details.scope.forEach(scopeItem => {
              const checkbox = document.querySelector(`input[name="scope[]"][value="${scopeItem}"]`);
              if (checkbox) checkbox.checked = true;
            });
          }
          
          // Handle "Others" checkbox and input
          if (details.others) {
            const othersCheckbox = document.getElementById('othersCheckbox');
            const othersInput = document.getElementById('othersInput');
            if (othersCheckbox) othersCheckbox.checked = true;
            if (othersInput) othersInput.value = details.others;
          }
        }
        
        // Populate Invitation fields
        if (timelineData.type_of_action.toLowerCase().includes('invitation')) {
          const invAssignedPersonnel = document.getElementById('invAssignedPersonnel');
          const invTo = document.getElementById('invTo');
          const invAgenda = document.getElementById('invAgenda');
          const invLocation = document.getElementById('invLocation');
          const invDate = document.getElementById('invDate');
          const invTime = document.getElementById('invTime');
          
          if (invAssignedPersonnel && timelineData.assigned_to) {
            invAssignedPersonnel.value = timelineData.assigned_to;
          }
          
          if (invAgenda && details.agenda) {
            invAgenda.value = details.agenda;
          }
          
          if (invLocation && details.venue) {
            invLocation.value = details.venue;
          }
          
          if (invDate && details.meeting_date) {
            invDate.value = details.meeting_date;
          }
          
          if (invTime && details.meeting_time) {
            invTime.value = details.meeting_time;
          }
          
          // Handle dynamic invTo fields (individuals)
          if (invTo && details.individuals) {
            // Clear existing fields first
            invTo.innerHTML = '';
            
            // Handle both string and array formats
            let individuals = [];
            if (typeof details.individuals === 'string') {
              individuals = details.individuals.split(',').map(name => name.trim());
            } else if (Array.isArray(details.individuals)) {
              individuals = details.individuals;
            }
            
            // Create input fields for each individual
            individuals.forEach(name => {
              if (name) {
                const input = document.createElement('input');
                input.type = 'text';
                input.name = 'invTo[]';
                input.value = name.trim();
                input.placeholder = 'Enter name';
                input.required = true;
                invTo.appendChild(input);
              }
            });
          }
        }
      }, 150);
      
    } catch (error) {
      console.error('Error populating assign modal with timeline data:', error);
      showCustomAlert('Error loading timeline data for editing: ' + error.message);
    }
  }

  // Populate action modal with timeline data
  function populateActionModalWithTimelineData(timelineData) {
    try {
      const details = typeof timelineData.details === 'string' ? JSON.parse(timelineData.details) : timelineData.details;
      
      console.log('Populating action modal with data:', { timelineData, details });
      
      // Set action type and trigger field visibility
      const actionTypeSelect = document.getElementById('actionType');
      if (actionTypeSelect) {
        // Map timeline action types to modal action types
        let modalActionType = timelineData.type_of_action;
        if (modalActionType.toLowerCase().includes('mediation')) {
          modalActionType = 'Mediation';
        } else if (modalActionType.toLowerCase().includes('assessment')) {
          modalActionType = 'Assessment';
        } else if (modalActionType.toLowerCase().includes('jurisdiction')) {
          modalActionType = 'Out of Jurisdiction';
        }
        
        actionTypeSelect.value = modalActionType;
        // Trigger change event to show appropriate fields
        actionTypeSelect.dispatchEvent(new Event('change'));
      }
      
      // Wait a bit for the fields to appear, then populate them
      setTimeout(() => {
        // Populate Mediation fields
        if (timelineData.type_of_action.toLowerCase().includes('mediation')) {
          const agenda = document.querySelector("input[name='agenda']");
          const summary = document.querySelector("textarea[name='summary']");
          const medAssignedPersonnel = document.getElementById('medAssignedPersonnel');
          
          if (agenda && details.agenda) {
            agenda.value = details.agenda;
          }
          
          if (summary && details.summary) {
            summary.value = details.summary;
          }
          
          if (medAssignedPersonnel && timelineData.assigned_to) {
            medAssignedPersonnel.value = timelineData.assigned_to;
          }
          
          // Populate witnesses if they exist
          const witnessContainer = document.getElementById('witnessContainer');
          if (witnessContainer && details.witnesses && Array.isArray(details.witnesses)) {
            // Clear existing witnesses first
            witnessContainer.innerHTML = '';
            
            details.witnesses.forEach(witness => {
              if (witness) {
                const div = document.createElement("div");
                div.classList.add("witness-row");
                div.innerHTML = `
                  <input type="text" name="witness[]" placeholder="Enter witness/advisor name" value="${witness}" required>
                  <button type="button" class="remove-btn-wit" onclick="this.parentElement.remove()">
                    <span class="material-icons">close</span>
                  </button>
                `;
                witnessContainer.appendChild(div);
              }
            });
          }
        }
        
        // Populate Assessment fields
        if (timelineData.type_of_action.toLowerCase().includes('assessment')) {
          const assessmentNotes = document.getElementById('assessmentNotes');
          const assAssignedPersonnel = document.getElementById('assAssignedPersonnel');
          
          if (assessmentNotes && details.notes) {
            assessmentNotes.value = details.notes;
          }
          
          if (assAssignedPersonnel && timelineData.assigned_to) {
            assAssignedPersonnel.value = timelineData.assigned_to;
          }
        }
        
        // Populate Out of Jurisdiction fields
        if (timelineData.type_of_action.toLowerCase().includes('jurisdiction')) {
          const outOfJurisdictionNotes = document.getElementById('outOfJurisdictionNotes');
          
          if (outOfJurisdictionNotes && details.notes) {
            outOfJurisdictionNotes.value = details.notes;
          }
          
          // Handle jurisdiction radio buttons
          if (details.jurisdiction_type) {
            const radio = document.querySelector(`input[name="outOfJurisdiction"][value="${details.jurisdiction_type}"]`);
            if (radio) {
              radio.checked = true;
              
              // Handle "Others" input if needed
              if (details.jurisdiction_type === 'Others' && details.others) {
                const outOthersInput = document.getElementById('outOthersInput');
                if (outOthersInput) {
                  outOthersInput.value = details.others;
                }
              }
            }
          }
        }
      }, 150);
      
    } catch (error) {
      console.error('Error populating action modal with timeline data:', error);
      showCustomAlert('Error loading timeline data for editing: ' + error.message);
    }
  }
  */ // End of EDIT MODAL POPULATION FUNCTIONS comment block

  // Add CSS for readonly fields
  const style = document.createElement('style');
  style.textContent = `
    .readonly-field {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 8px 12px;
      margin: 5px 0 15px 0;
      color: #495057;
      font-size: 14px;
      min-height: 20px;
    }
    .form-group {
      margin-bottom: 8px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    .close, .close:hover, .close:focus {
      cursor: pointer !important;
    }
    .modal-top .close {
      cursor: pointer !important;
      font-size: 24px;
      font-weight: bold;
      color: #aaa;
      float: right;
      line-height: 1;
      text-decoration: none;
    }
    .modal-top .close:hover {
      color: #000;
    }
  `;
  document.head.appendChild(style);

  // Extract files from timeline entry details for admin view
  function getAdminFilesFromEntry(entry) {
    try {
      if (entry.details && typeof entry.details === 'object') {
        return entry.details.files || [];
      }
      if (entry.details && typeof entry.details === 'string') {
        const parsed = JSON.parse(entry.details);
        return parsed.files || [];
      }
      return [];
    } catch (error) {
      console.error('Error parsing entry details for files:', error);
      return [];
    }
  }

  // Show file preview modal for admin
  function showAdminFilePreview(files, actionType, historyId) {
    if (!files || files.length === 0) {
      showCustomAlert('No files available for this entry.');
      return;
    }

    // Create enhanced modal for admin file preview with edit capabilities
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.5); display: flex; align-items: center; 
      justify-content: center; z-index: 10000;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
      background: white; padding: 30px; border-radius: 8px; 
      max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
    `;

    let fileListHTML = `
      <h3>Attachments for ${actionType}</h3>
      <div style="margin-bottom: 20px;">
    `;

    files.forEach((file, index) => {
      const fileName = file.filename || file.name || `File ${index + 1}`;
      const fileType = file.type || 'document';
      fileListHTML += `
        <div style="padding: 15px; border: 1px solid #ddd; margin: 10px 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-weight: 500;">📄 ${fileName}</div>
            <div style="font-size: 12px; color: #666; margin-top: 2px;">Type: ${fileType}</div>
          </div>
          <div>
            <button onclick="previewAdminFile('${fileName}')" 
                    style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; margin-right: 5px;">
              Preview
            </button>
            <button onclick="downloadAdminFile('${fileName}')" 
                    style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer;">
              Download
            </button>
          </div>
        </div>
      `;
    });

    fileListHTML += `
      </div>
      <div style="text-align: right;">
        <button onclick="editTimelineEntry()" 
                style="background: #ffc107; color: #212529; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
          Edit Entry
        </button>
        <button onclick="this.closest('.admin-file-preview-modal').remove()" 
                style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
          Close
        </button>
      </div>
    `;

    content.innerHTML = fileListHTML;
    modal.className = 'admin-file-preview-modal';
    modal.appendChild(content);
    document.body.appendChild(modal);

    // Close on background click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  }

  // Preview file for admin
  function previewAdminFile(filename) {
    // TODO: Implement proper file preview (PDF viewer, image preview, etc.)
    const fileUrl = `/files/complaints/${filename}`; // Placeholder URL
    window.open(fileUrl, '_blank');
  }

  // Download file for admin
  function downloadAdminFile(filename) {
    // TODO: Implement proper file serving endpoint
    const fileUrl = `/files/complaints/${filename}`; // Placeholder URL
    const link = document.createElement('a');
    link.href = fileUrl;
    link.download = filename;
    link.click();
  }

  // View staff uploaded files (for "Inspection done" and "Sent Invitation" entries)
  function viewStaffFiles(attachedFiles, actionType, historyId) {
    if (!attachedFiles || attachedFiles.length === 0) {
      showCustomAlert('No files available for this entry.');
      return;
    }

    // Create enhanced modal for staff file preview with view/download capabilities
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
      background: rgba(0,0,0,0.8); display: flex; align-items: center; 
      justify-content: center; z-index: 10000;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
      background: white; border-radius: 8px; padding: 20px; 
      max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
    `;

    let fileListHTML = `
      <h3 style="margin: 0 0 15px 0; color: #333;">Staff Uploaded Files - ${actionType}</h3>
      <div style="margin-bottom: 20px;">
    `;

    attachedFiles.forEach((fileName, index) => {
      // Create file URL (adjust path as needed for your file serving setup)
      const fileUrl = `/uploads/staff/${fileName}`;
      const fileExt = fileName.split('.').pop().toLowerCase();
      const isImage = ['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(fileExt);
      const isPDF = fileExt === 'pdf';
      
      fileListHTML += `
        <div style="border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-bottom: 10px; background: #f9f9f9;">
          <div style="display: flex; justify-content: between; align-items: center;">
            <div style="flex: 1;">
              <strong>${fileName}</strong>
              <div style="font-size: 12px; color: #666; margin-top: 2px;">
                ${isImage ? '📷 Image' : isPDF ? '📄 PDF Document' : '📁 File'}
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              ${isImage || isPDF ? `
                <button onclick="viewStaffFile('${fileUrl}', '${fileName}')" 
                        style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  👁️ View
                </button>
              ` : ''}
              <button onclick="downloadStaffFile('${fileUrl}', '${fileName}')" 
                      style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                💾 Download
              </button>
            </div>
          </div>
        </div>
      `;
    });

    fileListHTML += `
      </div>
      <div style="text-align: center;">
        <button onclick="this.closest('.staff-files-modal').remove()" 
                style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
          Close
        </button>
      </div>
    `;

    content.innerHTML = fileListHTML;
    modal.className = 'staff-files-modal';
    modal.appendChild(content);
    document.body.appendChild(modal);

    // Close on background click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  }

  // View individual staff file
  function viewStaffFile(fileUrl, fileName) {
    // For remote devices, we'll open in new tab which should work for most file types
    window.open(fileUrl, '_blank', 'noopener,noreferrer');
  }

  // Download staff file
  function downloadStaffFile(fileUrl, fileName) {
    // Create temporary link for download
    const link = document.createElement('a');
    link.href = fileUrl;
    link.download = fileName;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Make functions globally available
  window.showTimelinePreview = showTimelinePreview;
  window.closeTimelinePreview = closeTimelinePreview;
  window.editTimelineEntry = editTimelineEntry;
  window.showCustomAlert = showCustomAlert;
  window.closeCustomAlert = closeCustomAlert;
  window.getAdminFilesFromEntry = getAdminFilesFromEntry;
  window.showAdminFilePreview = showAdminFilePreview;
  window.previewAdminFile = previewAdminFile;
  window.downloadAdminFile = downloadAdminFile;
  window.viewStaffFiles = viewStaffFiles;
  window.viewStaffFile = viewStaffFile;
  window.downloadStaffFile = downloadStaffFile;
  </script>
</body>
</html>