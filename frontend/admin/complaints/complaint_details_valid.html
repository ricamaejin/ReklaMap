<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="../../images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="../../css/complainants.css">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="../../images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <a href="../../complainant/home/dashboard.html" class="nav-item">Map</a>
      <a href="../../complainant/complaints/submitted_complaints.html" class="nav-item active">Complaints</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header"><h1>Complaint</h1></header>

    <div class="complaint-layout">
      <!-- Complaint Form Placeholder -->
      <!-- TODO BACKEND: Populate complaint-form div with complaint details from DB -->
      <div class="complaint-form">Complaint form data will load here...</div>

      <!-- Right Panel -->
      <div class="right-panel">
        <div class="map-card">Map / Asset details here...</div>
        <button class="action-btn" onclick="openComplaint()">Action</button>

        <!-- TODO BACKEND: Replace static timeline entries with timeline data from DB -->
        <div class="timeline">
          <div class="timeline-entry">
            <h4>6/19/2025 - Send Invitation 
              <button class="file-btn" data-pdf="sample.pdf"></button> 
              <span>Josie Rosal</span>
            </h4>
            <p>An invitation has been sent...</p>
          </div>
          <div class="timeline-entry">
            <h4>6/13/2025 - Assessment <span>Josie Rosal</span></h4>
            <p>Upon inspection, the staff verified the complaint’s validity...</p>
          </div>
        </div>
        <button class="resolved-btn">Resolved</button>
      </div>
    </div>

    <!-- ACTION MODAL -->
    <div class="modal-overlay" id="modal">
      <div class="modal">
        <div class="modal-header">
          <h2>Action</h2>
          <div id="datetime"><div id="date"></div><div id="time"></div></div>
        </div>
        <hr>

        <label for="type">Type of Action:</label>
        <div class="type-action-row">
        <select id="type" name="actionType" aria-label="Type of Action">
            <option value="" disabled selected hidden>Select Action</option>
            <option value="Inspection">Inspection</option>
            <option value="Send Invitation">Send Invitation</option>
            <option value="Mediation">Mediation</option>
            <option value="Other">Other</option>
        </select>
        <input type="text" id="actionOther" name="actionOther" placeholder="Specify" style="display:none;" />
        </div>


        <label>Assigned to:</label>
        <select>
          <option value="" disabled selected hidden>Select Staff</option>
          <option>Staff A</option>
          <option>Staff B</option>
        </select>

        <label>Description:</label>
        <textarea></textarea>

        <label>File:</label>
        <div class="file-upload"><button onclick="openFiles()">Upload</button></div>

        <div class="modal-footer">
          <button class="btn-cancel" onclick="closeComplaint()">Cancel</button>
          <button class="btn-save">Save</button> 
          <!-- TODO BACKEND: When user clicks Save, send action data (type, specify if other, staff, description, file) to server and save in database -->
        </div>
      </div>
    </div>

    <!-- FILES MODAL -->
    <div id="filesModal" class="files-modal-overlay" style="display:none;">
      <div class="files-modal">
        <div class="files-header">
          <h2>Files</h2><div id="filesDateTime"></div>
        </div>
        <hr>

        <div class="file-tabs">
          <span class="tab active" data-tab="uploaded">Uploaded</span>
          <span class="tab" data-tab="downloadable">Downloadable</span>
        </div>

        <!-- TODO BACKEND: Fetch uploaded files for this complaint and display them in .uploaded-list -->
        <div class="file-list uploaded-list">
          <div class="file-row"><span>Mediation - First Notice.pdf</span><button class="download-btn">Download ⬇</button></div>
        </div>

        <div class="file-list downloadable-list" style="display:none;">
          <div class="file-row">
            <span>Upload new file:</span>
            <!-- TODO BACKEND: Handle file uploads from userFileInput and store in server -->
            <input type="file" id="userFileInput" accept=".pdf,.jpeg,.jpg,.png" />
          </div>
          <div id="userFilesContainer"></div>
        </div>

        <div class="files-footer"><button class="close-btn" onclick="closeFiles()">Close</button></div>
      </div>
    </div>
  </main>

  <script>
    (function () {
      const modal = document.getElementById('modal');
      const dateEl = document.getElementById('datetime');
      const select = document.getElementById('type');
      const actionOther = document.getElementById('actionOther');
      let interval = null;

      function updateComplaintDateTime() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', {
          weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'
        });
        const timeStr = now.toLocaleTimeString('en-US', {
          hour: '2-digit', minute: '2-digit', hour12: true
        });
        dateEl.innerHTML = `${dateStr}<br>${timeStr}`;
      }

      function openComplaint() {
        modal.style.display = 'flex';
        updateComplaintDateTime();
        if (!interval) interval = setInterval(updateComplaintDateTime, 1000);
        select.value = "";
        actionOther.style.display = "none";
      }

      function closeComplaint() {
        modal.style.display = 'none';
        if (interval) { clearInterval(interval); interval = null; }
      }

      // Show "Specify" field if Other selected
      select.addEventListener("change", () => {
        if (select.value === "Other") {
          actionOther.style.display = "inline-block";
        } else {
          actionOther.style.display = "none";
        }
      });

      modal.addEventListener('click', e => { if (e.target === modal) closeComplaint(); });

      window.openComplaint = openComplaint;
      window.closeComplaint = closeComplaint;
    })();

    // File button on timeline
    document.querySelectorAll('.file-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const pdfUrl = btn.getAttribute('data-pdf'); //should replace data-pdf="sample.pdf" with actual file paths.
        if (pdfUrl) window.open(pdfUrl, '_blank');
        else alert("No PDF linked yet.");
      });
    });

    // Files Modal
    function openFiles() {
      const modal = document.getElementById("filesModal");
      modal.style.display = "flex";
      updateFilesDateTime();
    }
    function closeFiles() {
      document.getElementById("filesModal").style.display = "none";
    }
    function updateFilesDateTime() {
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-US', {
        weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'
      });
      const timeStr = now.toLocaleTimeString('en-US', {
        hour: '2-digit', minute: '2-digit', hour12: true
      });
      document.getElementById("filesDateTime").innerHTML = `${dateStr}<br>${timeStr}`;
    }
    document.getElementById("filesModal").addEventListener("click", e => {
      if (e.target.id === "filesModal") closeFiles();
    });

    // Switch tabs
    document.querySelectorAll('.file-tabs .tab').forEach(tab => {
      tab.addEventListener('click', function () {
        document.querySelectorAll('.file-tabs .tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        const target = this.getAttribute('data-tab');
        document.querySelector('.uploaded-list').style.display = target === "uploaded" ? "block" : "none";
        document.querySelector('.downloadable-list').style.display = target === "downloadable" ? "block" : "none";
      });
    });

    // User file uploads
    document.getElementById("userFileInput").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (file) {
        const fileRow = document.createElement("div");
        fileRow.className = "file-row";

        // Create a blob URL so it can be downloaded
        const url = URL.createObjectURL(file);

        fileRow.innerHTML = `
        <span>${file.name}</span>
        <a href="${url}" download="${file.name}" class="download-btn">Download ⬇</a>
        `;

        document.getElementById("userFilesContainer").appendChild(fileRow);
    }
    });

  </script>
</body>
</html>
