<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/logo.png">
  <title>ReklaMap</title>
  <link rel="stylesheet" href="/css/complainants.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <img src="/images/logo.png" alt="ReklaMap Logo" class="logo">
      <span class="title"><span class="blue-text">Rekla</span><span class="green-text">Map</span></span>
    </div>
    <nav class="nav-menu">
      <a href="/admin/map/index.html" class="nav-item">Map</a>
      <a href="/admin/complaints/all.html" class="nav-item active">Complaints</a>
      <a href="/admin/database/beneficiaries.html" class="nav-item">Database</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header"><h1>Complaint</h1></header>

    <div class="complaint-layout" style="margin-top: 30px;">
      <!-- Complaint Form Placeholder -->
      <!-- TODO BACKEND: Populate complaint-form div with complaint details from DB -->
      <div class="complaint-form">Complaint form data will load here...</div>

      <!-- Right Panel -->
      <div class="right-panel">
        <div class="map-card">Map / Asset details here...</div>
        <button class="action-btn" onclick="openComplaint()">Action</button>

        <!-- TODO BACKEND: Replace static timeline entries with timeline data from DB -->
        <div class="timeline">
          <div class="timeline-entry">
            <h4>6/19/2025 - Send Invitation 
              <button class="file-btn" data-pdf="sample.pdf"></button> 
              <span>Josie Rosal</span>
            </h4>
            <p>An invitation has been sent...</p>
          </div>
          <div class="timeline-entry">
            <h4>6/13/2025 - Assessment <span>Josie Rosal</span></h4>
            <p>Upon inspection, the staff verified the complaintâ€™s validity...</p>
          </div>
        </div>
        <button class="resolved-btn" onclick="resolveComplaint()">Resolved</button>
      </div>
    </div>

    <!-- RECOMMENDED ACTION MODAL -->
    <div class="modal-overlay" id="recommendModal" style="display:none;">
      <div class="modal">
        <div class="modal-header">
          <h2>Recommended Action</h2>
        </div>
        <hr>

        <!-- Recommendation Description -->
        <!-- TODO BACKEND: Replace static description from backend -->
        <textarea style="margin-left: 0px;">Based on system analysis, we recommend the following action:</textarea>

        <div class="modal-footer">
          <button class="btn-save" onclick="proceedToAssign()">Assign</button>
          <button class="btn-save" onclick="proceedToAction()">Proceed</button>
        </div>
      </div>
    </div>

    <!-- ACTION MODAL -->
    <div class="modal-overlay" id="modal" style="display:none;">
      <div class="modal" style="display:flex; flex-direction:column; max-height:80vh;">
        <div class="modal-header">
          <h2>Action</h2>
          <div id="actionDatetime"><div id="actionDate"></div><div id="actionTime"></div></div>
        </div>
        <hr>

        <div class="modal-body" style="flex:1; overflow-y:auto; overflow-x:hidden; padding-right:10px; padding-left:0;">
          <label for="actionType">Type of Action:</label>
          <div class="type-action-row">
            <select id="actionType" name="actionType" aria-label="Type of Action">
              <option value="" disabled selected hidden>Select Action</option>
              <option value="Assessment">Assessment</option>
              <option value="Mediation">Mediation</option>
            </select>
          </div>

          <!-- FIELDS FOR ASSESSMENT -->
          <div class="action-fields" id="actionAssessmentFields" style="display:none;">
            <label>Assessment Notes:</label>
            <textarea id="assessmentNotes" required></textarea>
          </div>


          <!-- FIELDS FOR MEDIATION -->
          <div class="action-fields" id="actionMediationFields" style="display:none;">
            <!-- Advisors/Witnesses -->
            <div class="form-group">
              <label>Advisors / Witnesses:</label>
              <div id="witnessContainer">
                <div class="witness-row">
                  <input type="text" name="witness[]" placeholder="Enter name" required>
                </div>
              </div>
            </div>
            <div class="form-group">
              <button class="form-group-button" type="button" onclick="addWitness()">+ Add Witness</button>
            </div>

            <!-- Assigned Personnel -->
            <div class="form-group">
            <label>Assigned Personnel:</label>
            <input id="medAssignedPersonnel" type="text" name="medAssignedPersonnel" value="Josie Rosal" readonly>
            </div>
            <!-- Parties Involved  -->
            <div class="form-group">
              <label>Parties Involved:</label>
              <div id="medPartiesInvolved"></div>
            </div>

            <!-- Agenda -->
            <div class="form-group">
            <label>Agenda:</label>
            <input type="text" name="agenda" placeholder="Agenda">
            </div>

            
            <!-- Summary -->
            <div class="form-group">
            <label>Summary:</label>
            <textarea name="summary" placeholder="Enter mediation summary" required></textarea>
            </div>

            <!-- File uploads -->
            <div class="form-group">
              <label>Upload Files:</label>
              <div id="fileUploadContainer">
                <div class="fileUp-row">
                  <input type="text" name="fileDescription[]" placeholder="File type (e.g. Proof, Document)" required>
                  <input type="file" name="mediationFiles[]" class="file-input-small">
                </div>
              </div>
            </div>
            <div class="form-group">
              <button class="form-group-button" type="button" onclick="addFileUpload()">+ Add Another File</button>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-cancel" onclick="(function(){ closeComplaint(); recommendModal.style.display='flex'; })()">Cancel</button>
          <button id="modalSaveBtn" class="btn-save" onclick="saveAction()">Save</button>
        </div>
      </div>
    </div>

    <!-- ASSIGN MODAL -->
    <div class="modal-overlay" id="assignModal" style="display:none;"> 
      <div class="modal" style="display:flex; flex-direction:column; max-height:80vh;">
        <div class="modal-header">
          <h2>Assign</h2>
          <div id="assignDatetime"><div id="assignDate"></div><div id="assignTime"></div></div>
        </div>
        <hr>

        <!-- Scrollable body for assign modal -->
        <div class="modal-body" style="flex:1; overflow-y:auto; overflow-x:hidden; padding-right:10px; padding-left:0;">
          <label for="assignType">Type of Assignment:</label>
          <div class="type-action-row">
            <select id="assignType" name="assignType" aria-label="Type of Assignment">
              <option value="" disabled selected hidden>Select Assignment</option>
              <option value="Inspection">Inspection</option>
              <option value="Invitation">Invitation</option>
            </select>
          </div>

          <!-- FIELDS FOR INSPECTION -->
          <div class="action-fields" id="assignInspectionFields" style="display:none;">
            <!-- Assigned Personnel -->
            <div class="form-group">
              <label>Assigned Personnel:</label>
              <input id="assignedPersonnel" type="text" readonly>
            </div>
            <!-- Deadline -->
            <div class="form-group">
              <label>Deadline:</label>
              <input id="inspectionDeadline" type="date" required style="margin-left: 30x;">
            </div>
            <!-- Location of Inspection -->
            <div class="form-group">
              <label>Location of Inspection:</label>
              <input id="inspectionLocation" type="text" value="Alley 2 HOA" readonly>
            </div>
            <!-- Scope of Inspection (compact) -->
            <div class="form-group">
              <label>Scope of Inspection:</label>
                <div class="checkbox-group-compact">
                  <label class="checkbox-item-compact"><input type="checkbox" name="scope[]" value="safety"> Safety</label>
                  <label class="checkbox-item-compact"><input type="checkbox" name="scope[]" value="affected_lots"> Affected lot/s</label>
                  <label class="checkbox-item-compact"><input type="checkbox" name="scope[]" value="measurement"> Measurement of lot/s</label>
                  <label class="checkbox-item-compact"><input type="checkbox" name="scope[]" value="relation_owner"> Relation to the lot owner (if non-HOA)</label>
                </div>
            </div>
          </div>

         <!-- FIELDS FOR INVITATION -->
          <div class="action-fields" id="assignInvitationFields" style="display:none;">
            <!-- Assigned Personnel -->
            <div class="form-group">
              <label for="invAssignedPersonnel">Assigned Personnel:</label>
            <select id="invAssignedPersonnel" name="assigned_personnel" required>
              <option value="" disabled selected hidden>Select Personnel</option>
              <option value="Maybelen Jamorawon">Maybelen Jamorawon</option>
              <option value="Agnes Bartolome">Agnes Bartolome</option>
            </select>
            </div>
  

            <!-- To -->
            <div class="form-group">
              <label for="invTo">To:</label>
              <div id="invTo"></div>
            </div>

            <!-- Date of Meeting -->
            <div class="form-group">
              <label for="invDate">Date of Meeting:</label>
              <input id="invDate" type="date" name="meeting_date" required>
            </div>
            
            <!-- Time of Meeting -->
            <div class="form-group">
              <label for="invTime">Time of Meeting:</label>
              <input id="invTime" type="time" name="meeting_time" required>
            </div>
            
            <!-- Location -->
            <div class="form-group">
              <label for="invLocation">Location:</label>
              <input id="invLocation" type="text" name="location" value="Autofilled Location" readonly>
            </div>
            
            <!-- Agenda -->
            <div class="form-group">
              <label for="invAgenda">Agenda:</label>
              <input type="text" id="invAgenda" name="agenda" readonly>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-cancel" onclick="(function(){ closeComplaint(); recommendModal.style.display='flex'; })()">Cancel</button>
          <button id="assignSaveBtn" class="btn-save" onclick="saveAction()">Save</button> 
        </div>
      </div>
    </div>

    <!-- FILES MODAL -->
    <div id="filesModal" class="files-modal-overlay" style="display:none;">
      <div class="files-modal">
        <div class="files-header">
          <h2>Files</h2><div id="filesDateTime"></div>
        </div>
        <hr>

        <div class="file-tabs">
          <span class="tab active" data-tab="downloadable">Downloadable</span>
          <span class="tab" data-tab="uploaded">Upload File</span>
        </div>

        <div class="file-list downloadable-list"></div>

        <div class="file-list uploaded-list" style="display:none;">
          <div class="file-row">
            <span>Upload new file:</span>
            <!-- TODO BACKEND: Handle file uploads from userFileInput and store in server -->
            <input type="file" id="userFileInput" accept=".pdf,.jpeg,.jpg,.png" />
          </div>
          <div id="userFilesContainer"></div>
        </div>

        <div class="files-footer"><button class="close-btn" onclick="closeFiles()">Close</button></div>
      </div>
    </div>
  </main>

  <script>
  (function () {
    const modal = document.getElementById('modal');               // Action modal
    const assignModal = document.getElementById('assignModal');   // Assign modal
    const recommendModal = document.getElementById("recommendModal"); // Recommended modal

    let interval = null;

    // Read complaint ID from URL so saveAction can use it
    const urlParams = new URLSearchParams(window.location.search);
    const currentComplaintId = urlParams.get("id");
    console.log("currentComplaintId (from URL) =", currentComplaintId);
    let autofillCache = null;

    function tryParseJSONString(s) {
      if (!s || typeof s !== 'string') return s;
      try {
        let str = s;
        if ((str.startsWith('"') && str.endsWith('"')) || (str.startsWith("'") && str.endsWith("'"))) {
          str = str.slice(1, -1).replace(/\\"/g, '"').replace(/\\'/g, "'");
        }
        if (str.trim().startsWith('{') || str.trim().startsWith('[')) return JSON.parse(str);
      } catch (e) {}
      return s;
    }

    function loadAutofill() {
      if (!currentComplaintId) return Promise.resolve({});
      if (autofillCache) return Promise.resolve(autofillCache);
      return fetch(`/admin/complaints/api/action_autofill/${currentComplaintId}`, { credentials: 'same-origin' })
        .then(r => {
          if (!r.ok) {
            console.warn('Autofill fetch responded with', r.status);
            return {};
          }
          return r.json();
        })
        .then(data => { autofillCache = data || {}; return autofillCache; })
        .catch(err => { console.error('Error fetching autofill data:', err); return {}; });
    }

    function applyAutofillToAssign(data) {
      // Invitation fields
      const invToEl = document.getElementById("invTo");
      const invAgendaEl = document.getElementById("invAgenda");
      const invLocationEl = document.getElementById("invLocation");
      const invDateEl = document.getElementById("invDate");
      const invTimeEl = document.getElementById("invTime");
      if (invToEl) {
        invToEl.innerHTML = ""; // clear any existing fields
        const names = (data.to || "")
          .split(",")
          .map(s => s.trim())
          .filter(Boolean);

        names.forEach(name => {
          const input = document.createElement("input");
          input.type = "text";
          input.name = "to[]"; // match your form naming
          input.value = name;
          input.readOnly = true;
          input.classList.add("party-input"); // reuse same styling
          invToEl.appendChild(input);
        });
      }

      if (invAgendaEl) invAgendaEl.value = data.agenda || '';
      if (invLocationEl) invLocationEl.value = data.location || '2nd FLR. USAD-PHASELAD OFFICE, BARANGAY MAIN';

      // Inspection fields
      const assignedPersonnelEl = document.getElementById('assignedPersonnel');
      const inspectionLocationEl = document.getElementById('inspectionLocation');
      if (data.inspection_assigned_personnel && assignedPersonnelEl) assignedPersonnelEl.value = data.inspection_assigned_personnel; else if (assignedPersonnelEl) assignedPersonnelEl.value = '';

          let inspectionLoc = '';
          if (data.inspection_location_raw) {
            const parsed = tryParseJSONString(data.inspection_location_raw);
            if (Array.isArray(parsed) && parsed.length && parsed[0].block) inspectionLoc = `Block ${parsed[0].block}, Lot ${parsed[0].lot}`;
            else if (typeof parsed === 'object' && parsed.block) inspectionLoc = `Block ${parsed.block}, Lot ${parsed.lot}`;
            else if (typeof parsed === 'string') inspectionLoc = parsed;
          } else if (data.inspection_location) {
            const parsed = tryParseJSONString(data.inspection_location);
            if (Array.isArray(parsed) && parsed.length && parsed[0].block) inspectionLoc = `Block ${parsed[0].block}, Lot ${parsed[0].lot}`;
            else if (typeof parsed === 'object' && parsed.block) inspectionLoc = `Block ${parsed.block}, Lot ${parsed.lot}`;
            else if (typeof parsed === 'string') inspectionLoc = parsed;
          }
          if (!inspectionLoc && (data.block_no || data.lot_no)) inspectionLoc = `${data.address || ''}${data.address ? ', ' : ''}Block ${data.block_no || ''}, Lot ${data.lot_no || ''}`.trim();
      if (inspectionLocationEl) inspectionLocationEl.value = data.inspection_location_pretty || inspectionLoc || '';
        }

        function applyAutofillToAction(data) {
          // Mediation: only autofill the fields requested: agenda, assigned personnel, and parties involved
            const agendaInput = document.querySelector("input[name='agenda']");
            if (agendaInput && data.agenda) agendaInput.value = data.agenda;

            const medAssignedEl = document.getElementById('medAssignedPersonnel');
            if (medAssignedEl) medAssignedEl.value = data.med_assigned_personnel || medAssignedEl.value || 'Josie Rosal';

            const medPartiesEl = document.getElementById('medPartiesInvolved');
            if (medPartiesEl) {
              medPartiesEl.innerHTML = ''; // clear any existing fields
              const inviteNames = (data.to || '')
                .split(',')
                .map(s => s.trim())
                .filter(Boolean);

              inviteNames.forEach(name => {
                const input = document.createElement('input');
                input.type = 'text';
                input.name = 'parties_involved[]';
                input.value = name;
                input.readOnly = true;
                input.classList.add('party-input');
                medPartiesEl.appendChild(input);
            });
          }
        }

    // Update date & time inside whichever modal is open
    function updateComplaintDateTime(targetId) {
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-US', {
        weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'
      });
      const timeStr = now.toLocaleTimeString('en-US', {
        hour: '2-digit', minute: '2-digit', hour12: true
      });

      document.getElementById(targetId).innerHTML = `${dateStr}<br>${timeStr}`;
    }

    // Step 1: Open Recommended modal first
    function openComplaint() {
      recommendModal.style.display = "flex";
    }

    // Close Recommended modal
    function closeRecommend() {
      recommendModal.style.display = "none";
    }

    // Step 2 (a): From Recommended â†’ proceed to Action modal
    function proceedToAction() {
      recommendModal.style.display = "none";
      modal.style.display = 'flex';
      updateComplaintDateTime("actionDatetime");
      if (!interval) interval = setInterval(() => updateComplaintDateTime("actionDatetime"), 1000);
      document.getElementById("actionType").value = "";
      document.querySelectorAll("#modal .action-fields").forEach(div => div.style.display = "none");
      // Load autofill only when Action modal is opened
      loadAutofill().then(data => {
        try { applyAutofillToAction(data); } catch (e) { console.warn('applyAutofillToAction failed', e); }
      });
    }

    // Step 2 (b): From Recommended â†’ proceed to Assign modal
    function proceedToAssign() {
      recommendModal.style.display = "none";
      assignModal.style.display = 'flex';
      updateComplaintDateTime("assignDatetime");
      if (!interval) interval = setInterval(() => updateComplaintDateTime("assignDatetime"), 1000);
      document.getElementById("assignType").value = "";
      document.querySelectorAll("#assignModal .action-fields").forEach(div => div.style.display = "none");

      loadAutofill().then(data => { //assign modal load
        try { applyAutofillToAssign(data); } catch (e) { console.warn('applyAutofillToAssign failed', e); }

       
        const invSelect = document.getElementById('invAssignedPersonnel');
        if (invSelect) {
          // No network call â€” keep the select static and only preselect when autofill exactly matches an existing option.
          if (data.invitation_assigned_personnel) {
            const match = Array.from(invSelect.options).find(o => o.value === data.invitation_assigned_personnel);
            if (match) invSelect.value = data.invitation_assigned_personnel;
            // If no exact match, intentionally do nothing and keep the placeholder.
          }
        }
      });
    }

    // Close whichever modal is open
    function closeComplaint() {
      modal.style.display = 'none';
      assignModal.style.display = 'none';
      try {
        document.querySelectorAll('#modal input[type=text], #modal textarea').forEach(i => { if (!i.readOnly) i.value = ''; });
        document.querySelectorAll('#assignModal input[type=text], #assignModal textarea').forEach(i => { if (!i.readOnly) i.value = ''; });
        document.querySelectorAll('#modal input[type=date], #modal input[type=time], #assignModal input[type=date], #assignModal input[type=time]').forEach(i => i.value = '');
        document.querySelectorAll('#modal select, #assignModal select').forEach(sel => {
          try {
            const placeholder = sel.querySelector('option[disabled]');
            if (placeholder) {
              sel.value = '';
              sel.selectedIndex = 0;
            } else {
              sel.selectedIndex = -1;
            }
          } catch (e) {}
        });
        document.querySelectorAll('#modal input[type=checkbox], #assignModal input[type=checkbox]').forEach(cb => cb.checked = false);
        document.querySelectorAll('#modal input[type=file], #assignModal input[type=file]').forEach(f => { try { f.value = null; } catch(e){} });
        const witnessContainer = document.getElementById('witnessContainer');
        if (witnessContainer) {
          witnessContainer.innerHTML = `<div class="witness-row"><input type="text" name="witness[]" placeholder="Enter name"></div>`;
        }
        const fileUploadContainer = document.getElementById('fileUploadContainer');
        if (fileUploadContainer) {
          fileUploadContainer.innerHTML = `<div class="file-row"><input type="file" name="mediationFiles[]"><input type="text" name="fileDescription[]" placeholder="File type (e.g. Proof, Document)"></div>`;
        }
        const attachedFilesContainer = document.getElementById('attachedFilesContainer');
        if (attachedFilesContainer) attachedFilesContainer.innerHTML = '';
        // Hide action-specific panels
        document.querySelectorAll('#modal .action-fields').forEach(div => div.style.display = 'none');
        document.querySelectorAll('#assignModal .action-fields').forEach(div => div.style.display = 'none');
      } catch (e) {}
      if (interval) { clearInterval(interval); interval = null; }
    }

    // Action modal dropdown
    document.getElementById("actionType").addEventListener("change", function () {
      document.getElementById("actionAssessmentFields").style.display = "none";
      document.getElementById("actionMediationFields").style.display = "none";

      if (this.value === "Assessment") {
        document.getElementById("actionAssessmentFields").style.display = "block";
      } else if (this.value === "Mediation") {
        document.getElementById("actionMediationFields").style.display = "block";
      }
    });

    // Assign modal dropdown
    document.getElementById("assignType").addEventListener("change", function () {
      document.getElementById("assignInspectionFields").style.display = "none";
      document.getElementById("assignInvitationFields").style.display = "none";

      if (this.value === "Inspection") {
        document.getElementById("assignInspectionFields").style.display = "block";
      } else if (this.value === "Invitation") {
        document.getElementById("assignInvitationFields").style.display = "block";
        try {
          const invSelect = document.getElementById('invAssignedPersonnel');
          if (invSelect) {
            invSelect.style.position = 'relative';
            invSelect.style.zIndex = 10001;
          }
          // also bring the date/time inputs to front just in case
          const invDate = document.getElementById('invDate');
          const invTime = document.getElementById('invTime');
          if (invDate) { invDate.style.position = 'relative'; invDate.style.zIndex = 10001; }
          if (invTime) { invTime.style.position = 'relative'; invTime.style.zIndex = 10001; }
        } catch (e) {}
      }
    });

     // Add new witness row
    function addWitness() {
    const container = document.getElementById("witnessContainer");
    const div = document.createElement("div");
    div.classList.add("witness-row"); 
    div.innerHTML = `
      <input type="text" name="witness[]" placeholder="Enter witness/advisor name" required>
      <button type="button" class="remove-btn-wit" onclick="this.parentElement.remove()">
        <span class="material-icons">close</span>
      </button>
    `;

    container.appendChild(div);
    }

    // Add new file row
    function addFileUpload() {
      const container = document.getElementById("fileUploadContainer");
      const div = document.createElement("div");
      div.classList.add("fileUp-row");  
      div.innerHTML = `
        <input type="text" name="fileDescription[]" placeholder="File type (e.g. Proof, Document)" required>
        <input type="file" name="mediationFiles[]">
        <button type="button" class="remove-btn-wit" onclick="this.parentElement.remove()">
          <span class="material-icons">close</span>
        </button>      
      `;
      container.appendChild(div);
    }
 

    function saveAction() {
      const complaintId = (typeof currentComplaintId !== 'undefined') ? currentComplaintId : null;
      console.log('currentComplaintId =', complaintId);

      // Detect action type by checking which modal is currently open, then read its selector
      const assignModalEl = document.getElementById('assignModal');
      const actionModalEl = document.getElementById('modal');
      const assignType = document.querySelector("#assignType")?.value;
      const actionTypeSelect = document.querySelector("#actionType")?.value;
      let actionType = null;
      if (actionModalEl && actionModalEl.style.display === 'flex') {
        actionType = actionTypeSelect;
      } else if (assignModalEl && assignModalEl.style.display === 'flex') {
        actionType = assignType;
      } else {
        actionType = assignType || actionTypeSelect;
      }

      //require field
      const missing = [];
      if (actionType === 'Invitation') {
        const invSelect = document.getElementById('invAssignedPersonnel');
        const invDate = document.getElementById('invDate');
        const invTime = document.getElementById('invTime');
        if (invSelect && !invSelect.value) missing.push('Assigned Personnel');
        if (invDate && !invDate.value) missing.push('Meeting Date');
        if (invTime && !invTime.value) missing.push('Meeting Time');
      } else if (actionType === 'Inspection') {
        const assigned = document.getElementById('assignedPersonnel');
        const loc = document.getElementById('inspectionLocation');
        const deadline = document.getElementById('inspectionDeadline');
        const scopeCheckboxes = document.querySelectorAll("input[name='scope[]']");
        if (assigned && !assigned.value) missing.push('Inspector');
        if (loc && !loc.value) missing.push('Inspection Location');
        if (deadline && !deadline.value) missing.push('Deadline');
        const anyChecked = Array.from(scopeCheckboxes).some(cb => cb.checked);
        if (!anyChecked) missing.push('Scope (at least one option)');
      } else if (actionType === 'Mediation') {
        const agenda = document.querySelector("input[name='agenda']");
        const summary = document.querySelector("textarea[name='summary']");
        if (agenda && !agenda.value) missing.push('Agenda');
        if (summary && !summary.value) missing.push('Summary');
        const witnesses = Array.from(document.querySelectorAll("input[name='witness[]']")).map(i => i.value.trim()).filter(Boolean);
        if (witnesses.length === 0) missing.push('At least one Witness/Advisor');
        const uploads = Array.from(document.querySelectorAll("input[name='mediationFiles[]']")).map((f, idx) => ({ file: f.files && f.files.length ? f.files[0].name : '', desc: (document.querySelectorAll("input[name='fileDescription[]']")[idx] || {}).value || '' }));
        const validUploads = uploads.filter(u => u.file && u.desc.trim());
        if (validUploads.length === 0) missing.push('At least one uploaded file with description');
      } else if (actionType === 'Assessment') {
        const notes = document.getElementById('assessmentNotes');
        if (notes && !notes.value) missing.push('Assessment Notes'); }
      if (missing.length) {
        alert('Please fill required fields before saving: ' + missing.join(', '));
        return;
      }

      // Figure out assignedTo
      let assignedTo = "";
      if (actionType === "Inspection") {
          assignedTo = document.querySelector("#assignedPersonnel")?.value || "Unknown";
      } else if (actionType === "Invitation") {
          const invSelectEl = document.querySelector("#invAssignedPersonnel");
          if (invSelectEl) {
            const sel = invSelectEl.options[invSelectEl.selectedIndex];
            assignedTo = (sel && sel.id) ? sel.id : (invSelectEl.value || "Unknown");
          } else {
            assignedTo = "Unknown";
          }
      } else if (actionType === "Mediation") {
        // For mediation, assigned person is taken from the mediation assigned personnel field
        assignedTo = document.querySelector('#medAssignedPersonnel')?.value || 'Josie Rosal';
      } else if (actionType === "Assessment") {
        assignedTo = 'Josie Rosal';
      }

      let details = {};
      let description = "";

      if (actionType === "Mediation") {
        details = {
          advisors: Array.from(document.querySelectorAll("input[name='witness[]']")).map(w => w.value),
          agenda: document.querySelector("input[name='agenda']")?.value || "",
          summary: document.querySelector("textarea[name='summary']")?.value || "",
          assigned_personnel: document.querySelector('#medAssignedPersonnel')?.value || 'Josie Rosal',
          parties_involved: (document.querySelector('#medPartiesInvolved')?.value || '').split('\n').map(s => s.trim()).filter(Boolean),
          files: Array.from(document.querySelectorAll("input[name='mediationFiles[]']")).map((fileInput, idx) => {
            return {
              filename: fileInput.value.split("\\").pop(),
              type: document.querySelectorAll("input[name='fileDescription[]']")[idx]?.value || ""
            }
          })
        };
        description = details.summary;  // use summary as description
      } 
      else if (actionType === "Assessment") {
        details = {
          notes: document.querySelector("#assessmentNotes")?.value || ""
        };
        description = details.notes; // use notes as description
      } 
      else if (actionType === "Inspection") {
        details = {
          deadline: document.querySelector("#inspectionDeadline")?.value || "",
          inspector: document.querySelector("#assignedPersonnel")?.value || "",
          location: document.querySelector("#inspectionLocation")?.value || "",
          scope: Array.from(document.querySelectorAll("input[name='scope[]']:checked")).map(cb => cb.value)
        };
        description = "Inspection scheduled"; // generic description
      } 
      else if (actionType === "Invitation") {
        details = {
          to: document.querySelector("#invTo")?.value || "",
          meeting_date: document.querySelector("#invDate")?.value || "",
          meeting_time: document.querySelector("#invTime")?.value || "",
          location: document.querySelector("#invLocation")?.value || "",
          agenda: document.querySelector("#invAgenda")?.value || ""
        };
        description = "Invitation scheduled"; // generic description
      }

      const payload = {
        complaint_id: complaintId,
        action_type: actionType,
        assigned_to: assignedTo,
        action_datetime: new Date().toISOString().slice(0,19).replace("T"," "),
        description: description,
        ...details
      };

      console.log('payload to send:', payload);

      // Disable the save button to prevent double submissions
      const modalSaveBtn = document.getElementById('modalSaveBtn');
      const assignSaveBtn = document.getElementById('assignSaveBtn');
      if (modalSaveBtn) modalSaveBtn.disabled = true;
      if (assignSaveBtn) assignSaveBtn.disabled = true;

      fetch("/admin/complaints/api/action", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(res => {
        // Re-enable buttons
        if (modalSaveBtn) modalSaveBtn.disabled = false;
        if (assignSaveBtn) assignSaveBtn.disabled = false;

        if (res.success) {
          // Close any open modals, clear fields, and stop timers
          try { closeComplaint(); } catch (e) { /* fallback */ }
          try { document.getElementById('recommendModal').style.display = 'none'; } catch (e) {}
          if (interval) { clearInterval(interval); interval = null; }
          alert(`${actionType} saved successfully!`);
        } else {
          alert("Error: " + (res.error || res.message));
        }
      })
      .catch(err => {
        if (modalSaveBtn) modalSaveBtn.disabled = false;
        if (assignSaveBtn) assignSaveBtn.disabled = false;
        alert('Network or server error: ' + err);
      });
    }


    // Click outside closes modals
    modal.addEventListener('click', e => { if (e.target === modal) closeComplaint(); });
    recommendModal.addEventListener("click", e => { if (e.target === recommendModal) closeRecommend(); });

    // Expose globally so your buttons can call them
    window.openComplaint = openComplaint;
    window.closeComplaint = closeComplaint;
    window.proceedToAction = proceedToAction;
    window.proceedToAssign = proceedToAssign;
    window.closeRecommend = closeRecommend;
    window.updateComplaintDateTime = updateComplaintDateTime;
    window.addWitness = addWitness;
    window.addFileUpload = addFileUpload;
    window.saveAction = saveAction;
  })();

  /* Timeline: Open PDF */
  document.querySelectorAll('.file-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const pdfUrl = btn.getAttribute('data-pdf'); // replace with actual file paths
      if (pdfUrl) window.open(pdfUrl, '_blank');
      else alert("No PDF linked yet.");
    });
  });

  /* Files Modal */
  function openFiles() {
    const modal = document.getElementById("filesModal");
    modal.style.display = "flex";
    updateFilesDateTime();
  }
  function closeFiles() {
    document.getElementById("filesModal").style.display = "none";
  }
  function updateFilesDateTime() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', {
      weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'
    });
    const timeStr = now.toLocaleTimeString('en-US', {
      hour: '2-digit', minute: '2-digit', hour12: true
    });
    document.getElementById("filesDateTime").innerHTML = `${dateStr}<br>${timeStr}`;
  }
  document.getElementById("filesModal").addEventListener("click", e => {
    if (e.target.id === "filesModal") closeFiles();
  });

  /* Switch tabs */
  document.querySelectorAll('.file-tabs .tab').forEach(tab => {
    tab.addEventListener('click', function () {
      document.querySelectorAll('.file-tabs .tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      const target = this.getAttribute('data-tab');
      document.querySelector('.uploaded-list').style.display = target === "uploaded" ? "block" : "none";
      document.querySelector('.downloadable-list').style.display = target === "downloadable" ? "block" : "none";
    });
  });

  /* User file uploads */
  document.getElementById("userFileInput").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);

      // Create a file row in the Downloadable list
      const fileRow = document.createElement("div");
      fileRow.className = "file-row";

      fileRow.innerHTML = `
        <span class="file-name">${file.name}</span>
        <div class="file-actions">
          <a href="${url}" download="${file.name}" class="download-btn">Download â¬‡</a>
          <button class="attach-btn">Attach ðŸ“Ž</button>
        </div>
      `;

      // Attach button functionality
      fileRow.querySelector(".attach-btn").addEventListener("click", () => {
        attachFileToAction(file.name, url);
      });

      document.querySelector(".downloadable-list").appendChild(fileRow);

      // Auto-switch to downloadable tab
      document.querySelector('.file-tabs .tab[data-tab="downloadable"]').click();
    }
  });

  /* Attach file to Action modal */
  function attachFileToAction(fileName, fileUrl) {
    const container = document.getElementById("attachedFilesContainer");
    if (!container) return;

    // Prevent duplicates
    const alreadyAttached = [...container.querySelectorAll(".attached-file")]
      .some(f => f.textContent === fileName);
    if (alreadyAttached) return;

    const fileTag = document.createElement("div");
    fileTag.className = "attached-file";
    fileTag.textContent = fileName;

    // Store metadata so you can save later
    fileTag.dataset.url = fileUrl;

    container.appendChild(fileTag);
  }

  /* Sending actions is handled by saveAction() / saveMediationAction() above.
     Removed duplicate event listener that used incorrect selectors/endpoints. */

  // Resolve complaint function
  async function resolveComplaint() {
    if (!confirm('Are you sure you want to mark this complaint as resolved?')) {
      return;
    }

    try {
      const urlParams = new URLSearchParams(window.location.search);
      const complaintId = urlParams.get('id');
      
      if (!complaintId) {
        alert('Complaint ID not found');
        return;
      }

      const response = await fetch(`/admin/complaints/api/${complaintId}/resolve`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();
      
      if (data.success) {
        alert('Complaint resolved successfully!');
        // Redirect to resolved complaints tab
        window.location.href = '/admin/complaints/resolved.html';
      } else {
        alert('Error: ' + (data.message || 'Failed to resolve complaint'));
      }
    } catch (error) {
      console.error('Error resolving complaint:', error);
      alert('Error resolving complaint. Please try again.');
    }
  }
  </script>
</body>
</html>